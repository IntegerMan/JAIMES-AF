# AI Agents Layer Guidelines

## Purpose
This project contains AI agent services that interact with Azure OpenAI and Microsoft Agents AI framework. It handles chat processing and initial message generation.

## Key Principles
- **Agent Framework**: Uses Microsoft Agents AI framework (`Microsoft.Agents.AI`)
- **Azure OpenAI**: Connects to Azure OpenAI using `AzureOpenAIClient`
- **Thread Management**: Maintains conversation threads using `AgentThread` and serializes to JSON
- **Chat History**: Persists thread state via `IChatHistoryService`

## Service Structure
- `ChatService` implements `IChatService` from `JAIMES AF.ServiceDefinitions`
- Uses `ChatOptions` for configuration (endpoint, API key, deployment)
- Creates `AIAgent` instances with system prompts from game scenarios
- `RulesSearchService` implements `IRulesSearchService` and provides RAG search over rulesets using Kernel Memory

## Thread Management
- Threads are serialized to JSON and stored in `ChatHistory` entities
- Thread state is retrieved from database before processing messages
- Thread state is saved after processing messages
- Use `JsonSerializerOptions.Web` for serialization/deserialization

## Agent Creation
- Agents are created per request with the game's `SystemPrompt`
- Use `CreateAgent()` helper method to build agents consistently
- Configure OpenTelemetry for observability

## Error Handling
- Log thread state before and after chat operations for diagnostics
- Handle serialization/deserialization errors gracefully
- Let Azure OpenAI exceptions bubble up

## Common Patterns
```csharp
private AIAgent CreateAgent(string systemPrompt)
{
    return new AzureOpenAIClient(
            new Uri(_options.Endpoint),
            new ApiKeyCredential(_options.ApiKey))
        .GetChatClient(_options.Deployment)
        .CreateAIAgent(instructions: systemPrompt)
        .AsBuilder()
        .UseOpenTelemetry(sourceName: "agent-framework-source")
        .Build();
}

// Thread retrieval
string? existingThreadJson = await chatHistoryService.GetMostRecentThreadJsonAsync(gameId, cancellationToken);
AgentThread? thread = null;
if (!string.IsNullOrEmpty(existingThreadJson))
{
    JsonElement jsonElement = JsonSerializer.Deserialize<JsonElement>(existingThreadJson, JsonSerializerOptions.Web);
    thread = agent.DeserializeThread(jsonElement, JsonSerializerOptions.Web);
}
thread ??= agent.GetNewThread();

// Thread persistence
string json = thread.Serialize(JsonSerializerOptions.Web).GetRawText();
await chatHistoryService.SaveThreadJsonAsync(gameId, json, cancellationToken);
```

## Logging
- Log thread JSON before and after operations for debugging
- Use structured logging with appropriate log levels
- Include game IDs and relevant context in log messages

## Kernel Memory and Rules Search

### Overview
Kernel Memory is used for RAG (Retrieval-Augmented Generation) search over rulesets. Rules are stored in a SQLite vector database, not in EF entities.

### Key Components
- **RulesSearchService**: Service that provides rules indexing and search functionality
- **RulesSearchTool**: Tool registered with AI agents to allow natural language queries over rules
- **Storage**: Rules are stored in Kernel Memory's SQLite vector database (`km_vector_store.db`)
- **Indexing**: Rules are indexed by `rulesetId` which is used as an index/filter

### Configuration
```csharp
// Kernel Memory is configured with Azure OpenAI and SQLite vector store
OpenAIConfig openAiConfig = new()
{
    APIKey = chatOptions.ApiKey,
    Endpoint = chatOptions.Endpoint,
    TextModel = chatOptions.Deployment,
    EmbeddingModel = chatOptions.Deployment
};

string vectorDbConnectionString = "Data Source=km_vector_store.db";

_memory = new KernelMemoryBuilder()
    .WithOpenAI(openAiConfig)
    .WithSimpleVectorDb(vectorDbConnectionString)
    .Build();
```

### Indexing Rules
```csharp
// Rules are indexed using ImportTextAsync with rulesetId as a tag/index
await _memory.ImportTextAsync(
    text: fullContent,
    documentId: documentId,
    index: GetIndexName(rulesetId),
    tags: new TagCollection { { "rulesetId", rulesetId } },
    cancellationToken: cancellationToken);
```

### Searching Rules
```csharp
// Rules are searched using AskAsync, filtered by rulesetId
MemoryAnswer answer = await _memory.AskAsync(
    question: query,
    index: GetIndexName(rulesetId),
    filters: new List<MemoryFilter> { new MemoryFilter().ByTag("rulesetId", rulesetId) },
    cancellationToken: cancellationToken);
```

### Important Notes
- **No EF Entities**: Rules are NOT stored in EF entities - they exist only in the vector database
- **RulesetId as Index**: The `rulesetId` parameter is used purely as an index/filter for organizing rules
- **Tool Registration**: `RulesSearchTool` is automatically registered in `ChatService.CreateAgent()` when a game context is available
- **References**: 
  - Blog post: https://blog.leadingedje.com/post/ai/documents/kernelmemory.html
  - Package: `Microsoft.KernelMemory.Core` (uses `WithSimpleVectorDb()` for SQLite)

