@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MattEland.Jaimes.Web.Components.Chat
@using MattEland.Jaimes.Web.Components.Shared
@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDataGrid Items="_messages" Filterable="true" Groupable="true" Loading="_isLoading" GroupExpanded="true">
    <Columns>
        <PropertyColumn Property="x => x.GameId" Title="Game" Grouping="true">
            <CellTemplate>
                <MudLink Href="@($"/games/{context.Item.GameId}")">
                    @(context.Item.GameTitle ?? "Game Details")
                </MudLink>
            </CellTemplate>
            <GroupTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">
                        <MudLink Href="@($"/games/{context.Grouping.Key}")">
                            @(context.Grouping.FirstOrDefault()?.GameTitle ?? "Game Details")
                        </MudLink>
                    </MudText>
                    <MudChip Size="Size.Small" Color="Color.Primary">@context.Grouping.Count() Messages</MudChip>
                </MudStack>
            </GroupTemplate>
        </PropertyColumn>

        <TemplateColumn Title="Agent" Sortable="true">
            <CellTemplate>
                @if (!string.IsNullOrEmpty(context.Item.AgentId))
                {
                    <AgentLink AgentId="@context.Item.AgentId"
                        AgentName="@(context.Item.AgentName ?? context.Item.AgentId)" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="text-muted">None</MudText>
                }
            </CellTemplate>
        </TemplateColumn>

        <TemplateColumn Title="Version" Sortable="true">
            <CellTemplate>
                @if (context.Item.InstructionVersionId > 0)
                {
                    <MattEland.Jaimes.Web.Components.Shared.AgentVersionLink AgentId="@context.Item.AgentId"
                        VersionId="@context.Item.InstructionVersionId"
                        VersionNumber="@(context.Item.InstructionVersionNumber ?? $"v{context.Item.InstructionVersionId}")" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="text-muted">-</MudText>
                }
            </CellTemplate>
        </TemplateColumn>

        <PropertyColumn Property="x => x.CreatedAt" Title="Time" Sortable="true" Format="yyyy-MM-dd HH:mm:ss" />

        <TemplateColumn Title="Sender" Sortable="true">
            <CellTemplate>
                @if (context.Item.PlayerId != null)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Person">
                        @context.Item.ParticipantName
                    </MudChip>
                }
                else
                {
                    <MattEland.Jaimes.Web.Components.Shared.AgentVersionLink AgentId="@context.Item.AgentId"
                        VersionId="@context.Item.InstructionVersionId"
                        VersionNumber="@(context.Item.AgentName ?? context.Item.ParticipantName)" />
                }
            </CellTemplate>
        </TemplateColumn>

        <TemplateColumn Title="Message">
            <CellTemplate>
                <MudText Typo="Typo.body2">
                    @(context.Item.Text.Length > 100 ? context.Item.Text.Substring(0, 100) + "..." : context.Item.Text)
                </MudText>
            </CellTemplate>
        </TemplateColumn>

        <TemplateColumn Title="Status">
            <CellTemplate>
                <MessageIndicators Feedback="@context.Item.Feedback" Metrics="@context.Item.Metrics"
                    ToolCallCount="@(context.Item.ToolCalls?.Count ?? 0)" ToolCalls="@context.Item.ToolCalls"
                    ReadOnly="true" ShowFeedbackButtons="false" MessageId="@context.Item.Id"
                    ExemptFromProcessing="false" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="MessageContextDto" />
    </PagerContent>
</MudDataGrid>

@code {
    [Parameter] public string? AgentId { get; set; }
    [Parameter] public int? VersionId { get; set; }

    private List<MessageContextDto> _messages = new();
    private bool _isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        await LoadMessagesAsync();
    }

    private async Task LoadMessagesAsync()
    {
        _isLoading = true;
        try
        {
            string url = "/admin/messages";
            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(AgentId))
            {
                queryParams.Add($"agentId={AgentId}");
            }
            if (VersionId.HasValue)
            {
                queryParams.Add($"versionId={VersionId}");
            }

            if (queryParams.Any())
            {
                url += "?" + string.Join("&", queryParams);
            }

            var result = await Http.GetFromJsonAsync<List<MessageContextDto>>(url);
            if (result != null)
            {
                _messages = result;
            }
        }
        catch (Exception ex)
        {
            LoggerFactory.CreateLogger("AgentMessagesList").LogError(ex, "Failed to load messages");
        }
        finally
        {
            _isLoading = false;
        }
    }

    // Insights generation state
    private bool _isGeneratingInsights;

    /// <summary>
    /// Generates AI insights and shows them in a dialog.
    /// </summary>
    public async Task GenerateInsightsAsync()
    {
        if (string.IsNullOrEmpty(AgentId))
            return;

        _isGeneratingInsights = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new GenerateInsightsRequest { InsightType = "messages" };

            // We still need a version ID for insights generation as it's typically tied to a version
            int versionToUse = VersionId ?? 0; // Defaulting to 0 might fail, but we usually want a version context for insights

            var response = await client.PostAsJsonAsync(
            $"/agents/{AgentId}/instruction-versions/{versionToUse}/generate-insights",
            request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GenerateInsightsResponse>();
                if (result?.Success == true)
                {
                    // Show dialog with markdown content
                    var parameters = new DialogParameters<InsightsDialog>
{
{ x => x.Title, "Message Insights" },
{ x => x.Content, result.Insights ?? "No insights available." },
{ x => x.ItemCount, result.ItemsAnalyzed }
};
                    await DialogService.ShowAsync<InsightsDialog>("AI Insights", parameters);
                }
                else
                {
                    Snackbar.Add(result?.Error ?? "Failed to generate insights", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Failed to generate insights", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGeneratingInsights = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Returns true if insights generation is in progress.
    /// </summary>
    public bool IsGeneratingInsights => _isGeneratingInsights;
}
