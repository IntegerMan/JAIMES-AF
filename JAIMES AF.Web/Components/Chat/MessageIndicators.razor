@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Pages
@using MudBlazor

@inject NavigationManager NavigationManager

@* Reusable component for displaying message feedback and tool call indicators *@

<div class="d-flex align-items-center gap-2">
    @if (Metrics != null && Metrics.Count > 0)
    {
        @if (IsProcessing && ExpectedMetricCount.GetValueOrDefault() > 0)
        {
            @* Show progress ring while evaluating *@
            <div @onclick="OnMetricsClicked" @onclick:stopPropagation="true" style="cursor: pointer;">
                <EvaluationProgressRing 
                    TotalSegments="@ExpectedMetricCount.GetValueOrDefault()"
                    Metrics="Metrics"
                    ErrorsByMetric="ErrorsByMetric"
                    IsProcessing="true"
                    Size="20"
                    OnSliceClick="HandleSliceClick"/>
            </div>
        }
        else
        {
            @* Show completed progress ring or pie chart icon *@
            <div @onclick="OnMetricsClicked" @onclick:stopPropagation="true" style="cursor: pointer;">
                <EvaluationProgressRing 
                    TotalSegments="@(ExpectedMetricCount.GetValueOrDefault() > 0 ? ExpectedMetricCount.GetValueOrDefault() : Metrics.Count)"
                    Metrics="Metrics"
                    ErrorsByMetric="ErrorsByMetric"
                    IsProcessing="false"
                    Size="20"
                    OnSliceClick="HandleSliceClick"/>
            </div>
        }
    }
    else if (IsProcessing && ExpectedMetricCount.GetValueOrDefault() > 0)
    {
        @* Show empty progress ring while waiting for first metric *@
        <MudTooltip Placement="Placement.Top">
            <TooltipContent>
                <div class="d-flex flex-column gap-1 pa-1">
                    <MudText Typo="Typo.subtitle2">Evaluation Results</MudText>
                    <div class="d-flex align-items-center gap-2">
                        <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Color="Color.Info" Style="width: 16px; height: 16px;"/>
                        <MudText Typo="Typo.caption" Color="Color.Info">@ExpectedMetricCount.GetValueOrDefault() metrics pending...</MudText>
                    </div>
                </div>
            </TooltipContent>
            <ChildContent>
                <div style="cursor: default;">
                    <EvaluationProgressRing 
                        TotalSegments="@ExpectedMetricCount.GetValueOrDefault()"
                        Metrics="@(new List<MessageEvaluationMetricResponse>())"
                        IsProcessing="true"
                        Size="20"/>
                </div>
            </ChildContent>
        </MudTooltip>
    }
    else if (IsProcessing)
    {
        <MudTooltip Text="Analysing Metrics..." Placement="Placement.Top">
            <div class="d-flex align-center justify-center" style="width:32px; height:32px;">
                <MudIcon Icon="@Icons.Material.Filled.HourglassBottom"
                         Color="Color.Default"
                         Size="MudBlazor.Size.Small"
                         Class="spin-icon"/>
            </div>
        </MudTooltip>
    }

    @if (ToolCallCount > 0)
    {
        <MudTooltip Placement="Placement.Top">
            <TooltipContent>
                @if (ToolCalls != null && ToolCalls.Count > 0)
                {
                    <div class="d-flex flex-column gap-1">
                        <MudText Typo="Typo.caption">
                            <b>Tool Calls (@ToolCallCount):</b>
                        </MudText>
                        @foreach (var tool in ToolCalls)
                        {
                            <MudText Typo="Typo.caption">â€¢ @tool.ToolName</MudText>
                        }
                    </div>
                }
                else
                {
                    <MudText Typo="Typo.caption">@($"{ToolCallCount} tool call(s)")</MudText>
                }
            </TooltipContent>
            <ChildContent>
                <MudIconButton Icon="@Icons.Material.Filled.Build"
                               Color="Color.Default"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               Class="tool-call-button"
                               Disabled="@(!ReadOnly && OnToolCallsClick.HasDelegate == false)"
                               OnClick="OnToolCallsClicked"/>
            </ChildContent>
        </MudTooltip>
    }

    @if (Feedback != null)
    {
        <MudTooltip Text="@(string.IsNullOrWhiteSpace(Feedback.Comment) ? $"{(Feedback.IsPositive ? "Helpful" : "Unhelpful")} feedback" : Feedback.Comment)" Placement="Placement.Top">
            <MudIconButton Icon="@(Feedback.IsPositive ? Icons.Material.Filled.ThumbUp : Icons.Material.Filled.ThumbDown)"
                           Color="@(Feedback.IsPositive ? Color.Success : Color.Error)"
                           Size="Size.Small"
                           Variant="Variant.Text"
                           Class="feedback-icon-existing"
                           OnClick="OnFeedbackIconClicked"
                           Disabled="@(!ReadOnly && OnFeedbackClick.HasDelegate == false)"/>
            @* In non-read-only (chat), clicking existing feedback usually does nothing or edits. 
                              In read-only context, we want it to navigate. *@
        </MudTooltip>
    }
    else if (ShowFeedbackButtons && !ReadOnly && !ExemptFromProcessing)
    {
        <div class="d-flex align-items-center gap-1">
            <MudTooltip Text="Mark as helpful" Placement="Placement.Top">
                <MudIconButton Icon="@Icons.Material.Filled.ThumbUp"
                               Color="@(_isHoveringThumbUp ? Color.Success : Color.Default)"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               Class="feedback-button"
                               Disabled="@ReadOnly"
                               @onmouseenter="() => _isHoveringThumbUp = true"
                               @onmouseleave="() => _isHoveringThumbUp = false"
                               OnClick="@(() => OnFeedbackButtonClicked(true))"/>
            </MudTooltip>
            <MudTooltip Text="Mark as unhelpful" Placement="Placement.Top">
                <MudIconButton Icon="@Icons.Material.Filled.ThumbDown"
                               Color="@(_isHoveringThumbDown ? Color.Error : Color.Default)"
                               Size="Size.Small"
                               Variant="Variant.Text"
                               Class="feedback-button"
                               Disabled="@ReadOnly"
                               @onmouseenter="() => _isHoveringThumbDown = true"
                               @onmouseleave="() => _isHoveringThumbDown = false"
                               OnClick="@(() => OnFeedbackButtonClicked(false))"/>
            </MudTooltip>
        </div>
    }
</div>

@code {
    private bool _isHoveringThumbUp;
    private bool _isHoveringThumbDown;

    /// <summary>
    /// If true, means the message is still being processed/analyzed.
    /// Default is false.
    /// </summary>
    [Parameter]
    public bool IsProcessing { get; set; }

    /// <summary>
    /// The evaluation metrics for this message
    /// </summary>
    [Parameter]
    public List<MessageEvaluationMetricResponse>? Metrics { get; set; }

    /// <summary>
    /// The expected number of evaluation metrics for progress display.
    /// </summary>
    [Parameter]
    public int? ExpectedMetricCount { get; set; }

    /// <summary>
    /// Dictionary of error messages by metric name for failed evaluations.
    /// </summary>
    [Parameter]
    public Dictionary<string, string>? ErrorsByMetric { get; set; }

    /// <summary>
    /// Whether any metrics have errors.
    /// </summary>
    private bool HasErrors => ErrorsByMetric?.Any() ?? false;

    /// <summary>
    /// The feedback for this message, if any.
    /// </summary>
    [Parameter]
    public MessageFeedbackResponse? Feedback { get; set; }

    /// <summary>
    /// Number of tool calls associated with this message.
    /// </summary>
    [Parameter]
    public int ToolCallCount { get; set; }

    /// <summary>
    /// The list of tool calls.
    /// </summary>
    [Parameter]
    public List<MessageToolCallResponse>? ToolCalls { get; set; }

    /// <summary>
    /// Whether to show in read-only mode (navigation instead of action).
    /// </summary>
    [Parameter]
    public bool ReadOnly { get; set; } = true;

    /// <summary>
    /// Whether to show feedback buttons when no feedback exists.
    /// Only applies when ReadOnly is false.
    /// </summary>
    [Parameter]
    public bool ShowFeedbackButtons { get; set; }

    /// <summary>
    /// If true, spinner will not be shown even if metrics are missing.
    /// </summary>
    [Parameter]
    public bool ExemptFromProcessing { get; set; }

    /// <summary>
    /// The message ID for event callbacks and navigation.
    /// </summary>
    [Parameter]
    public int? MessageId { get; set; }

    /// <summary>
    /// True if the message is missing some evaluators.
    /// </summary>
    [Parameter]
    public bool HasMissingEvaluators { get; set; }

    /// <summary>
    /// Event callback when tool calls icon is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnToolCallsClick { get; set; }

    /// <summary>
    /// Event callback when feedback button is clicked. Passes (MessageId, IsPositive).
    /// </summary>
    [Parameter]
    public EventCallback<(int MessageId, bool IsPositive)> OnFeedbackClick { get; set; }

    /// <summary>
    /// Event callback when metrics icon is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnMetricsClick { get; set; }

    private async Task OnToolCallsClicked()
    {
        if (!MessageId.HasValue) return;

        if (ReadOnly)
        {
            if (ToolCalls != null && ToolCalls.Any())
            {
                // Navigate to the first tool call detail
                NavigationManager.NavigateTo($"/admin/tool-calls/{ToolCalls.First().Id}");
            }
            // else: maybe navigate to tool list filtered by message? For now just tool-calls/{Id} is the main request
        }
        else
        {
            await OnToolCallsClick.InvokeAsync(MessageId.Value);
        }
    }

    private async Task OnFeedbackButtonClicked(bool isPositive)
    {
        if (MessageId.HasValue)
        {
            await OnFeedbackClick.InvokeAsync((MessageId.Value, isPositive));
        }
    }

    private void OnFeedbackIconClicked()
    {
        if (ReadOnly && Feedback != null)
        {
            NavigationManager.NavigateTo($"/admin/feedback/{Feedback.Id}");
        }
    }

    private async Task OnMetricsClicked()
    {
        if (!MessageId.HasValue) return;

        if (ReadOnly)
        {
            NavigationManager.NavigateTo($"/admin/metrics/{MessageId}");
        }
        else
        {
            await OnMetricsClick.InvokeAsync(MessageId.Value);
        }
    }

    private void HandleSliceClick(MessageEvaluationMetricResponse metric)
    {
        // Navigate to the message metrics page for this message
        if (MessageId.HasValue)
        {
            NavigationManager.NavigateTo($"/admin/metrics/{MessageId}");
        }
        else if (metric.Id > 0)
        {
            // Fallback for when MessageId is not available for some reason
            NavigationManager.NavigateTo($"/admin/evaluations/{metric.Id}");
        }
    }
}
