@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Chat
@using MattEland.Jaimes.Web.Components.Helpers
@using MudBlazor
@inject HttpClient Http

<div class="read-only-conversation" style="max-height: 80vh; overflow-y: auto; padding-right: 8px;">
    @if (_isLoading)
    {
        <div class="d-flex justify-center my-4">
            <MudProgressCircular Indeterminate="true"/>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else if (_messages != null)
    {
        @foreach ((var m, int msgIndex) in _messages.Select((msg, i) => (msg, i)))
        {
            List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
            @foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
            {
                bool isFirstParagraph = index == 0;
                bool isLastParagraph = index == paragraphs.Count - 1;
                bool isTargetMessage = m.Id == MessageId;

                bool isVersionSwitch = false;
                if (m.PlayerId == null) // Assistant message
                {
                    // Check previous assistant message for version switch
                    var prevAssistantMsg = _messages
                        .Take(msgIndex) // Take messages before this one
                        .Reverse() // Search backwards
                        .FirstOrDefault(msg => msg.PlayerId == null); // Find last assistant message

                    if (prevAssistantMsg != null)
                    {
                        if (prevAssistantMsg.AgentId != m.AgentId ||
                            prevAssistantMsg.InstructionVersionId != m.InstructionVersionId)
                        {
                            isVersionSwitch = true;
                        }
                    }
                    else
                    {
                        // No previous assistant message, so this is the first one
                        isVersionSwitch = true;
                    }
                }

                @if (m.PlayerId != null) // User message
                {
                    <UserChatMessage
                        Text="@paragraph"
                        IsFirstParagraph="@isFirstParagraph"
                        IsLastParagraph="@isLastParagraph"
                        MessageId="@m.Id"
                        Sentiment="@m.Sentiment"
                        Confidence="@m.SentimentConfidence"
                        SentimentSource="@m.SentimentSource"
                        SentimentId="@m.SentimentId"
                        ReadOnly="true"
                        NavigateOnClick="true"
                        Highlighted="@isTargetMessage"/>
                }
                else // Assistant message
                {
                    <AssistantChatMessage
                        Text="@paragraph"
                        MessageId="@m.Id"
                        IsFirstParagraph="@isFirstParagraph"
                        IsLastParagraph="@isLastParagraph"
                        ReadOnly="true"
                        Metrics="@m.Metrics"
                        Feedback="@m.Feedback"
                        ToolCalls="@m.ToolCalls"
                        Highlighted="@isTargetMessage"
                        AgentId="@m.AgentId"
                        AgentName="@m.AgentName"
                        InstructionVersionId="@m.InstructionVersionId"
                        VersionNumber="@(m.InstructionVersionId.ToString())"
                        IsVersionSwitch="@isVersionSwitch"
                        IsScriptedMessage="@m.IsScriptedMessage"/>
                }
            }
        }
    }
    else
    {
        <MudText Typo="Typo.body2" Class="text-muted">No context messages available.</MudText>
    }
</div>

@code {
    [Parameter] public int MessageId { get; set; }
    [Parameter] public int ContextCount { get; set; } = 5;
    [Parameter] public int ContextCountAfter { get; set; } = 0;

    private IEnumerable<MessageContextDto>? _messages;
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnParametersSetAsync()
    {
        await LoadContextAsync();
    }

    private async Task LoadContextAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _messages = await Http.GetFromJsonAsync<IEnumerable<MessageContextDto>>($"/messages/{MessageId}/context?count={ContextCount}&countAfter={ContextCountAfter}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load context: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

}
