@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Pages
@using MudBlazor

@if (!string.IsNullOrWhiteSpace(Text))
{
    <ChatBubble Position="ChatBubblePosition.Start"
                Variant="Variant.Filled"
                Color="@(Highlighted ? Color.Info : Color)">
        @if (IsFirstParagraph)
        {
            <ChatHeader Name="Game Master"/>
        }
        <div class="@GetContentClasses()">
            @((MarkupString) ChatHelpers.RenderMarkdown(Text))
        </div>
        @if (IsLastParagraph && !IsStreaming)
        {
            <ChatFooter Class="feedback-footer">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    @if (!string.IsNullOrEmpty(AgentId) && !IsScriptedMessage)
                    {
                        <MudTooltip Text="@($"{AgentName} {VersionNumber}")" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Filled.SmartToy"
                                           Size="Size.Small"
                                           Color="@(IsVersionSwitch ? Color.Primary : Color.Default)"
                                           Href="@($"/agents/{AgentId}/versions/{InstructionVersionId}")"/>
                        </MudTooltip>
                    }
                    @if (IsScriptedMessage)
                    {
                        <MudTooltip Text="This is a scripted message">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Default"/>
                        </MudTooltip>
                    }
                    <MessageIndicators
                        Feedback="@Feedback"
                        Metrics="@Metrics"
                        ToolCallCount="@(ToolCalls?.Count ?? 0)"
                        ToolCalls="@ToolCalls"
                        ReadOnly="@ReadOnly"
                        ShowFeedbackButtons="true"
                        MessageId="@MessageId"
                        OnToolCallsClick="OnToolCallsClick"
                        OnFeedbackClick="OnFeedbackClick"
                        OnMetricsClick="OnMetricsClick"
                        HasMissingEvaluators="@HasMissingEvaluators"
                        ExemptFromProcessing="@ExemptFromProcessing"
                        IsProcessing="@IsProcessing"
                        ExpectedMetricCount="@ExpectedMetricCount"
                        ErrorsByMetric="@ErrorsByMetric"/>
                </MudStack>
            </ChatFooter>
        }
    </ChatBubble>
}

@code {
    [Parameter] public required string Text { get; set; }

    [Parameter] public Color Color { get; set; } = Color.Default;

    [Parameter] public bool Highlighted { get; set; }

    [Parameter] public int? MessageId { get; set; }

    [Parameter] public bool IsFirstParagraph { get; set; }

    [Parameter] public bool IsLastParagraph { get; set; }

    [Parameter] public bool ReadOnly { get; set; }

    [Parameter] public List<MessageToolCallResponse>? ToolCalls { get; set; }

    [Parameter] public List<MessageEvaluationMetricResponse>? Metrics { get; set; }

    [Parameter] public MessageFeedbackResponse? Feedback { get; set; }

    [Parameter] public EventCallback<int> OnToolCallsClick { get; set; }

    [Parameter] public EventCallback<(int MessageId, bool IsPositive)> OnFeedbackClick { get; set; }

    [Parameter] public EventCallback<int> OnMetricsClick { get; set; }

    [Parameter] public string? AgentId { get; set; }
    [Parameter] public string? AgentName { get; set; }
    [Parameter] public int? InstructionVersionId { get; set; }
    [Parameter] public string? VersionNumber { get; set; }
    [Parameter] public bool IsVersionSwitch { get; set; }
    [Parameter] public bool ExemptFromProcessing { get; set; }
    [Parameter] public bool IsScriptedMessage { get; set; }
    [Parameter] public bool HasMissingEvaluators { get; set; }
    [Parameter] public bool IsProcessing { get; set; }
    [Parameter] public bool IsStreaming { get; set; }
    [Parameter] public int? ExpectedMetricCount { get; set; }
    [Parameter] public Dictionary<string, string>? ErrorsByMetric { get; set; }

    private string GetContentClasses()
    {
        var classes = "chat-bubble-content";
        if (IsFirstParagraph)
        {
            classes += " has-pointer";
        }
        return classes;
    }
}
