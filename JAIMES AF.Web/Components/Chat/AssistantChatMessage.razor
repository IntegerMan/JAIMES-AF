@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Pages
@using MudBlazor

@if (!string.IsNullOrWhiteSpace(Text))
{
    <MudChat ChatPosition="ChatBubblePosition.Start"
             Variant="Variant.Filled"
             Color="@(Highlighted ? Color.Info : Color)"
             @onmouseenter="OnMouseEnter"
             @onmouseleave="OnMouseLeave">
        @if (IsFirstParagraph)
        {
            <MudChatHeader Name="Game Master"/>
        }
        <MudChatBubble>
            @((MarkupString)ChatHelpers.RenderMarkdown(Text))
        </MudChatBubble>
        @if (IsLastParagraph && MessageId.HasValue)
        {
            <MudChatFooter Class="feedback-footer">
                <MessageIndicators
                    Feedback="@Feedback"
                    Metrics="@Metrics"
                    ToolCallCount="@(ToolCalls?.Count ?? 0)"
                    ReadOnly="@ReadOnly"
                    ShowFeedbackButtons="@_isHovering"
                    MessageId="@MessageId"
                    OnToolCallsClick="OnToolCallsClick"
                    OnFeedbackClick="OnFeedbackClick" />
            </MudChatFooter>
        }
    </MudChat>
}

@code {
    private bool _isHovering;

    [Parameter]
    public required string Text { get; set; }

    [Parameter]
    public Color Color { get; set; } = Color.Default;

    [Parameter]
    public bool Highlighted { get; set; }
    
    [Parameter]
    public int? MessageId { get; set; }

    [Parameter]
    public bool IsFirstParagraph { get; set; }

    [Parameter]
    public bool IsLastParagraph { get; set; }
    
    [Parameter]
    public bool ReadOnly { get; set; }

    [Parameter]
    public List<MessageToolCallInfo>? ToolCalls { get; set; }

    [Parameter]
    public List<MessageEvaluationMetricResponse>? Metrics { get; set; }

    [Parameter]
    public MessageFeedbackInfo? Feedback { get; set; }

    [Parameter]
    public EventCallback<int> OnToolCallsClick { get; set; }

    [Parameter]
    public EventCallback<(int MessageId, bool IsPositive)> OnFeedbackClick { get; set; }

    private void OnMouseEnter()
    {
        _isHovering = true;
    }

    private void OnMouseLeave()
    {
        _isHovering = false;
    }
}

