@inject HttpClient Http

<MudChat ChatPosition="ChatBubblePosition.End"
         Variant="Variant.Filled"
         Color="@(Highlighted ? Color.Info : Color)">
    @if (IsFirstParagraph)
    {
        <MudChatHeader Name="Player"/>
    }
    <MudChatBubble>
        @Text
    </MudChatBubble>
    
    @if (IsLastParagraph)
    {
        <MudChatFooter Class="d-flex justify-content-end align-items-center gap-2 mt-1">
            @if (MessageId.HasValue && Sentiment.HasValue)
            {
                if (ReadOnly)
                {
                    <MudTooltip Text="@GetSentimentTooltipText()" Placement="Placement.Top">
                        <MudIcon Icon="@GetSentimentIcon()"
                                 Color="@GetSentimentColor()"
                                 Size="Size.Small" />
                    </MudTooltip>
                }
                else
                {
                    <MudMenu AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter" Dense="true">
                        <ActivatorContent>
                            <MudTooltip Text="@GetSentimentTooltipText()" Placement="Placement.Top">
                                <MudIconButton Icon="@GetSentimentIcon()"
                                               Color="@GetSentimentColor()"
                                               Size="Size.Small"
                                               Variant="Variant.Text"
                                               Class="pa-0" />
                            </MudTooltip>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(1))" Icon="@Icons.Material.Filled.ThumbUp" IconColor="Color.Success">Positive</MudMenuItem>
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(0))" Icon="@Icons.Material.Filled.Balance" IconColor="Color.Default">Neutral</MudMenuItem>
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(-1))" Icon="@Icons.Material.Filled.ThumbDown" IconColor="Color.Error">Negative</MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
            }
            else if (!ReadOnly)
            {
                 <MudTooltip Text="Analyzing Sentiment..." Placement="Placement.Top">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassBottom" 
                             Color="Color.Default" 
                             Size="Size.Small"
                             Class="spin-icon" />
                 </MudTooltip>
            }
        </MudChatFooter>
    }
</MudChat>

@code {
    [Parameter]
    public required string Text { get; set; }

    [Parameter]
    public bool IsFirstParagraph { get; set; }

    [Parameter]
    public bool IsLastParagraph { get; set; }

    [Parameter]
    public int? MessageId { get; set; }

    [Parameter]
    public Color Color { get; set; } = Color.Primary;

    [Parameter]
    public bool Highlighted { get; set; }

    [Parameter]
    public int? Sentiment { get; set; }

    [Parameter]
    public double? Confidence { get; set; }

    [Parameter]
    public bool ReadOnly { get; set; }

    [Parameter]
    public int? SentimentSource { get; set; }

    private string GetSentimentIcon() => Sentiment switch
    {
        > 0 => Icons.Material.Filled.ThumbUp,
        < 0 => Icons.Material.Filled.ThumbDown,
        _ => Icons.Material.Filled.Balance
    };

    private Color GetSentimentColor() => Sentiment switch
    {
        > 0 => Color.Success,
        < 0 => Color.Error,
        _ => Color.Default
    };

    private async Task SetSentimentAsync(int newSentiment)
    {
        if (!MessageId.HasValue || ReadOnly) return;

        MattEland.Jaimes.ServiceDefinitions.Requests.UpdateMessageSentimentRequest request = new() { Sentiment = newSentiment };
        await Http.PutAsJsonAsync($"/messages/{MessageId}/sentiment", request);
        
        // Note: The UI will update automatically via SignalR broadcast from the server
    }

    private string GetSentimentTooltipText()
    {
        if (!Sentiment.HasValue)
            return "Unknown Sentiment";

        string sentimentLabel = Sentiment.Value > 0 ? "Positive" :
                                Sentiment.Value < 0 ? "Negative" : "Neutral";

        // SentimentSource: 0 = Model, 1 = Player
        if (SentimentSource == 1)
        {
            return $"{sentimentLabel} Sentiment - Set by User";
        }

        if (Confidence.HasValue)
        {
            int confidencePercent = (int)(Confidence.Value * 100);
            return $"{sentimentLabel} Sentiment - {confidencePercent}% Confidence";
        }

        return $"{sentimentLabel} Sentiment";
    }
}
