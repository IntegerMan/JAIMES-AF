@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using MudBlazor

<ChatBubble Position="ChatBubblePosition.End"
            Variant="Variant.Filled"
            Color="@(Highlighted ? Color.Info : Color)">
    @if (IsFirstParagraph)
    {
        <ChatHeader Name="Player"/>
    }
    <div class="@GetContentClasses()">
        @Text
    </div>

    @if (IsLastParagraph)
    {
        <ChatFooter Class="d-flex justify-content-end align-items-center gap-2 mt-1">
            @if (TriggeredContentModeration)
            {
                <MudTooltip Text="This message triggered Azure's content moderation policy. Click to learn more." Placement="Placement.Top">
                    <MudIconButton Icon="@Icons.Material.Filled.ReportProblem"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   Variant="Variant.Text"
                                   Class="pa-0"
                                   Href="https://go.microsoft.com/fwlink/?linkid=2198766"
                                   Target="_blank"/>
                </MudTooltip>
            }
            @if (IsTestCase && TestCaseId.HasValue)
            {
                <MudTooltip Text="This message is marked as a test case - Click to view details" Placement="Placement.Top">
                    <MudIconButton Icon="@Icons.Material.Filled.Science"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   Variant="Variant.Text"
                                   Class="pa-0"
                                   OnClick="ViewTestCase"/>
                </MudTooltip>
            }
            else if (MessageId.HasValue)
            {
                <MudTooltip Text="Mark as test case - Save this message and prior conversation as a test case for evaluating future agent versions" Placement="Placement.Top">
                    <MudIconButton Icon="@Icons.Material.Outlined.Science"
                                   Color="Color.Default"
                                   Size="Size.Small"
                                   Variant="Variant.Text"
                                   Class="pa-0"
                                   OnClick="CreateTestCaseAsync"/>
                </MudTooltip>
            }
            @if (Sentiment.HasValue)
            {
                @if (ReadOnly && NavigateOnClick && SentimentId.HasValue)
                {
                    @* Read-only mode with clickable navigation to details *@
                    <MudTooltip Text="@GetClickableTooltipText()" Placement="Placement.Top">
                        <MudIconButton Icon="@GetSentimentIcon()"
                                       Color="@GetSentimentColor()"
                                       Size="Size.Small"
                                       Variant="Variant.Text"
                                       Class="pa-0"
                                       OnClick="ViewDetails"/>
                    </MudTooltip>
                }
                else if (ReadOnly)
                {
                    @* Read-only mode without navigation *@
                    <MudTooltip Text="@GetSentimentTooltipText()" Placement="Placement.Top">
                        <MudIcon Icon="@GetSentimentIcon()"
                                 Color="@GetSentimentColor()"
                                 Size="Size.Small"/>
                    </MudTooltip>
                }
                else if (MessageId.HasValue)
                {
                    @* Editable mode with menu (requires MessageId) *@
                    <MudTooltip Text="@GetSentimentTooltipText()" Placement="Placement.Top">
                        <MudMenu Icon="@GetSentimentIcon()" 
                                 Color="@GetSentimentColor()" 
                                 Size="Size.Small" 
                                 Dense="true"
                                 AnchorOrigin="Origin.TopCenter" 
                                 TransformOrigin="Origin.BottomCenter">
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(1))" Icon="@Icons.Material.Filled.ThumbUp" IconColor="Color.Success">Positive</MudMenuItem>
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(0))" Icon="@Icons.Material.Filled.Balance" IconColor="Color.Default">Neutral</MudMenuItem>
                            <MudMenuItem OnClick="@(() => SetSentimentAsync(-1))" Icon="@Icons.Material.Filled.ThumbDown" IconColor="Color.Error">Negative</MudMenuItem>
                            @if (SentimentId.HasValue)
                            {
                                <MudDivider/>
                                <MudMenuItem OnClick="ViewDetails" Icon="@Icons.Material.Filled.Visibility" IconColor="Color.Primary">View Details</MudMenuItem>
                            }
                        </MudMenu>
                    </MudTooltip>
                }
                else
                {
                    @* Show sentiment as read-only icon when MessageId is null (early classification result) *@
                    <MudTooltip Text="@GetSentimentTooltipText()" Placement="Placement.Top">
                        <MudIcon Icon="@GetSentimentIcon()"
                                 Color="@GetSentimentColor()"
                                 Size="Size.Small"/>
                    </MudTooltip>
                }
            }
            else if (!ReadOnly)
            {
                @* Show spinner when sentiment hasn't been determined yet and not in read-only mode *@
                <MudTooltip Text="Analyzing Sentiment..." Placement="Placement.Top">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassBottom"
                             Color="Color.Default"
                             Size="Size.Small"
                             Class="spin-icon"/>
                </MudTooltip>
            }
        </ChatFooter>
    }
</ChatBubble>

@code {
    [Parameter] public required string Text { get; set; }

    [Parameter] public bool IsFirstParagraph { get; set; }

    [Parameter] public bool IsLastParagraph { get; set; }

    [Parameter] public int? MessageId { get; set; }

    [Parameter] public Color Color { get; set; } = Color.Primary;

    [Parameter] public bool Highlighted { get; set; }

    [Parameter] public int? Sentiment { get; set; }

    [Parameter] public double? Confidence { get; set; }

    [Parameter] public bool ReadOnly { get; set; }

    [Parameter] public int? SentimentSource { get; set; }

    [Parameter] public int? SentimentId { get; set; }

    /// <summary>
    /// When true and in ReadOnly mode, clicking the sentiment icon navigates to the details page.
    /// </summary>
    [Parameter]
    public bool NavigateOnClick { get; set; }

    /// <summary>
    /// True if this message is marked as a test case.
    /// </summary>
    [Parameter]
    public bool IsTestCase { get; set; }

    /// <summary>
    /// The ID of the test case if this message is a test case.
    /// </summary>
    [Parameter]
    public int? TestCaseId { get; set; }

    /// <summary>
    /// When true, shows a red exclamation mark indicating this message triggered Azure content moderation.
    /// </summary>
    [Parameter]
    public bool TriggeredContentModeration { get; set; }

    private string GetSentimentIcon() => Sentiment switch
    {
        > 0 => Icons.Material.Filled.ThumbUp,
        < 0 => Icons.Material.Filled.ThumbDown,
        _ => Icons.Material.Filled.Balance
    };

    private Color GetSentimentColor()
    {
        // If sentiment was set by user (1) or admin (2), always use Primary color
        if (SentimentSource is 1 or 2)
        {
            return Color.Primary;
        }

        // For model-assigned sentiments, use semantic colors
        return Sentiment switch
        {
            > 0 => Color.Success,
            < 0 => Color.Error,
            _ => Color.Default
        };
    }

    private async Task SetSentimentAsync(int newSentiment)
    {
        if (!MessageId.HasValue || ReadOnly) return;

        MattEland.Jaimes.ServiceDefinitions.Requests.UpdateMessageSentimentRequest request = new() {Sentiment = newSentiment};
        try
        {
            var response = await Http.PutAsJsonAsync($"/messages/{MessageId}/sentiment", request);

            if (!response.IsSuccessStatusCode)
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to update sentiment: {errorMsg}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update sentiment: {ex.Message}", Severity.Error);
        }

        // Note: The UI will update automatically via SignalR broadcast from the server if successful
    }

    private void ViewDetails()
    {
        if (SentimentId.HasValue)
        {
            NavigationManager.NavigateTo($"/admin/sentiments/{SentimentId.Value}");
        }
    }

    private void ViewTestCase()
    {
        if (TestCaseId.HasValue)
        {
            NavigationManager.NavigateTo($"/admin/test-cases/{TestCaseId.Value}");
        }
    }

    private async Task CreateTestCaseAsync()
    {
        if (!MessageId.HasValue) return;

        try
        {
            // Use first 50 characters of message text as default name
            string defaultName = Text.Length > 50 ? Text.Substring(0, 50) + "..." : Text;

            var request = new MattEland.Jaimes.ServiceDefinitions.Requests.CreateTestCaseRequest
            {
                MessageId = MessageId.Value,
                Name = defaultName,
                Description = null
            };

            var response = await Http.PostAsJsonAsync("/test-cases", request);

            if (response.IsSuccessStatusCode)
            {
                var testCase = await response.Content.ReadFromJsonAsync<MattEland.Jaimes.ServiceDefinitions.Responses.TestCaseResponse>();
                if (testCase != null)
                {
                    // Update local state to show the green icon
                    IsTestCase = true;
                    TestCaseId = testCase.Id;
                    Snackbar.Add("Message marked as a test case!", Severity.Success);
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                Snackbar.Add("This message is already a test case.", Severity.Warning);
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to create test case: {errorMsg}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to create test case: {ex.Message}", Severity.Error);
        }
    }

    private string GetSentimentTooltipText()
    {
        if (!Sentiment.HasValue)
            return "Unknown Sentiment";

        string sentimentLabel = Sentiment.Value > 0 ? "Positive" :
            Sentiment.Value < 0 ? "Negative" : "Neutral";

        // SentimentSource: 0 = Model, 1 = Player, 2 = Admin
        if (SentimentSource == 2)
        {
            return $"{sentimentLabel} Sentiment - Set by Admin";
        }

        if (SentimentSource == 1)
        {
            return $"{sentimentLabel} Sentiment - Set by User";
        }

        if (Confidence.HasValue)
        {
            int confidencePercent = (int) (Confidence.Value * 100);
            return $"{sentimentLabel} Sentiment - {confidencePercent}% Confidence";
        }

        return $"{sentimentLabel} Sentiment";
    }

    private string GetClickableTooltipText()
    {
        return GetSentimentTooltipText() + " - Click to view details";
    }

    private string GetContentClasses()
    {
        var classes = "chat-bubble-content";
        if (IsFirstParagraph)
        {
            classes += " has-pointer";
        }
        return classes;
    }

}
