@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDataGrid T="ToolUsageItemDto"
             ServerData="ServerReload"
             Filterable="false"
             Hover="true"
             Dense="true"
             Striped="true">
    <Columns>
        <PropertyColumn Property="x => x.ToolName" Title="Tool Name">
            <CellTemplate>
                <MudLink Href="@GetToolLink(context.Item.ToolName)" 
                         Typo="Typo.body2"
                         Color="Color.Primary"
                         Underline="Underline.Hover">
                    @context.Item.ToolName
                </MudLink>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.TotalCalls" Title="Total Calls">
            <CellTemplate>
                <MudChip Color="Color.Primary" Size="Size.Small">
                    @context.Item.TotalCalls
                </MudChip>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.HelpfulCount" Title="Helpful" Sortable="true">
            <CellTemplate>
                @if (context.Item.HelpfulCount > 0)
                {
                    <MudLink Href="@GetFeedbackLink(context.Item.ToolName, true)">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@context.Item.HelpfulCount</MudText>
                        </MudStack>
                    </MudLink>
                }
                else
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" Size="Size.Small" />
                        <MudText Typo="Typo.body2">@context.Item.HelpfulCount</MudText>
                    </MudStack>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.UnhelpfulCount" Title="Unhelpful" Sortable="true">
            <CellTemplate>
                @if (context.Item.UnhelpfulCount > 0)
                {
                    <MudLink Href="@GetFeedbackLink(context.Item.ToolName, false)">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@context.Item.UnhelpfulCount</MudText>
                        </MudStack>
                    </MudLink>
                }
                else
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" Size="Size.Small" />
                        <MudText Typo="Typo.body2">@context.Item.UnhelpfulCount</MudText>
                    </MudStack>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.EnabledAgents" Title="Enabled Agents" Sortable="false">
            <CellTemplate>
                @if (context.Item.EnabledAgents.Any())
                {
                    <MudStack Row="true" Spacing="1">
                        @foreach (var agent in context.Item.EnabledAgents.Take(3))
                        {
                            <MudLink Href="@($"/agents/{Uri.EscapeDataString(agent)}")" Typo="Typo.body2">@agent</MudLink>
                            @if (agent != context.Item.EnabledAgents.Take(3).Last())
                            {
                                <MudText Typo="Typo.body2">,</MudText>
                            }
                        }
                        @if (context.Item.EnabledAgents.Count > 3)
                        {
                            <MudText Typo="Typo.body2">(+@(context.Item.EnabledAgents.Count - 3) more)</MudText>
                        }
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="text-muted">None</MudText>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.EligibleMessages" Title="Eligible Messages">
            <CellTemplate>
                @context.Item.EligibleMessages.ToString("N0")
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.UsagePercentage" Title="Usage %" Sortable="true">
            <CellTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudProgressLinear Color="@GetUsageColor(context.Item.UsagePercentage)" 
                                       Value="@context.Item.UsagePercentage" 
                                       Max="100"
                                       Style="width: 100px; height: 8px;" />
                    <MudText Typo="Typo.body2">@context.Item.UsagePercentage.ToString("F1")%</MudText>
                </MudStack>
            </CellTemplate>
        </PropertyColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="ToolUsageItemDto" />
    </PagerContent>
    <NoRecordsContent>
        <div class="glass-card pa-6 text-center mx-auto" style="max-width: 400px;">
            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                <div class="icon-badge icon-badge-info">
                    <MudIcon Icon="@Icons.Material.Filled.Build" Style="color: white; font-size: 1.5rem;" />
                </div>
                <MudText Typo="Typo.h6">No Tool Usage Data</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    No tool calls have been recorded yet. Start a game to see tool usage statistics.
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Info"
                           Href="/admin/tool-test"
                           StartIcon="@Icons.Material.Filled.Science">
                    Test Tools
                </MudButton>
            </MudStack>
        </div>
    </NoRecordsContent>
</MudDataGrid>

@code {
    /// <summary>
    /// Optional agent ID to filter results.
    /// </summary>
    [Parameter]
    public string? AgentId { get; set; }

    /// <summary>
    /// Optional instruction version ID to filter results.
    /// </summary>
    [Parameter]
    public int? InstructionVersionId { get; set; }

    /// <summary>
    /// Optional game ID to filter results.
    /// </summary>
    [Parameter]
    public Guid? GameId { get; set; }

    /// <summary>
    /// Callback invoked when stats are loaded from the API.
    /// </summary>
    [Parameter]
    public EventCallback<ToolUsageListResponse> OnStatsLoaded { get; set; }

    private string GetToolLink(string toolName)
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(AgentId))
            queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
        if (InstructionVersionId.HasValue)
            queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
        if (GameId.HasValue)
            queryParams.Add($"gameId={GameId.Value}");
        
        string baseUrl = $"/admin/tools/{Uri.EscapeDataString(toolName)}";
        return queryParams.Count > 0 ? $"{baseUrl}?{string.Join("&", queryParams)}" : baseUrl;
    }

    private string GetFeedbackLink(string toolName, bool isPositive)
    {
        var queryParams = new List<string>
        {
            $"toolName={Uri.EscapeDataString(toolName)}",
            $"isPositive={isPositive.ToString().ToLower()}"
        };
        if (!string.IsNullOrEmpty(AgentId))
            queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
        if (InstructionVersionId.HasValue)
            queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
        
        return $"/admin/feedback?{string.Join("&", queryParams)}";
    }

    private static Color GetUsageColor(double percentage)
    {
        return percentage switch
        {
            >= 50 => Color.Success,
            >= 25 => Color.Info,
            >= 10 => Color.Warning,
            _ => Color.Default
        };
    }

    private async Task<GridData<ToolUsageItemDto>> ServerReload(GridState<ToolUsageItemDto> state)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");

            // MudDataGrid uses 0-based index, API uses 1-based page
            int page = state.Page + 1;
            int pageSize = state.PageSize;

            // Build query string with optional filters
            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrEmpty(AgentId))
                queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
            if (InstructionVersionId.HasValue)
                queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
            if (GameId.HasValue)
                queryParams.Add($"gameId={GameId.Value}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<ToolUsageListResponse>($"/admin/tools?{queryString}");

            if (response != null)
            {
                // Notify parent component of stats
                if (OnStatsLoaded.HasDelegate)
                {
                    await OnStatsLoaded.InvokeAsync(response);
                }

                return new GridData<ToolUsageItemDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception)
        {
            // Handle error (maybe show snackbar)
        }

        return new GridData<ToolUsageItemDto>
        {
            TotalItems = 0,
            Items = []
        };
    }

    // Insights generation state
    private bool _isGeneratingInsights;
    private string? _insightsResult;
    private int _insightsItemCount;

    /// <summary>
    /// Generates AI insights and shows them in a dialog.
    /// </summary>
    public async Task GenerateInsightsAsync()
    {
        if (!InstructionVersionId.HasValue || string.IsNullOrEmpty(AgentId))
            return;

        _isGeneratingInsights = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new GenerateInsightsRequest { InsightType = "tools" };
            
            var response = await client.PostAsJsonAsync(
                $"/agents/{AgentId}/instruction-versions/{InstructionVersionId}/generate-insights",
                request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GenerateInsightsResponse>();
                if (result?.Success == true)
                {
                    _insightsResult = result.Insights;
                    _insightsItemCount = result.ItemsAnalyzed;
                    
                    // Show dialog with markdown content
                    var parameters = new DialogParameters<InsightsDialog>
                    {
                        { x => x.Title, "Tool Usage Insights" },
                        { x => x.Content, result.Insights ?? "No insights available." },
                        { x => x.ItemCount, result.ItemsAnalyzed }
                    };
                    await DialogService.ShowAsync<InsightsDialog>("AI Insights", parameters);
                }
                else
                {
                    Snackbar.Add(result?.Error ?? "Failed to generate insights", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Failed to generate insights", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGeneratingInsights = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Returns true if insights generation is in progress.
    /// </summary>
    public bool IsGeneratingInsights => _isGeneratingInsights;
}
