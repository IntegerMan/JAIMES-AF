@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MattEland.Jaimes.Web.Components.Helpers
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@implements IAsyncDisposable

<MudDataGrid T="EvaluationMetricListItemDto"
             ServerData="ServerReload"
             Filterable="false"
             Hover="true"
             Dense="true"
             Striped="true"
             Groupable="true"
             GroupExpanded="true"
             RowClassFunc="@GetRowClass"
             @ref="_grid">
    <Columns>
        <PropertyColumn Property="x => x.GameId" Title="Game" Groupable="true" Grouping="true" Hidden="true">
            <CellTemplate>
                <MudLink Href="@($"/games/{context.Item.GameId}")">
                    @context.Item.GamePlayerName in @context.Item.GameScenarioName
                </MudLink>
            </CellTemplate>
            <GroupTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudLink Href="@($"/games/{context.Grouping.Key}")">
                        @context.Grouping.First().GamePlayerName in @context.Grouping.First().GameScenarioName
                    </MudLink>
                    <MudText Typo="Typo.caption" Class="text-muted">(@context.Grouping.Count() metrics)</MudText>
                </MudStack>
            </GroupTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.AgentName" Title="Agent">
            <CellTemplate>
                @if (!string.IsNullOrEmpty(context.Item.AgentId))
                {
                    <MattEland.Jaimes.Web.Components.Shared.AgentVersionDisplay 
                        AgentId="@context.Item.AgentId" 
                        AgentName="@(context.Item.AgentName ?? "Unknown")" 
                        VersionId="@context.Item.InstructionVersionId"
                        VersionNumber="@context.Item.AgentVersion" />
                }
                else
                {
                    <MudText>@context.Item.AgentName</MudText>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.MessageId" Title="Message" Groupable="true" Grouping="true">
            <CellTemplate>
                <MudLink Href="@($"/admin/metrics/{context.Item.MessageId}")">
                     @if (!string.IsNullOrEmpty(context.Item.MessagePreview))
                     {
                         @context.Item.MessagePreview
                     }
                     else
                     {
                         @context.Item.MessageId
                     }
                </MudLink>
            </CellTemplate>
            <GroupTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudLink Href="@($"/admin/metrics/{context.Grouping.Key}")">
                        @{
                             var firstItem = context.Grouping.First();
                             if (!string.IsNullOrEmpty(firstItem.MessagePreview))
                             {
                                 @firstItem.MessagePreview
                             }
                             else
                             {
                                 @($"Message {context.Grouping.Key}")
                             }
                        }
                    </MudLink>
                    <MudText Typo="Typo.caption" Class="text-muted">(@context.Grouping.Count() items)</MudText>
                    <MudSpacer />
                    @if (context.Grouping.Any(x => x.IsMissing))
                    {
                        var msgId = context.Grouping.Key is int id ? id : 0;
                        if (_reevaluatingMessageIds.Contains(msgId))
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.HourglassEmpty" 
                                       Variant="Variant.Outlined" 
                                       Color="Color.Default" 
                                       Size="Size.Small"
                                       Disabled="true">
                                Update Pending...
                            </MudButton>
                        }
                        else
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.Refresh" 
                                       Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="@(async () => await TriggerReEvaluation(msgId))">
                                Re-evaluate Missing
                            </MudButton>
                        }
                    }
                </MudStack>
            </GroupTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.MetricName" Title="Metric">
            <CellTemplate>
                <strong>@context.Item.MetricName</strong>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Score" Title="Score">
            <CellTemplate>
                @if (context.Item.IsMissing)
                {
                    <MudText Typo="Typo.caption" Class="text-muted">N/A</MudText>
                }
                else
                {
                    <MudChip T="string" Color="@MetricColorHelper.GetScoreColor(context.Item.Score)" Size="Size.Small">
                        @context.Item.Score.ToString("F2")
                    </MudChip>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Passed" Title="Status">
            <CellTemplate>
                @if (context.Item.IsMissing)
                {
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">Missing</MudChip>
                }
                else if (context.Item.Passed == true)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Pass</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Fail</MudChip>
                }
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Remarks" Title="Remarks">
            <CellTemplate>
                @if (!string.IsNullOrEmpty(context.Item.Remarks))
                {
                    <MudTooltip Text="@context.Item.Remarks" Placement="Placement.Top">
                        <MudText Typo="Typo.body2">@TruncateText(context.Item.Remarks, 50)</MudText>
                    </MudTooltip>
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="text-muted">No remarks provided</MudText>
                }
            </CellTemplate>
        </PropertyColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudStack Row="true" Spacing="0">
                    <MudTooltip Text="View Game" Placement="Placement.Top">
                        <MudIconButton Icon="@Icons.Material.Filled.Gamepad"
                                       Color="Color.Secondary"
                                       Size="Size.Small"
                                       Href="@($"/games/{context.Item.GameId}")"
                                       Target="_blank"/>
                    </MudTooltip>
                    @if (!string.IsNullOrEmpty(context.Item.Diagnostics))
                    {
                        <MudTooltip Text="View Diagnostics" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Filled.Biotech"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => ShowDiagnostics(context.Item))"/>
                        </MudTooltip>
                    }
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="EvaluationMetricListItemDto"/>
    </PagerContent>
    <NoRecordsContent>
        <MudText Typo="Typo.body1" Class="pa-4">
            No evaluation metrics found.
        </MudText>
    </NoRecordsContent>
</MudDataGrid>

@inject ISnackbar Snackbar

@code {
    private MudDataGrid<EvaluationMetricListItemDto>? _grid;

    /// <summary>
    /// Optional agent ID to filter results.
    /// </summary>
    [Parameter]
    public string? AgentId { get; set; }

    /// <summary>
    /// Optional instruction version ID to filter results.
    /// </summary>
    [Parameter]
    public int? InstructionVersionId { get; set; }

    /// <summary>
    /// Optional game ID to filter results.
    /// </summary>
    [Parameter]
    public Guid? GameId { get; set; }

    /// <summary>
    /// Optional metric name to filter results.
    /// </summary>
    [Parameter]
    public string? MetricName { get; set; }

    /// <summary>
    /// Optional filter for pass/fail status.
    /// </summary>
    [Parameter]
    public bool? Passed { get; set; }

    /// <summary>
    /// Optional minimum score filter.
    /// </summary>
    [Parameter]
    public double? MinScore { get; set; }

    /// <summary>
    /// Optional maximum score filter.
    /// </summary>
    [Parameter]
    public double? MaxScore { get; set; }

    /// <summary>
    /// Optional evaluator ID to filter results.
    /// </summary>
    [Parameter]
    public int? EvaluatorId { get; set; }

    private HashSet<int> _reevaluatingMessageIds = [];
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        // Build hub connection using the API service URL, similar to GameDetails.razor.cs
        HttpClient apiClient = HttpClientFactory.CreateClient("Api");
        string hubUrl = new Uri(apiClient.BaseAddress!, "/hubs/messages").ToString();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<MessageUpdateNotification>("MessageUpdated", async (notification) =>
        {
            if (notification.UpdateType == MessageUpdateType.MetricsEvaluated)
            {
               await InvokeAsync(async () =>
               {
                   // Remove from pending set
                   if (_reevaluatingMessageIds.Contains(notification.MessageId))
                   {
                       _reevaluatingMessageIds.Remove(notification.MessageId);
                       StateHasChanged(); // Force UI update immediately to allow button removal/update
                   }
                   
                   // Reload data to show updated metrics
                   if (_grid != null)
                   {
                       await _grid.ReloadServerData();
                   }
               });
            }
        });

        try
        {
            await _hubConnection.StartAsync();
            await _hubConnection.InvokeAsync("JoinAdmin");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect to SignalR hub: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private string GetRowClass(EvaluationMetricListItemDto item, int rowNumber)
    {
        return item.IsMissing ? "missing-evaluator-row" : "";
    }

    private async Task TriggerReEvaluation(int messageId)
    {
        _reevaluatingMessageIds.Add(messageId);
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var response = await client.PostAsync($"/messages/{messageId}/reevaluate", null);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Re-evaluation enqueued. Metrics will update automatically.", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to trigger re-evaluation: {error}", Severity.Error);
                _reevaluatingMessageIds.Remove(messageId); // Revert on failure
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            _reevaluatingMessageIds.Remove(messageId); // Revert on error
            StateHasChanged();
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        if (text.Length <= maxLength) return text;
        return text[..maxLength] + "...";
    }

    private async Task ShowDiagnostics(EvaluationMetricListItemDto item)
    {
        await DialogService.ShowMessageBox(
            $"Diagnostics: {item.MetricName}",
            item.Diagnostics ?? "No diagnostics available");
    }

    private async Task<GridData<EvaluationMetricListItemDto>> ServerReload(GridState<EvaluationMetricListItemDto> state)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");

            // MudDataGrid uses 0-based index, API uses 1-based page
            int page = state.Page + 1;
            int pageSize = state.PageSize;

            // Build query string with optional filters
            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrEmpty(AgentId))
                queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
            if (InstructionVersionId.HasValue)
                queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
            if (GameId.HasValue)
                queryParams.Add($"gameId={GameId.Value}");
            if (!string.IsNullOrEmpty(MetricName))
                queryParams.Add($"metricName={Uri.EscapeDataString(MetricName)}");
            if (Passed.HasValue)
                queryParams.Add($"passed={Passed.Value.ToString().ToLower()}");
            if (MinScore.HasValue)
                queryParams.Add($"minScore={MinScore.Value}");
            if (MaxScore.HasValue)
                queryParams.Add($"maxScore={MaxScore.Value}");
            if (EvaluatorId.HasValue)
                queryParams.Add($"evaluatorId={EvaluatorId.Value}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<EvaluationMetricListResponse>($"/admin/metrics?{queryString}");

            if (response != null)
            {
                return new GridData<EvaluationMetricListItemDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception)
        {
            // Handle error (maybe show snackbar)
        }

        return new GridData<EvaluationMetricListItemDto>
        {
            TotalItems = 0,
            Items = []
        };
    }

    // Insights generation state
    private bool _isGeneratingInsights;

    /// <summary>
    /// Generates AI insights and shows them in a dialog.
    /// </summary>
    public async Task GenerateInsightsAsync()
    {
        if (!InstructionVersionId.HasValue || string.IsNullOrEmpty(AgentId))
            return;

        _isGeneratingInsights = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new GenerateInsightsRequest { InsightType = "metrics" };
            
            var response = await client.PostAsJsonAsync(
                $"/agents/{AgentId}/instruction-versions/{InstructionVersionId}/generate-insights",
                request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GenerateInsightsResponse>();
                if (result?.Success == true)
                {
                    // Show dialog with markdown content
                    var parameters = new DialogParameters<InsightsDialog>
                    {
                        { x => x.Title, "Metrics Insights" },
                        { x => x.Content, result.Insights ?? "No insights available." },
                        { x => x.ItemCount, result.ItemsAnalyzed }
                    };
                    await DialogService.ShowAsync<InsightsDialog>("AI Insights", parameters);
                }
                else
                {
                    Snackbar.Add(result?.Error ?? "Failed to generate insights", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Failed to generate insights", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGeneratingInsights = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Returns true if insights generation is in progress.
    /// </summary>
    public bool IsGeneratingInsights => _isGeneratingInsights;
}
