@page "/admin/indexed-documents"
@rendermode InteractiveServer

<PageTitle>Indexed Documents</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
	<MudPaper Class="pa-8" Elevation="2">
		<MudText Typo="Typo.h3" GutterBottom="true" Class="mb-2">Indexed Documents</MudText>
		<MudText Typo="Typo.subtitle1" GutterBottom="true" Class="mb-6 text-muted">View documents indexed in Kernel Memory vector store</MudText>

		<MudText Typo="Typo.body1" Class="mb-6" Style="line-height: 1.75;">
			Browse all documents that have been indexed by Kernel Memory. You can filter by index or view all documents.
		</MudText>

		<MudDivider Class="my-6" />

		<MudPaper Class="pa-4" Elevation="1">
			<MudText Typo="Typo.h6" GutterBottom="true" Class="mb-4">Filter</MudText>
			
			@if (isLoadingIndexes)
			{
				<MudProgressLinear Indeterminate="true" Class="mb-4" />
			}
			
			<MudSelect @bind-Value="selectedIndex" 
			           Label="Index" 
			           Variant="Variant.Outlined" 
			           Class="mb-4"
			           FullWidth="true"
			           Disabled="@isLoadingIndexes"
			           HelperText="Select an index to filter documents, or 'All' to view all documents">
				<MudSelectItem Value="@((string?)null)">All Indexes</MudSelectItem>
				@foreach (var index in indexes)
				{
					<MudSelectItem Value="@index">@index</MudSelectItem>
				}
			</MudSelect>

			<MudButton Variant="Variant.Filled" 
			           Color="Color.Primary" 
			           OnClick="LoadDocumentsAsync" 
			           Disabled="@(isLoading || isLoadingIndexes)"
			           Class="mb-4">
				@if (isLoading)
				{
					<MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
				}
				Load Documents
			</MudButton>
		</MudPaper>

		@if (!string.IsNullOrEmpty(errorMessage))
		{
			<MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
		}

		@if (indexes.Length == 0 && string.IsNullOrEmpty(errorMessage))
		{
			<MudAlert Severity="Severity.Warning" Class="mt-4">
				No indexes found in Kernel Memory. This may indicate that no documents have been indexed yet, or there may be a connection issue with the vector store.
			</MudAlert>
		}

		@if (isLoading && documentList == null)
		{
			<MudDivider Class="my-6" />
			<MudProgressLinear Indeterminate="true" Class="my-4" />
			<MudText Class="text-center text-muted">Loading documents...</MudText>
		}
		else if (documentList != null)
		{
			<MudDivider Class="my-6" />

			<MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">
				Documents in Index: <strong>@documentList.IndexName</strong> 
				(@documentList.TotalCount total, showing @((documentList.Page - 1) * documentList.PageSize + 1)-@(Math.Min(documentList.Page * documentList.PageSize, documentList.TotalCount)))
			</MudText>

			@if (documentList.Documents.Length == 0)
			{
				<MudAlert Severity="Severity.Warning">No documents found in this index.</MudAlert>
			}
			else
			{
				<MudTable Items="@documentList.Documents" Hover="true" Dense="false" Striped="true" Elevation="1" Loading="@isLoading">
					<HeaderContent>
						<MudTh>Document ID</MudTh>
						<MudTh>Index</MudTh>
						<MudTh>Status</MudTh>
						<MudTh>Last Update</MudTh>
						<MudTh>Tags</MudTh>
					</HeaderContent>
					<RowTemplate>
						<MudTd DataLabel="Document ID">@context.DocumentId</MudTd>
						<MudTd DataLabel="Index">@context.Index</MudTd>
						<MudTd DataLabel="Status">
							<MudChip T="string" Size="Size.Small" 
							         Color="@(context.Status == "Completed" ? Color.Success : context.Status == "Processing" ? Color.Warning : Color.Default)">
								@(context.Status ?? "Unknown")
							</MudChip>
						</MudTd>
						<MudTd DataLabel="Last Update">
							@if (context.LastUpdate.HasValue)
							{
								@context.LastUpdate.Value.ToString("g")
							}
							else
							{
								<span class="text-muted">N/A</span>
							}
						</MudTd>
						<MudTd DataLabel="Tags">
							@if (context.Tags.Count > 0)
							{
								<div style="display: flex; flex-wrap: wrap; gap: 4px;">
									@foreach (var tag in context.Tags)
									{
										<MudChip T="string" Size="Size.Small" Variant="Variant.Text">
											<strong>@tag.Key:</strong> @tag.Value
										</MudChip>
									}
								</div>
							}
							else
							{
								<span class="text-muted">No tags</span>
							}
						</MudTd>
					</RowTemplate>
				</MudTable>

				@if (documentList.TotalPages > 1)
				{
					<MudDivider Class="my-4" />
					<MudPagination Count="@documentList.TotalPages" 
					               Selected="@currentPage" 
					               SelectedChanged="@(async (int page) => await LoadPageAsync(page))"
					               BoundaryCount="2"
					               ShowFirstButton="true"
					               ShowLastButton="true"
					               Disabled="@isLoading" />
				}
			}
		}
	</MudPaper>
</MudContainer>

