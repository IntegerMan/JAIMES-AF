@page "/admin/embeddings"
@rendermode InteractiveServer

<PageTitle>Embeddings Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
	<MudPaper Class="pa-8" Elevation="2">
		<MudText Typo="Typo.h3" GutterBottom="true" Class="mb-2">Embeddings Management</MudText>
		<MudText Typo="Typo.subtitle1" GutterBottom="true" Class="mb-6 text-muted">View and manage document embeddings</MudText>

		<MudText Typo="Typo.body1" Class="mb-6" Style="line-height: 1.75;">
			View all generated embeddings with their source documents and preview text. Delete individual embeddings or all embeddings at once.
		</MudText>

		<MudDivider Class="my-8" />

		<MudPaper Class="pa-4 mb-4" Elevation="1">
			<div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
				<MudButton Variant="Variant.Outlined" 
				           Color="Color.Primary" 
				           OnClick="RefreshEmbeddingsAsync" 
				           Disabled="@isLoadingEmbeddings">
					@if (isLoadingEmbeddings)
					{
						<MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
					}
					Refresh Embeddings
				</MudButton>

				<MudButton Variant="Variant.Filled" 
				           Color="Color.Error" 
				           OnClick="ShowDeleteAllDialog"
				           Disabled="@(isLoadingEmbeddings || isDeletingAll || (embeddings?.Length ?? 0) == 0)">
					@if (isDeletingAll)
					{
						<MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
					}
					Delete All Embeddings
				</MudButton>
			</div>

			@if (!string.IsNullOrEmpty(errorMessage))
			{
				<MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
			}

			@if (!string.IsNullOrEmpty(successMessage))
			{
				<MudAlert Severity="Severity.Success" Class="mb-4">@successMessage</MudAlert>
			}

			@if (isLoadingEmbeddings && embeddings == null)
			{
				<MudProgressLinear Indeterminate="true" Class="mb-4" />
			}
			else if (embeddings != null)
			{
				@if (embeddings.Length == 0)
				{
					<MudText Typo="Typo.body2" Class="mb-4" Style="color: #666;">
						No embeddings found. Embeddings will appear here after documents are processed and embedded.
					</MudText>
				}
				else
				{
					<MudText Typo="Typo.body2" Class="mb-4">
						<strong>Total Embeddings:</strong> @embeddings.Length
					</MudText>

					<MudTable Items="@embeddings" Hover="true" Dense="false" Striped="true" Elevation="0">
						<HeaderContent>
							<MudTh>Source Document</MudTh>
							<MudTh>Embedding ID</MudTh>
							<MudTh>Chunk ID</MudTh>
							<MudTh>Preview Text (140 chars)</MudTh>
							<MudTh>Actions</MudTh>
						</HeaderContent>
						<RowTemplate>
							<MudTd DataLabel="Source Document">
								<MudText Typo="Typo.body2">@context.FileName</MudText>
							</MudTd>
							<MudTd DataLabel="Embedding ID">
								<MudText Typo="Typo.body2" Style="font-family: monospace; font-size: 0.875rem;">
									@context.EmbeddingId
								</MudText>
							</MudTd>
							<MudTd DataLabel="Chunk ID">
								<MudText Typo="Typo.body2" Style="font-family: monospace; font-size: 0.875rem;">
									@context.ChunkId
								</MudText>
							</MudTd>
							<MudTd DataLabel="Preview Text">
								<MudText Typo="Typo.body2" Style="font-size: 0.875rem; color: #666;">
									@context.PreviewText
								</MudText>
							</MudTd>
							<MudTd DataLabel="Actions">
								<MudTooltip Text="Delete embedding">
									<MudIconButton Icon="@FluentIcons.Filled.Delete"
									               Color="Color.Error"
									               Disabled="@(IsDeleting(context) || isLoadingEmbeddings)"
									               OnClick="@(() => DeleteEmbeddingAsync(context))" />
								</MudTooltip>
							</MudTd>
						</RowTemplate>
						<PagerContent>
							<MudTablePager />
						</PagerContent>
					</MudTable>
				}
			}
			else if (!isLoadingEmbeddings)
			{
				<MudText Typo="Typo.body2" Class="mb-4" Style="color: #666;">
					Click "Refresh Embeddings" to load the embeddings list.
				</MudText>
			}
		</MudPaper>
	</MudPaper>
</MudContainer>

<MudDialog @bind-IsVisible="showDeleteAllDialog" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small })">
	<DialogContent>
		<MudText Typo="Typo.h6">Delete All Embeddings?</MudText>
		<MudText Typo="Typo.body2" Class="mt-4">
			Are you sure you want to delete all @(embeddings?.Length ?? 0) embeddings? This action cannot be undone.
		</MudText>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="HideDeleteAllDialog">Cancel</MudButton>
		<MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="DeleteAllEmbeddingsAsync">Delete All</MudButton>
	</DialogActions>
</MudDialog>

