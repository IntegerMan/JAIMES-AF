@page "/admin/run-tests"
@rendermode InteractiveServer

@using MattEland.Jaimes.ServiceDefinitions.Responses

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Run Tests</PageTitle>

<MudPaper Class="pa-4" Style="min-height: calc(100vh - 120px); display: flex; flex-direction: column;">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack>
            <MudText Typo="Typo.h4">Run Tests</MudText>
            <MudText Class="text-muted">Select test cases, agent versions, and evaluators to run tests.</MudText>
        </MudStack>
        @if (!_isLoading && !_isRunning)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.PlayArrow"
                       Disabled="@(!CanRun)"
                       OnClick="RunTestsAsync">
                Run @_selectedTestCases.Count Test(s) Ã— @_selectedVersions.Count Version(s)
            </MudButton>
        }
    </MudStack>

    @if (_isLoading)
    {
        <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
            <MudProgressCircular Indeterminate="true"/>
        </div>
    }
    else if (_isRunning)
    {
        <MudPaper Class="pa-6" Elevation="2">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudProgressCircular Indeterminate="true" Color="Color.Success" Size="Size.Large"/>
                <MudText Typo="Typo.h6">Running Tests...</MudText>
                <MudText Class="text-muted">
                    Running @_selectedTestCases.Count test case(s) against @_selectedVersions.Count version(s)
                    with @_selectedEvaluators.Count evaluator(s)
                </MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudGrid Spacing="3" Style="display: flex; flex: 1;">
            @* Test Case Selection *@
            <MudItem xs="12" md="4" Style="display: flex;">
                <MudPaper Class="pa-4" Elevation="2" Style="flex: 1; display: flex; flex-direction: column;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6">Test Cases</MudText>
                        <MudStack Row="true" Spacing="1">
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectAllTestCases">All</MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectNoTestCases">None</MudButton>
                        </MudStack>
                    </MudStack>
                    
                    @if (_testCases is null || _testCases.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">No test cases available.</MudAlert>
                    }
                    else
                    {
                        <div style="flex: 1; overflow-y: auto; min-height: 0;">
                            <MudList T="int" Dense="true">
                                @foreach (var tc in _testCases)
                                {
                                    <MudListItem>
                                        <MudCheckBox T="bool"
                                                     Value="@_selectedTestCases.Contains(tc.Id)"
                                                     ValueChanged="@((bool v) => ToggleTestCase(tc.Id, v))"
                                                     Label="@tc.Name"
                                                     Dense="true"/>
                                    </MudListItem>
                                }
                            </MudList>
                        </div>
                        <MudText Typo="Typo.caption" Class="text-muted mt-2">
                            @_selectedTestCases.Count selected
                        </MudText>
                    }
                </MudPaper>
            </MudItem>

            @* Agent/Version Selection *@
            <MudItem xs="12" md="4" Style="display: flex;">
                <MudPaper Class="pa-4" Elevation="2" Style="flex: 1; display: flex; flex-direction: column;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6">Agent Versions</MudText>
                        <MudStack Row="true" Spacing="1">
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectAllVersions">All</MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectNoVersions">None</MudButton>
                        </MudStack>
                    </MudStack>

                    @if (_agents is null || _agents.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">No agents available.</MudAlert>
                    }
                    else
                    {
                        <div style="flex: 1; overflow-y: auto; min-height: 0;">
                            <MudExpansionPanels MultiExpansion="true">
                                @foreach (var agent in _agents)
                                {
                                    bool hasSelectedVersions = agent.Versions.Any(v => _selectedVersions.Contains(v.Id));
                                    <MudExpansionPanel Text="@agent.Name" Expanded="@(hasSelectedVersions || agent.Id == AgentId)">
                                        @if (agent.Versions.Count == 0)
                                        {
                                            <MudText Class="text-muted">No versions</MudText>
                                        }
                                        else
                                        {
                                            <MudList T="int" Dense="true">
                                                @foreach (var version in agent.Versions.OrderByDescending(v => v.CreatedAt))
                                                {
                                                    <MudListItem>
                                                        <MudCheckBox T="bool"
                                                                     Value="@_selectedVersions.Contains(version.Id)"
                                                                     ValueChanged="@((bool v) => ToggleVersion(version.Id, v))"
                                                                     Dense="true">
                                                            <ChildContent>
                                                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                                                    <MudText>@version.VersionNumber</MudText>
                                                                    @if (version.IsActive)
                                                                    {
                                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                                                                    }
                                                                </MudStack>
                                                            </ChildContent>
                                                        </MudCheckBox>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        }
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        </div>
                        <MudText Typo="Typo.caption" Class="text-muted mt-2">
                            @_selectedVersions.Count version(s) selected
                        </MudText>
                    }
                </MudPaper>
            </MudItem>

            @* Evaluators Selection *@
            <MudItem xs="12" md="4" Style="display: flex;">
                <MudPaper Class="pa-4" Elevation="2" Style="flex: 1; display: flex; flex-direction: column;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6">Evaluators</MudText>
                        <MudStack Row="true" Spacing="1">
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectAllEvaluators">All</MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="SelectNoEvaluators">None</MudButton>
                        </MudStack>
                    </MudStack>

                    @if (_evaluators is null || _evaluators.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">No evaluators registered.</MudAlert>
                    }
                    else
                    {
                        <div style="flex: 1; overflow-y: auto; min-height: 0;">
                            <MudList T="string" Dense="true">
                                @foreach (var evaluator in _evaluators)
                                {
                                    <MudListItem>
                                        <MudCheckBox T="bool"
                                                     Value="@_selectedEvaluators.Contains(evaluator.Name)"
                                                     ValueChanged="@((bool v) => ToggleEvaluator(evaluator.Name, v))"
                                                     Dense="true">
                                            <ChildContent>
                                                <MudStack>
                                                    <MudText>@evaluator.Name</MudText>
                                                    @if (!string.IsNullOrEmpty(evaluator.Description))
                                                    {
                                                        <MudText Typo="Typo.caption" Class="text-muted">
                                                            @evaluator.Description
                                                        </MudText>
                                                    }
                                                </MudStack>
                                            </ChildContent>
                                        </MudCheckBox>
                                    </MudListItem>
                                }
                            </MudList>
                        </div>
                        <MudText Typo="Typo.caption" Class="text-muted mt-2">
                            @_selectedEvaluators.Count of @_evaluators.Count evaluator(s) enabled
                        </MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudPaper>
