@page "/scenarios"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Scenarios</PageTitle>

<MudPaper Class="pa-4">
	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>
	<MudText Typo="Typo.h4">Scenarios</MudText>

	<MudText Class="mb-4">Manage your game scenarios. Create new scenarios or edit existing ones.</MudText>

	<MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/scenarios/new" Class="mb-4">
		New Scenario
	</MudButton>

	<div style="position: relative; min-height: 200px;">
		@if (_isLoading)
		{
			<div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
				<MudProgressCircular Indeterminate="true"/>
			</div>
		}

		@if (!_isLoading && !string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && (_scenarios is null || _scenarios.Length == 0))
		{
			<MudText Class="mb-4">
				No scenarios yet.
				<MudLink Href="/scenarios/new">Create a new scenario</MudLink>
			</MudText>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && _scenarios is not null && _scenarios.Length > 0)
		{
			<MudTable Items="_scenarios" Dense="true" Hover="true">
				<HeaderContent>
					<MudTh>Name</MudTh>
					<MudTh>Description</MudTh>
					<MudTh>Ruleset ID</MudTh>
					<MudTh>Agents</MudTh>
					<MudTh align="Align.Right">Actions</MudTh>
				</HeaderContent>
				<RowTemplate>
					<MudTd>@context.Name</MudTd>
					<MudTd>@(context.Description ?? "-")</MudTd>
					<MudTd>@context.RulesetId</MudTd>
					<MudTd>
						@if (GetScenarioAgentsDisplay(context.Id).Any())
						{
							@foreach (var agentInfo in GetScenarioAgentsDisplay(context.Id))
							{
								<MudStack Row="true" Spacing="1" Class="me-3 d-inline-flex" AlignItems="AlignItems.Center">
									<MudLink Href="@($"/agents/{agentInfo.AgentId}")">@agentInfo.AgentName</MudLink>
									<MudText Typo="Typo.body2">(</MudText>
									<MudLink Href="@($"/agents/{agentInfo.AgentId}/versions/{agentInfo.VersionId}")" Typo="Typo.body2">
										@agentInfo.VersionNumber
									</MudLink>
									<MudText Typo="Typo.body2">)</MudText>
								</MudStack>
							}
						}
						else
						{
							<span class="text-muted">No agents</span>
						}
					</MudTd>
					<MudTd align="Align.Right">
						<MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
						           Href="@($"/scenarios/{context.Id}/edit")" Class="me-2">
							Edit
						</MudButton>
					</MudTd>
				</RowTemplate>
			</MudTable>
		}
	</div>
</MudPaper>

