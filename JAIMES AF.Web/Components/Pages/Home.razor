@page "/"

<PageTitle>JAIMES AF - AI Game Master</PageTitle>

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	@* Hero Section *@
	<MudPaper Class="hero-gradient pa-6 mb-4" Elevation="3">
		<MudGrid>
			<MudItem xs="12" md="8">
				<MudText Typo="Typo.h3" Style="font-weight: 700; color: white;" Class="mb-2">
					JAIMES AF
				</MudText>
				<MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.9); font-weight: 400;" Class="mb-3">
					Join AI in Making Epic Stories â€” Agent Framework
				</MudText>
				<MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.85); max-width: 600px;" Class="mb-4">
					Experience AI-powered tabletop roleplaying with an intelligent Game Master that adapts to your choices in real-time.
				</MudText>
				<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
					<MudButton Variant="Variant.Filled" Size="Size.Large" Href="/games/new"
					           StartIcon="@Icons.Material.Filled.PlayArrow"
					           Style="font-weight: 600;">
						Start New Game
					</MudButton>
					@if (_lastPlayedGame != null)
					{
						<MudButton Variant="Variant.Outlined" Size="Size.Large"
						           Href="@($"/games/{_lastPlayedGame.GameId}")"
						           StartIcon="@Icons.Material.Filled.Restore">
							Continue: @_lastPlayedGame.Title
						</MudButton>
					}
				</MudStack>
			</MudItem>
			<MudItem xs="12" md="4" Class="d-flex flex-column align-end justify-space-between">
				<MudButton Variant="Variant.Text" Href="/admin"
				           StartIcon="@Icons.Material.Filled.AdminPanelSettings"
				           Style="color: rgba(255,255,255,0.8);">
					Admin Portal
				</MudButton>
				<MudIcon Icon="@Icons.Material.Filled.AutoAwesome"
				         Style="font-size: 100px; color: rgba(255,255,255,0.2);" />
			</MudItem>
		</MudGrid>
	</MudPaper>

	@* Quick Actions - Now First *@
	<MudGrid Spacing="3" Class="mb-4">
		<MudItem xs="12" md="4">
			<MudPaper Class="quick-action-card pa-4" Elevation="2" Style="height: 100%;">
				<MudStack Spacing="2">
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@Icons.Material.Filled.SportsEsports" Color="Color.Primary" Size="Size.Large" />
						<MudText Typo="Typo.h6">Play Games</MudText>
					</MudStack>
					<MudText Typo="Typo.body2" Class="text-muted">
						Start new adventures or continue existing ones with your AI Game Master.
					</MudText>
					<MudSpacer />
					<MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/games" FullWidth="true">
						View Games
					</MudButton>
				</MudStack>
			</MudPaper>
		</MudItem>
		<MudItem xs="12" md="4">
			<MudPaper Class="quick-action-card pa-4" Elevation="2" Style="height: 100%;">
				<MudStack Spacing="2">
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@Icons.Material.Filled.MenuBook" Color="Color.Secondary" Size="Size.Large" />
						<MudText Typo="Typo.h6">Scenarios</MudText>
					</MudStack>
					<MudText Typo="Typo.body2" Class="text-muted">
						Create story seeds with prompts that guide the AI's storytelling.
					</MudText>
					<MudSpacer />
					<MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="/scenarios" FullWidth="true">
						Manage Scenarios
					</MudButton>
				</MudStack>
			</MudPaper>
		</MudItem>
		<MudItem xs="12" md="4">
			<MudPaper Class="quick-action-card pa-4" Elevation="2" Style="height: 100%;">
				<MudStack Spacing="2">
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Info" Size="Size.Large" />
						<MudText Typo="Typo.h6">Characters</MudText>
					</MudStack>
					<MudText Typo="Typo.body2" Class="text-muted">
						Create player characters that the AI weaves into your story.
					</MudText>
					<MudSpacer />
					<MudButton Variant="Variant.Filled" Color="Color.Info" Href="/players" FullWidth="true">
						Manage Characters
					</MudButton>
				</MudStack>
			</MudPaper>
		</MudItem>
	</MudGrid>

	@* Metrics Dashboard - Now Second *@
	<MudGrid Spacing="3" Class="mb-4">
		<MudItem xs="6" md="3">
			<MetricCard Icon="@Icons.Material.Filled.SportsEsports"
			            IconColor="Color.Primary"
			            Value="@_gamesCount.ToString()"
			            Label="Active Games" />
		</MudItem>
		<MudItem xs="6" md="3">
			<MetricCard Icon="@Icons.Material.Filled.MenuBook"
			            IconColor="Color.Secondary"
			            Value="@_scenariosCount.ToString()"
			            Label="Scenarios" />
		</MudItem>
		<MudItem xs="6" md="3">
			<MetricCard Icon="@Icons.Material.Filled.Person"
			            IconColor="Color.Info"
			            Value="@_playersCount.ToString()"
			            Label="Characters" />
		</MudItem>
		<MudItem xs="6" md="3">
			<MetricCard Icon="@Icons.Material.Filled.AutoStories"
			            IconColor="Color.Success"
			            Value="@_rulesetsCount.ToString()"
			            Label="Rulesets" />
		</MudItem>
	</MudGrid>

	@* Summary Paragraph *@
	<MudPaper Class="pa-4 mb-4" Elevation="1" Style="background: linear-gradient(to right, rgba(123, 44, 191, 0.05), rgba(67, 97, 238, 0.05));">
		<MudText Typo="Typo.body1" Style="line-height: 1.7;" Align="Align.Center">
			JAIMES AF is an AI-powered single-player roleplaying platform built on Microsoft's Agent Framework.
			It uses Azure OpenAI to create an intelligent Game Master that crafts immersive narratives,
			remembers your story context, and adapts dynamically to your choices. Upload your favorite rulebooks,
			create scenarios, and let the AI bring your adventures to life.
		</MudText>
	</MudPaper>

	@* Feature Highlights *@
	<MudPaper Class="feature-bar pa-3" Elevation="1">
		<MudStack Row="true" Justify="Justify.SpaceAround" AlignItems="AlignItems.Center" Style="flex-wrap: wrap;">
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="feature-item">
				<MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Primary" />
				<MudText Typo="Typo.body2" Style="font-weight: 500;">AI-Powered Storytelling</MudText>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="feature-item">
				<MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Secondary" />
				<MudText Typo="Typo.body2" Style="font-weight: 500;">Dynamic Worlds</MudText>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="feature-item">
				<MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Info" />
				<MudText Typo="Typo.body2" Style="font-weight: 500;">Your Story, Your Way</MudText>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="feature-item">
				<MudIcon Icon="@Icons.Material.Filled.Memory" Color="Color.Success" />
				<MudText Typo="Typo.body2" Style="font-weight: 500;">Microsoft Agent Framework</MudText>
			</MudStack>
		</MudStack>
	</MudPaper>

</MudContainer>

@code {
	private GameInfoResponse? _lastPlayedGame;
	private int _gamesCount;
	private int _scenariosCount;
	private int _playersCount;
	private int _rulesetsCount;

	protected override async Task OnInitializedAsync()
	{
		var logger = LoggerFactory.CreateLogger("Home");

		// Fetch all metrics in parallel
		var gamesTask = Http.GetFromJsonAsync<ListGamesResponse>("/games");
		var scenariosTask = Http.GetFromJsonAsync<ScenarioListResponse>("/scenarios");
		var playersTask = Http.GetFromJsonAsync<PlayerListResponse>("/players");
		var rulesetsTask = Http.GetFromJsonAsync<RulesetListResponse>("/rulesets");
		var latestGameTask = Http.GetAsync("/games/latest");

		try
		{
			await Task.WhenAll(gamesTask, scenariosTask, playersTask, rulesetsTask, latestGameTask);

			_gamesCount = gamesTask.Result?.Games?.Length ?? 0;
			_scenariosCount = scenariosTask.Result?.Scenarios?.Length ?? 0;
			_playersCount = playersTask.Result?.Players?.Length ?? 0;
			_rulesetsCount = rulesetsTask.Result?.Rulesets?.Length ?? 0;

			if (latestGameTask.Result.IsSuccessStatusCode)
			{
				_lastPlayedGame = await latestGameTask.Result.Content.ReadFromJsonAsync<GameInfoResponse>();
			}
		}
		catch (Exception ex)
		{
			logger.LogError(ex, "Failed to load home page data");
		}
	}
}
