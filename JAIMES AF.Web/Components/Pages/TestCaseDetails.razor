@page "/admin/test-cases/{TestCaseId:int}"
@rendermode InteractiveServer
@using MattEland.Jaimes.Web.Components.Chat
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Shared

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@using MattEland.Jaimes.Web.Components.Dialogs

<PageTitle>Test Case Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
	@if (_isLoading)
	{
		<div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
			<MudProgressCircular Indeterminate="true"/>
		</div>
	}
	else if (!string.IsNullOrEmpty(_errorMessage))
	{
		<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
	}
	else if (_testCase != null)
	{
		<CompactHeroSection Title="@(_testCase.Name ?? "Test Case Details")"
		                    Icon="@Icons.Material.Filled.Science"
		                    Theme="CompactHeroSection.HeroTheme.Info"
		                    ActionText="@(_testCase.IsActive ? "Run Test" : null)"
		                    ActionHref="@($"/admin/run-tests?testCaseId={TestCaseId}")"
		                    ActionIcon="@Icons.Material.Filled.PlayArrow">
			<SubtitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
					@if (_testCase.IsActive)
					{
						<MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
					}
					else
					{
						<MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
					}
					<span>•</span>
					<AgentLink AgentId="@_testCase.AgentId" AgentName="@(_testCase.AgentName ?? "Unknown")" />
					<span>•</span>
					<span>@_testCase.RunCount run@(_testCase.RunCount != 1 ? "s" : "")</span>
				</MudStack>
			</SubtitleContent>
		</CompactHeroSection>

		<MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="mb-4"></MudBreadcrumbs>

		@* Editable Title Section *@
		<MudPaper Class="pa-4 mb-4" Elevation="2">
			<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
				<MudStack>
					@if (_isEditingTitle)
					{
						<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
							<MudTextField @bind-Value="_editableTitle"
							              Variant="Variant.Outlined"
							              Margin="Margin.Dense"
							              Immediate="true"
							              Placeholder="Enter test case name"
							              Style="min-width: 300px;"/>
							<MudIconButton Icon="@Icons.Material.Filled.Check"
							               Color="Color.Success"
							               Size="Size.Small"
							               Disabled="@_isSavingTitle"
							               OnClick="SaveTitleAndExitEditModeAsync"/>
							<MudIconButton Icon="@Icons.Material.Filled.Close"
							               Color="Color.Error"
							               Size="Size.Small"
							               OnClick="CancelTitleEdit"/>
						</MudStack>
					}
					else
					{
						<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
							<MudText Typo="Typo.h6">@_testCase.Name</MudText>
							<MudTooltip Text="Edit test case name" Placement="Placement.Top">
								<MudIconButton Icon="@Icons.Material.Filled.Edit"
								               Size="Size.Small"
								               Color="Color.Default"
								               OnClick="EnterTitleEditMode"/>
							</MudTooltip>
						</MudStack>
					}
					<MudText Typo="Typo.body2" Class="text-muted">@(_testCase.Description ?? "No description")</MudText>
				</MudStack>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudText Typo="Typo.body2" Class="text-muted">Game:</MudText>
					<MudLink Href="@($"/games/{_testCase.GameId}")">@(_testCase.GameTitle ?? "Unknown")</MudLink>
				</MudStack>
			</MudStack>
		</MudPaper>

		@* Summary Stats *@
		@if (_runs is not null && _runs.Count > 0)
		{
			<MudGrid Spacing="3" Class="mb-4">
				<MudItem xs="12" sm="4">
					<MetricCard Icon="@Icons.Material.Filled.PlayArrow"
					            Value="@_testCase.RunCount.ToString()"
					            Label="Total Runs"
					            ColorVariant="MetricCard.MetricColorVariant.Info" />
				</MudItem>
				<MudItem xs="12" sm="4">
					<MetricCard Icon="@Icons.Material.Filled.Score"
					            Value="@(GetAverageScore()?.ToString("F2") ?? "-")"
					            Label="Avg Score"
					            ColorVariant="@GetScoreColorVariant(GetAverageScore())" />
				</MudItem>
				<MudItem xs="12" sm="4">
					<MetricCard Icon="@Icons.Material.Filled.Timer"
					            Value="@((GetAverageDuration()?.ToString("F0") ?? "-") + " ms")"
					            Label="Avg Duration"
					            ColorVariant="MetricCard.MetricColorVariant.Success" />
				</MudItem>
			</MudGrid>
		}

		@* Two-column layout: Test Runs (66%) | Details & Context (33%) *@
		<MudGrid Spacing="3">
			@* Test Runs Grid - Left Side (66%) *@
			<MudItem xs="12" md="8">
				@if (_runs is not null && _runs.Count > 0)
				{
					<MudPaper Class="pa-3" Elevation="2" Style="height: calc(100vh - 420px); display: flex; flex-direction: column;">
						<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
							<MudText Typo="Typo.h6">Test Runs</MudText>
							<MudChip T="string" Size="Size.Small" Color="Color.Info">@_testCase.RunCount</MudChip>
						</MudStack>
						<div style="flex: 1; overflow: auto;">
							<MudTable Items="@_paginatedRuns" Dense="true" Hover="true" Striped="true" Style="white-space: nowrap;" @bind-RowsPerPage="_rowsPerPage">
								<HeaderContent>
									<MudTh Style="min-width: 140px;">Version</MudTh>
									<MudTh Style="min-width: 130px;">Executed</MudTh>
									<MudTh Style="min-width: 90px;">Avg Score</MudTh>
									@foreach (var metricName in _metricNames)
									{
										<MudTh Style="min-width: 80px;">
											<MudTooltip Text="@metricName" Placement="Placement.Top">
												<span style="cursor: help;">@GetMetricShortName(metricName)</span>
											</MudTooltip>
										</MudTh>
									}
									<MudTh Style="min-width: 90px;">Duration</MudTh>
								</HeaderContent>
								<RowTemplate>
									<MudTd>
										<AgentVersionDisplay
											AgentId="@(context.AgentId ?? "")"
											AgentName="@(context.AgentName ?? "Unknown")"
											VersionId="@context.InstructionVersionId"
											VersionNumber="@(context.VersionNumber ?? "Unknown")" />
									</MudTd>
									<MudTd>
										<MudText Typo="Typo.caption">@context.ExecutedAt.ToLocalTime().ToString("g")</MudText>
									</MudTd>
									<MudTd>
										@if (context.Metrics?.Any() == true)
										{
											var avgScore = context.Metrics.Average(m => m.Score);
											<MudChip T="string" Size="Size.Small" Color="@MetricColorHelper.GetScoreColor(avgScore)">
												@avgScore.ToString("F2")
											</MudChip>
										}
										else
										{
											<MudText Class="text-muted">-</MudText>
										}
									</MudTd>
									@foreach (var metricName in _metricNames)
									{
										var metric = context.Metrics?.FirstOrDefault(m => m.MetricName == metricName);
										<MudTd>
											@if (metric != null)
											{
												<MudTooltip Text="@GetMetricTooltip(metricName, metric.Score, metric.Remarks)" Placement="Placement.Top">
													<MudChip T="string" Size="Size.Small" Color="@MetricColorHelper.GetScoreColor(metric.Score)">
														@metric.Score.ToString("F1")
													</MudChip>
												</MudTooltip>
											}
											else
											{
												<span class="text-muted">-</span>
											}
										</MudTd>
									}
									<MudTd>
										<MudText Typo="Typo.caption">@(context.DurationMs?.ToString("N0") ?? "-") ms</MudText>
									</MudTd>
								</RowTemplate>
								<PagerContent>
									<MudTablePager PageSizeOptions="new int[] { 15, 25, 50, 100 }" />
								</PagerContent>
							</MudTable>
						</div>
					</MudPaper>
				}
				else
				{
					<MudPaper Class="pa-3" Elevation="2">
						<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
							<MudText Typo="Typo.h6">Test Runs</MudText>
							<MudChip T="string" Size="Size.Small" Color="Color.Info">0</MudChip>
						</MudStack>
						<MudAlert Severity="Severity.Info">No test runs found for this test case.</MudAlert>
					</MudPaper>
				}
			</MudItem>

			@* Conversation Context - Right Side (33%) *@
			<MudItem xs="12" md="4">
				<MudExpansionPanels Elevation="2">
					<MudExpansionPanel Expanded="true">
						<TitleContent>
							<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
								<MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Color="Color.Primary" />
								<MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Conversation Context</MudText>
							</MudStack>
						</TitleContent>
						<ChildContent>
							<div style="max-height: calc(100vh - 500px); overflow-y: auto;">
								<ReadOnlyConversation MessageId="@_testCase.MessageId" ContextCount="5" />
							</div>
						</ChildContent>
					</MudExpansionPanel>
				</MudExpansionPanels>
			</MudItem>
		</MudGrid>
	}
</MudContainer>
