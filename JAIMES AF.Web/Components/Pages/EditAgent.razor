@page "/agents/{AgentId}/edit"
@rendermode InteractiveServer

<PageTitle>Edit Agent</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
	<FormPageHeader Title="@(_isLoading ? "Edit Agent" : $"Edit: {_name}")"
	                Icon="@Icons.Material.Filled.SmartToy"
	                Theme="FormPageHeader.HeroTheme.Secondary"
	                Subtitle="Modify agent configuration" />

	<MudPaper Class="pa-6" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
        </MudStack>

		@if (_isLoading)
		{
			<MudProgressCircular Indeterminate="true" Class="my-4"/>
		}
		else if (!string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
		}

		@if (!_isLoading && !string.IsNullOrEmpty(_errorMessage) && _errorMessage.Contains("not found"))
		{
			<MudButton Variant="Variant.Text" Color="Color.Primary" Href="/agents" Class="mt-2">
				Back to Agents
			</MudButton>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage))
		{
			<MudForm>
				<MudTextField Value="@AgentId"
				              Label="Agent ID"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="true"
				              HelperText="Agent ID cannot be changed"/>

				<MudStack Row="true" Class="mb-4" Spacing="4">
					<MudTextField Value="@_name"
					              Label="Name"
					              Variant="Variant.Outlined"
					              Disabled="true"
					              ReadOnly="true"
					              Class="flex-grow-1"/>

					<MudTextField Value="@_role"
					              Label="Role"
					              Variant="Variant.Outlined"
					              Disabled="true"
					              ReadOnly="true"
					              Class="flex-grow-1"/>
				</MudStack>

				<MudTextField @bind-Value="_instructions"
				              Label="Instructions"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="_isSaving"
				              Lines="8"
				              Required="true"
				              RequiredError="Instructions are required"
				              HelperText="Agent instructions that define how this agent behaves. Changes will create a new instruction version."/>

				<div class="d-flex gap-2 mt-4">
					<MudButton Variant="Variant.Filled"
					           Color="Color.Secondary"
					           OnClick="UpdateAgentAsync"
					           Disabled="_isSaving || !IsFormValid()"
					           StartIcon="@Icons.Material.Filled.Check">
						@if (_isSaving)
						{
							<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
							<span class="ms-2">Saving...</span>
						}
						else
						{
							<span>Save Changes</span>
						}
					</MudButton>

					<MudButton Variant="Variant.Text"
					           Color="Color.Default"
					           Href="@($"/agents/{AgentId}")"
					           Disabled="_isSaving">
						Cancel
					</MudButton>
				</div>
			</MudForm>
		}
	</MudPaper>
</MudContainer>