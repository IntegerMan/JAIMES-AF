@page "/games/{GameId:guid}"
@using MattEland.Jaimes.Web.Components.Helpers
@using Microsoft.Extensions.AI
@using MudBlazor

@rendermode InteractiveServer

<PageTitle>Game Details</PageTitle>

<div class="game-details-page-wrapper">
	<MudContainer MaxWidth="MaxWidth.Large" Class="game-details-wrapper">
		@if (_isLoading)
		{
			<MudProgressCircular Indeterminate="true" Class="my-4"/>
		}
		else if (!string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}
		else if (_game is null)
		{
			<MudText>(No game loaded)</MudText>
		}
		else
		{
			<div class="game-header">
				<MudText Typo="Typo.h5" Class="mb-0">Game details</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					<strong>@_game.PlayerName</strong> playing <strong>@_game.ScenarioName</strong>
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					Ruleset: <strong>@_game.RulesetName</strong> (@_game.RulesetId)
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					Created: @ToLocalTime(_game.CreatedAt).ToString("g")
					@if (_game.LastPlayedAt.HasValue)
					{
						<span> | Last played: @ToLocalTime(_game.LastPlayedAt.Value).ToString("g")</span>
					}
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">Game @_game.GameId</MudText>
			</div>

			<div id="chat-scroll-container" class="chat-scroll">
				@for (int msgIndex = 0; msgIndex < (_messages?.Count ?? 0); msgIndex++)
				{
					var m = _messages![msgIndex];

					// Skip empty messages
					if (string.IsNullOrWhiteSpace(m.Text))
					{
						continue;
					}

					int? messageId = GetMessageId(msgIndex);
					bool hasFeedback = messageId.HasValue && _messageFeedback.ContainsKey(messageId.Value);
					MessageFeedbackInfo? feedback = messageId.HasValue && _messageFeedback.TryGetValue(messageId.Value, out var fb) ? fb : null;
					bool hasToolCalls = messageId.HasValue && _messageToolCalls.ContainsKey(messageId.Value);
					List<MessageToolCallInfo>? toolCalls = messageId.HasValue && _messageToolCalls.TryGetValue(messageId.Value, out var tc) ? tc : null;
					string toolNames = toolCalls != null ? string.Join(", ", toolCalls.Select(t => t.ToolName)) : string.Empty;

					List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
					@foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
					{
						bool isFirstParagraph = index == 0;
						bool isLastParagraph = index == paragraphs.Count - 1;
						@if (m.Role == ChatRole.User)
						{
							<MudChat ChatPosition="ChatBubblePosition.End"
							         Variant="Variant.Filled"
							         Color="Color.Primary">
								@if (isFirstParagraph)
								{
									<MudChatHeader Name="Player"/>
								}
								<MudChatBubble>
									@paragraph
								</MudChatBubble>
							</MudChat>
						}
						else
						{
							@if (!string.IsNullOrWhiteSpace(paragraph))
							{
								<MudChat ChatPosition="ChatBubblePosition.Start"
								         Variant="Variant.Filled"
								         Color="Color.Default"
								         @onmouseenter="@(() => HoverStart(messageId, messageId.HasValue ? null : msgIndex))"
								         @onmouseleave="@(() => HoverStop(messageId, messageId.HasValue ? null : msgIndex))">
									@if (isFirstParagraph)
									{
										<MudChatHeader Name="Game Master"/>
									}
									<MudChatBubble>
										@((MarkupString)ChatHelpers.RenderMarkdown(paragraph))
									</MudChatBubble>
									@if (isLastParagraph && messageId.HasValue)
									{
										<MudChatFooter Class="feedback-footer">
											<div class="d-flex align-items-center gap-2">
												@if (hasToolCalls && toolCalls != null)
												{
													<MudTooltip Text="@($"Tools used: {toolNames}")">
														<MudIconButton Icon="@Icons.Material.Filled.Build"
														               Color="Color.Default"
														               Size="Size.Small"
														               Variant="Variant.Text"
														               Class="tool-call-button"
														               OnClick="@(() => ShowToolCallsDialogAsync(messageId.Value))"/>
													</MudTooltip>
												}
												@if (hasFeedback && feedback != null)
												{
													<MudTooltip Text="@(string.IsNullOrWhiteSpace(feedback.Comment) ? $"You provided {(feedback.IsPositive ? "positive" : "negative")} feedback" : feedback.Comment)">
														<div class="d-flex align-items-center gap-1">
															<MudIcon Icon="@(feedback.IsPositive ? Icons.Material.Filled.ThumbUp : Icons.Material.Filled.ThumbDown)"
															         Color="Color.Default"
															         Size="Size.Small"
															         Class="feedback-icon-existing"/>
														</div>
													</MudTooltip>
												}
												else if (IsHovering && _hoveredMessageId == messageId)
												{
													<div class="d-flex align-items-center gap-1">
														<MudTooltip Text="Mark as good and provide feedback">
															<MudIconButton Icon="@Icons.Material.Filled.ThumbUp"
															               Color="Color.Default"
															               Size="Size.Small"
															               Variant="Variant.Text"
															               Class="feedback-button"
															               OnClick="@(() => ShowFeedbackDialogAsync(messageId.Value, true))"/>
														</MudTooltip>
														<MudTooltip Text="Mark as bad and provide feedback">
															<MudIconButton Icon="@Icons.Material.Filled.ThumbDown"
															               Color="Color.Default"
															               Size="Size.Small"
															               Variant="Variant.Text"
															               Class="feedback-button"
															               OnClick="@(() => ShowFeedbackDialogAsync(messageId.Value, false))"/>
														</MudTooltip>
													</div>
												}
												else
												{
													<div class="feedback-spacer"></div>
												}
											</div>
										</MudChatFooter>
									}
								</MudChat>
							}
						}
					}
				}

				@if (_isSending)
				{
					<MudChat ChatPosition="ChatBubblePosition.Start"
					         Variant="Variant.Filled"
					         Color="Color.Default">
						<MudChatHeader Name="Game Master"/>
						<MudChatBubble>
							<div class="typing-indicator">
								<span></span>
								<span></span>
								<span></span>
							</div>
						</MudChatBubble>
					</MudChat>
				}
			</div>

			<div class="message-bar">
				<MudGrid Class="align-items-center">
					<MudItem xs="10" sm="11">
						<MudTextField @bind-Value="_userMessage.Text" Label="Message" Placeholder="Type a message..."
						              FullWidth="true" Immediate="true" OnKeyDown="OnKeyDown"/>
					</MudItem>
					<MudItem xs="2" sm="1" Class="d-flex justify-end">
						<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessageAsync">
							Send
						</MudButton>
					</MudItem>
				</MudGrid>
			</div>
		}
	</MudContainer>
</div>

<style>
	.feedback-footer {
		min-height: 25px;
		display: flex;
		align-items: center;
	}

	.feedback-spacer {
		min-height: 25px;
		width: 1px;
	}

	.feedback-button {
		color: var(--mud-palette-text-primary) !important;
	}

	.feedback-icon-existing {
		color: var(--mud-palette-text-primary) !important;
	}

	.tool-call-button {
		color: var(--mud-palette-text-primary) !important;
	}
</style>