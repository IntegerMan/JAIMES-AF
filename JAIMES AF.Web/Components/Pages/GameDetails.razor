@page "/games/{GameId:guid}"
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Shared
@using MattEland.Jaimes.Web.Components.Dialogs
@using Microsoft.Extensions.AI
@using MudBlazor
@using MattEland.Jaimes.Web.Components.Chat

@rendermode InteractiveServer

<PageTitle>Game Details</PageTitle>

<div class="game-details-page-wrapper">
	<MudContainer MaxWidth="MaxWidth.Large" Class="game-details-wrapper">
		@if (_isLoading)
		{
			<div class="game-loading-container">
				<MudStack AlignItems="AlignItems.Center" Spacing="3">
					<MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large"/>
					<MudText Typo="Typo.h6" Color="Color.Primary">Loading game...</MudText>
				</MudStack>
			</div>
		}
		else if (!string.IsNullOrEmpty(_errorMessage) && _failedMessageIndex == null)
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}
		else if (_game is null)
		{
			<MudText>(No game loaded)</MudText>
		}
		else
		{
			UpdateBreadcrumbs(_game.Title ?? $"{_game.PlayerName} in {_game.ScenarioName}");
			<CompactHeroSection Title="@(_game.Title ?? $"{_game.PlayerName} in {_game.ScenarioName}")"
			                    Subtitle="@_game.ScenarioName"
			                    Icon="@Icons.Material.Filled.SportsEsports"
			                    Theme="CompactHeroSection.HeroTheme.Primary">
				<ExtraContent>
					<div class="version-badge">
						<MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" Color="Color.Secondary"/>
						<MudLink Href="@GetAgentLink()" Typo="Typo.caption" Color="Color.Inherit" Class="version-badge-link">
							@(GetCurrentAgentName())
						</MudLink>
						<span class="version-badge-separator">â€¢</span>
						<MudLink Href="@GetVersionLink()" Typo="Typo.caption" Color="Color.Inherit" Class="version-badge-link">
							@if (_selectedVersionId == null)
							{
								<span>Latest</span>
							}
							else
							{
								<span>v@(GetCurrentVersionNumber())</span>
							}
						</MudLink>
						<MudTooltip Text="Game Settings">
							<MudIconButton Icon="@Icons.Material.Filled.Settings" 
							               Size="Size.Small" 
							               Color="Color.Default"
							               OnClick="OpenSettingsDialogAsync" />
						</MudTooltip>
					</div>
				</ExtraContent>
			</CompactHeroSection>

			<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2 px-4">
				<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
			</MudStack>

			<div id="chat-scroll-container" class="chat-scroll">
				@for (int msgIndex = 0; msgIndex < (_messages?.Count ?? 0); msgIndex++)
				{
					var m = _messages![msgIndex];
					int capturedIndex = msgIndex; // Capture for lambda closure structure					// Calculate agent info and version switch logic
					string? agentId = null;
					string? agentName = null;
					int? instructionVersionId = null;
					string? versionNumber = null;
					bool isVersionSwitch = false;
					bool isExempt = false;
					int? messageId = GetMessageId(msgIndex);
					bool isStreaming = _streamingMessageIndexes.Contains(msgIndex);

					MessageAgentInfo? agentInfo = null;
					if (messageId.HasValue)
						_messageAgentInfo.TryGetValue(messageId.Value, out agentInfo);

					// Only show agent info for completed (non-streaming) messages
					if (m.Role == ChatRole.Assistant && agentInfo != null && !isStreaming)
					{
						agentId = agentInfo.AgentId;
						agentName = agentInfo.AgentName;
						instructionVersionId = agentInfo.InstructionVersionId;
						versionNumber = agentInfo.VersionNumber ?? "1"; // Default to v1 if unknown
						isExempt = agentInfo.IsScriptedMessage;

						// Check previous assistant message for version switch
						// Find the last assistant message before this one
						bool foundPrevNonScripted = false;
						for (int i = msgIndex - 1; i >= 0; i--)
						{
							var prevMsg = _messages[i];
							int? prevMsgId = GetMessageId(i);

							MessageAgentInfo? prevAgentInfo = null;
							if (prevMsgId.HasValue) _messageAgentInfo.TryGetValue(prevMsgId.Value, out prevAgentInfo);

							if (prevMsg.Role == ChatRole.Assistant && prevAgentInfo != null)
							{
								// Skip scripted messages when looking for a version comparison
								if (prevAgentInfo.IsScriptedMessage) continue;

								foundPrevNonScripted = true;

								// detected a switch if agent ID changed OR version ID changed
								if (prevAgentInfo.AgentId != agentId ||
								    prevAgentInfo.InstructionVersionId != instructionVersionId)
								{
									isVersionSwitch = true;
								}

								break;
							}
						}

						// If this is the VERY first NON-SCRIPTED assistant message, treat it as a "switch" (start)
						if (!isVersionSwitch && !foundPrevNonScripted)
						{
							isVersionSwitch = true;
						}
					}

					// Skip empty messages
					if (string.IsNullOrWhiteSpace(m.Text))
					{
						continue;
					}

					// Pre-calculate data needed for components (avoiding dictionary lookups in render loop logic where possible)
					MessageFeedbackResponse? feedback = messageId.HasValue && _messageFeedback.TryGetValue(messageId.Value, out var fb) ? fb : null;
					List<MessageToolCallResponse>? toolCalls = messageId.HasValue && _messageToolCalls.TryGetValue(messageId.Value, out var tc) ? tc : null;
					List<MessageEvaluationMetricResponse>? metrics = messageId.HasValue && _messageMetrics.TryGetValue(messageId.Value, out var met) ? met : null;
					// Try to get sentiment from real messageId first, then fall back to temporary index-based ID for early classification
					MessageSentimentInfo? sentimentInfo = messageId.HasValue && _messageSentiment.TryGetValue(messageId.Value, out var si)
						? si
						: _messageSentiment.TryGetValue(-(msgIndex + 1), out var tempSi)
							? tempSi
							: null;

					List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
					@foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
					{
						bool isFirstParagraph = index == 0;
						bool isLastParagraph = index == paragraphs.Count - 1;

						@if (m.Role == ChatRole.User)
						{
							<UserChatMessage
								Text="@paragraph"
								IsFirstParagraph="@isFirstParagraph"
								IsLastParagraph="@isLastParagraph"
								MessageId="@messageId"
								Sentiment="@sentimentInfo?.Sentiment"
								Confidence="@sentimentInfo?.Confidence"
								SentimentSource="@sentimentInfo?.SentimentSource"
								SentimentId="@sentimentInfo?.SentimentId"
								IsTestCase="@(messageId.HasValue && _messageTestCases.ContainsKey(messageId.Value))"
								TestCaseId="@(messageId.HasValue && _messageTestCases.TryGetValue(messageId.Value, out var tcId) ? tcId : null)"
								TriggeredContentModeration="@_contentModerationMessageIndexes.Contains(msgIndex)"/>
						}
						else
						{
							@if (!string.IsNullOrWhiteSpace(paragraph))
							{
								<AssistantChatMessage
									Text="@paragraph"
									MessageId="@messageId"
									IsFirstParagraph="@isFirstParagraph"
									IsLastParagraph="@isLastParagraph"
									ToolCalls="@toolCalls"
									Metrics="@metrics"
									Feedback="@feedback"
									OnToolCallsClick="@OnToolCallClicked"
									OnFeedbackClick="@OnFeedbackClicked"
									OnMetricsClick="@OnMetricsClicked"
									ReadOnly="false"
									AgentId="@agentId"
									AgentName="@agentName"
									InstructionVersionId="@instructionVersionId"
									VersionNumber="@versionNumber"
									IsVersionSwitch="@isVersionSwitch"
									ExemptFromProcessing="@isExempt"
									IsScriptedMessage="@isExempt"
									HasMissingEvaluators="@(messageId.HasValue && _messageHasMissingEvaluators.TryGetValue(messageId.Value, out var hasM) && hasM)"
									IsProcessing="@(!messageId.HasValue || !_loadedMetricsMessageIds.Contains(messageId.Value))"
									IsStreaming="@isStreaming"
									ExpectedMetricCount="@(messageId.HasValue && _messageExpectedMetricCount.TryGetValue(messageId.Value, out var expCount) ? expCount : null)"
									ErrorsByMetric="@(messageId.HasValue && _messageMetricErrors.TryGetValue(messageId.Value, out var errors) ? errors : null)"/>
							}
						}
					}

					@* Show error message immediately after the message that triggered it *@
					@if (_failedMessageIndex == msgIndex)
					{
						@if (_isContentModerationError)
						{
							<ContentModerationErrorMessage OnRetry="@(() => RetryMessageAsync(capturedIndex))" />
						}
						else if (!string.IsNullOrEmpty(_errorMessage))
						{
							<GenericErrorMessage ErrorMessage="@_errorMessage" OnRetry="@(() => RetryMessageAsync(capturedIndex))" />
						}
					}
				}

				@if (_isSending)
				{
					<MudChat ChatPosition="ChatBubblePosition.Start"
					         Variant="Variant.Filled"
					         Color="Color.Default">
						<MudChatHeader Name="Game Master"/>
						<MudChatBubble>
							<div class="typing-indicator">
								<span></span>
								<span></span>
								<span></span>
							</div>
						</MudChatBubble>
					</MudChat>
				}
			</div>

			<div class="message-bar">
				<div class="message-input-row">
					<input id="chat-input" 
					       type="text"
					       class="chat-input"
					       @bind="_userMessageText" 
					       @bind:event="oninput"
					       @onkeydown="OnKeyDown"
					       placeholder="Type a message..."
					       disabled="@_isSending" />
					<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessageAsync" Disabled="@_isSending">
						Send
					</MudButton>
				</div>
			</div>
		}
	</MudContainer>
</div>

@code {

	private void OnToolCallClicked(int messageId)
	{
		if (_messageToolCalls.TryGetValue(messageId, out List<MessageToolCallResponse>? toolCalls) &&
		    toolCalls != null &&
		    toolCalls.Count > 0)
		{
			NavigationManager.NavigateTo($"/admin/tool-calls/{toolCalls[0].Id}");
		}
	}

	private async Task OnFeedbackClicked((int MessageId, bool IsPositive) args)
	{
		await ShowFeedbackDialogAsync(args.MessageId, args.IsPositive);
	}

	private void OnMetricsClicked(int messageId)
	{
		ShowMetricsDialogAsync(messageId);
	}

	private List<BreadcrumbItem> _breadcrumbs = new();

	protected override async Task OnInitializedAsync()
	{
		// Initial breadcrumb state
		UpdateBreadcrumbs("Game Details");
		await base.OnInitializedAsync();
	}

	// Helper to update breadcrumbs
	private void UpdateBreadcrumbs(string gameName)
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Games", href: "/games"),
			new BreadcrumbItem(gameName, href: null, disabled: true)
		};
	}

}

