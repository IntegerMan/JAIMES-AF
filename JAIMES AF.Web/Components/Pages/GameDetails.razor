@page "/games/{GameId:guid}"
@using MattEland.Jaimes.Web.Components.Helpers
@using Microsoft.Extensions.AI
@using MudBlazor
@using MattEland.Jaimes.Web.Components.Chat

@rendermode InteractiveServer

<PageTitle>Game Details</PageTitle>

<div class="game-details-page-wrapper">
	<MudContainer MaxWidth="MaxWidth.Large" Class="game-details-wrapper">
		@if (_isLoading)
		{
			<MudProgressCircular Indeterminate="true" Class="my-4"/>
		}
		else if (!string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}
		else if (_game is null)
		{
			<MudText>(No game loaded)</MudText>
		}
		else
		{
			<div class="game-header">
				<MudText Typo="Typo.h5" Class="mb-0">Game details</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					<strong>@_game.PlayerName</strong> playing <strong>@_game.ScenarioName</strong>
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					Ruleset: <strong>@_game.RulesetName</strong> (@_game.RulesetId)
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">
					Created: @ToLocalTime(_game.CreatedAt).ToString("g")
					@if (_game.LastPlayedAt.HasValue)
					{
						<span> | Last played: @ToLocalTime(_game.LastPlayedAt.Value).ToString("g")</span>
					}
				</MudText>
				<MudText Typo="Typo.body2" Class="text-muted">Game @_game.GameId</MudText>
			</div>

			<div id="chat-scroll-container" class="chat-scroll">
				@for (int msgIndex = 0; msgIndex < (_messages?.Count ?? 0); msgIndex++)
				{
					var m = _messages![msgIndex];

					// Skip empty messages
					if (string.IsNullOrWhiteSpace(m.Text))
					{
						continue;
					}

					int? messageId = GetMessageId(msgIndex);
					
					// Pre-calculate data needed for components (avoiding dictionary lookups in render loop logic where possible)
					MessageFeedbackInfo? feedback = messageId.HasValue && _messageFeedback.TryGetValue(messageId.Value, out var fb) ? fb : null;
					List<MessageToolCallInfo>? toolCalls = messageId.HasValue && _messageToolCalls.TryGetValue(messageId.Value, out var tc) ? tc : null;
					List<MessageEvaluationMetricResponse>? metrics = messageId.HasValue && _messageMetrics.TryGetValue(messageId.Value, out var met) ? met : null;
                    int? sentiment = messageId.HasValue && _messageSentiment.TryGetValue(messageId.Value, out var s) ? s : null;

					List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
					@foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
					{
						bool isFirstParagraph = index == 0;
						bool isLastParagraph = index == paragraphs.Count - 1;
						
						@if (m.Role == ChatRole.User)
						{
						    <UserChatMessage 
						        Text="@paragraph" 
						        IsFirstParagraph="@isFirstParagraph"
						        IsLastParagraph="@isLastParagraph"
						        MessageId="@messageId"
                                Sentiment="@sentiment" />
						}
						else
						{
							@if (!string.IsNullOrWhiteSpace(paragraph))
							{
							    <AssistantChatMessage
							        Text="@paragraph"
							        MessageId="@messageId"
							        IsFirstParagraph="@isFirstParagraph"
							        IsLastParagraph="@isLastParagraph"
							        ToolCalls="@toolCalls"
                                    Metrics="@metrics"
							        Feedback="@feedback"
							        OnToolCallsClick="@OnToolCallClicked"
							        OnFeedbackClick="@OnFeedbackClicked"
							        ReadOnly="false" />
							}
						}
					}
				}

				@if (_isSending)
				{
					<MudChat ChatPosition="ChatBubblePosition.Start"
					         Variant="Variant.Filled"
					         Color="Color.Default">
						<MudChatHeader Name="Game Master"/>
						<MudChatBubble>
							<div class="typing-indicator">
								<span></span>
								<span></span>
								<span></span>
							</div>
						</MudChatBubble>
					</MudChat>
				}
			</div>

			<div class="message-bar">
				<MudGrid Class="align-items-center">
					<MudItem xs="10" sm="11">
						<MudTextField @bind-Value="_userMessage.Text" Label="Message" Placeholder="Type a message..."
						              FullWidth="true" Immediate="true" OnKeyDown="OnKeyDown"/>
					</MudItem>
					<MudItem xs="2" sm="1" Class="d-flex justify-end">
						<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessageAsync">
							Send
						</MudButton>
					</MudItem>
				</MudGrid>
			</div>
		}
	</MudContainer>
</div>

@code {
    private async Task OnToolCallClicked(int messageId)
    {
        await ShowToolCallsDialogAsync(messageId);
    }
    
    private async Task OnFeedbackClicked((int MessageId, bool IsPositive) args)
    {
        await ShowFeedbackDialogAsync(args.MessageId, args.IsPositive);
    }
}

