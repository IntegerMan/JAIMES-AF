@page "/games/{GameId:guid}"

@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers

@rendermode InteractiveServer

<PageTitle>Game Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="game-details-wrapper">
	<MudText Typo="Typo.h5" Class="mb-2">Game details</MudText>

	@if (isLoading)
	{
		<MudProgressCircular Indeterminate="true" Class="my-4" />
	}
	else if (!string.IsNullOrEmpty(errorMessage))
	{
		<MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
	}
	else if (game is null)
	{
		<MudText>(No game loaded)</MudText>
	}
	else
	{
		<MudText Class="mb-1"><b>Game ID:</b> @game.GameId</MudText>
		<MudDivider Class="my-2" />

		<div id="chat-scroll-container" class="chat-scroll">
			@foreach (var m in messages ?? [])
			{
				var paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
				@foreach (var (paragraph, index) in paragraphs.Select((p, i) => (p, i)))
				{
					var isFirstParagraph = index == 0;
					@if (m.Participant == ChatParticipant.Player)
					{
						<MudChat ChatPosition="ChatBubblePosition.End"
								 Variant="Variant.Filled"
								 Color="Color.Primary">
							@if (isFirstParagraph)
							{
								<MudChatHeader Name="@m.ParticipantName" />
							}
							<MudChatBubble>
								@paragraph
							</MudChatBubble>
						</MudChat>
					}
					else
					{
						<MudChat ChatPosition="ChatBubblePosition.Start"
								 Variant="Variant.Filled"
								 Color="Color.Default">
							@if (isFirstParagraph)
							{
								<MudChatHeader Name="@m.ParticipantName" />
							}
							<MudChatBubble>
								@((MarkupString)ChatHelpers.RenderMarkdown(paragraph))
							</MudChatBubble>
						</MudChat>
					}
				}
			}
			
			@if (isSending)
			{
				<MudChat ChatPosition="ChatBubblePosition.Start"
						 Variant="Variant.Filled"
						 Color="Color.Default">
					<MudChatHeader Name="@GetGameMasterName()" />
					<MudChatBubble>
						<div class="typing-indicator">
							<span></span>
							<span></span>
							<span></span>
						</div>
					</MudChatBubble>
				</MudChat>
			}
		</div>

		<div class="message-bar">
			<MudGrid Class="align-items-center">
				<MudItem xs="10" sm="11">
					<MudTextField @bind-Value="userMessage.Text" Label="Message" Placeholder="Type a message..." FullWidth="true" Immediate="true" OnKeyDown="OnKeyDown" />
				</MudItem>
				<MudItem xs="2" sm="1" Class="d-flex justify-end">
					<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessageAsync">Send</MudButton>
				</MudItem>
			</MudGrid>
		</div>
	}
</MudContainer>