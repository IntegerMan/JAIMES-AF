@page "/games/{GameId:guid}"
@using MattEland.Jaimes.Web.Components.Helpers
@using Microsoft.Extensions.AI
@using MudBlazor
@using MattEland.Jaimes.Web.Components.Chat

@rendermode InteractiveServer

<PageTitle>Game Details</PageTitle>

<div class="game-details-page-wrapper">
	<MudContainer MaxWidth="MaxWidth.Large" Class="game-details-wrapper">
		<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
			<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
		</MudStack>
		@if (_isLoading)
		{
			<MudProgressCircular Indeterminate="true" Class="my-4"/>
		}
		else if (!string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}
		else if (_game is null)
		{
			<MudText>(No game loaded)</MudText>
		}
		else
		{
			if (_game != null) UpdateBreadcrumbs(_game.Title ?? $"{_game.PlayerName} in {_game.ScenarioName}");
			<div class="game-header">
				@if (_isEditingTitle)
				{
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="width: 100%;">
						<MudTextField @bind-Value="_editableTitle"
						              Variant="Variant.Outlined"
						              Margin="Margin.Dense"
						              FullWidth="true"
						              Immediate="true"
						              Placeholder="Enter game title"
						              Style="flex-grow: 1;"/>
						<MudIconButton Icon="@Icons.Material.Filled.Check"
						               Color="Color.Success"
						               Size="Size.Small"
						               Disabled="@_isSavingTitle"
						               OnClick="SaveTitleAndExitEditModeAsync"/>
						<MudIconButton Icon="@Icons.Material.Filled.Close"
						               Color="Color.Error"
						               Size="Size.Small"
						               OnClick="CancelTitleEdit"/>
					</MudStack>
				}
				else
				{
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
						<MudText Typo="Typo.h5">@(_game!.Title ?? $"{_game.PlayerName} in {_game.ScenarioName}")</MudText>
						<MudIconButton Icon="@Icons.Material.Filled.Edit"
						               Size="Size.Small"
						               Color="Color.Default"
						               OnClick="EnterTitleEditMode"/>
					</MudStack>
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						@if (_availableAgents.Count > 1)
						{
							<MudSelect T="string" Label="Agent" Value="@_selectedAgentId" ValueChanged="OnAgentChanged" 
									  Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 200px;" Dense="true"
									  Disabled="_isChangingAgent">
								@foreach (var agent in _availableAgents)
								{
									<MudSelectItem Value="@agent.Id">@agent.Name</MudSelectItem>
								}
							</MudSelect>
						}
						else if (_availableAgents.Count == 1)
						{
							<MudStack Spacing="0">
								<MudText Typo="Typo.caption" Color="Color.Primary">Agent</MudText>
								<MudText Typo="Typo.body1" Class="mr-2">@_availableAgents[0].Name</MudText>
							</MudStack>
						}
						
						@if (_availableVersions.Any())
						{
							<MudSelect T="int?" Label="Version" Value="@_selectedVersionId" ValueChanged="OnVersionChanged"
									  Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 120px;" Dense="true"
									  Disabled="_isChangingAgent">
								<MudSelectItem T="int?" Value="@(null)">
									<div class="d-flex align-center">
										Latest (Dynamic)
										<MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text" Class="ml-2">Auto-Update</MudChip>
									</div>
								</MudSelectItem>
								@foreach (var version in _availableVersions)
								{
									<MudSelectItem T="int?" Value="@version.Id">
										@version.VersionNumber
										@if (version.IsActive)
										{
											<MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text" Class="ml-2">Latest</MudChip>
										}
									</MudSelectItem>
								}
							</MudSelect>
						}
					</MudStack>
				}
			</div>

			<div id="chat-scroll-container" class="chat-scroll">
				@for (int msgIndex = 0; msgIndex < (_messages?.Count ?? 0); msgIndex++)
				{
					var m = _messages![msgIndex];
					int capturedIndex = msgIndex; // Capture for lambda closure structure					// Calculate agent info and version switch logic
					string? agentId = null;
					string? agentName = null;
					int? instructionVersionId = null;
					string? versionNumber = null;
					bool isVersionSwitch = false;
					bool isExempt = false;
					int? messageId = GetMessageId(msgIndex);
					bool isStreaming = _streamingMessageIndexes.Contains(msgIndex);

					MessageAgentInfo? agentInfo = null;
					if (messageId.HasValue)
						_messageAgentInfo.TryGetValue(messageId.Value, out agentInfo);

					// Only show agent info for completed (non-streaming) messages
					if (m.Role == ChatRole.Assistant && agentInfo != null && !isStreaming)
					{
						agentId = agentInfo.AgentId;
						agentName = agentInfo.AgentName;
						instructionVersionId = agentInfo.InstructionVersionId;
						versionNumber = agentInfo.VersionNumber ?? "1"; // Default to v1 if unknown
						isExempt = agentInfo.IsScriptedMessage;

						// Check previous assistant message for version switch
						// Find the last assistant message before this one
						bool foundPrevNonScripted = false;
						for (int i = msgIndex - 1; i >= 0; i--)
						{
							var prevMsg = _messages[i];
							int? prevMsgId = GetMessageId(i);

							MessageAgentInfo? prevAgentInfo = null;
							if (prevMsgId.HasValue) _messageAgentInfo.TryGetValue(prevMsgId.Value, out prevAgentInfo);

							if (prevMsg.Role == ChatRole.Assistant && prevAgentInfo != null)
							{
								// Skip scripted messages when looking for a version comparison
								if (prevAgentInfo.IsScriptedMessage) continue;

								foundPrevNonScripted = true;

								// detected a switch if agent ID changed OR version ID changed
								if (prevAgentInfo.AgentId != agentId ||
								    prevAgentInfo.InstructionVersionId != instructionVersionId)
								{
									isVersionSwitch = true;
								}

								break;
							}
						}

						// If this is the VERY first NON-SCRIPTED assistant message, treat it as a "switch" (start)
						if (!isVersionSwitch && !foundPrevNonScripted)
						{
							isVersionSwitch = true;
						}
					}

					// Skip empty messages
					if (string.IsNullOrWhiteSpace(m.Text))
					{
						continue;
					}

					// Pre-calculate data needed for components (avoiding dictionary lookups in render loop logic where possible)
					MessageFeedbackResponse? feedback = messageId.HasValue && _messageFeedback.TryGetValue(messageId.Value, out var fb) ? fb : null;
					List<MessageToolCallResponse>? toolCalls = messageId.HasValue && _messageToolCalls.TryGetValue(messageId.Value, out var tc) ? tc : null;
					List<MessageEvaluationMetricResponse>? metrics = messageId.HasValue && _messageMetrics.TryGetValue(messageId.Value, out var met) ? met : null;
					MessageSentimentInfo? sentimentInfo = messageId.HasValue && _messageSentiment.TryGetValue(messageId.Value, out var si) ? si : null;

					List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
					@foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
					{
						bool isFirstParagraph = index == 0;
						bool isLastParagraph = index == paragraphs.Count - 1;

						@if (m.Role == ChatRole.User)
						{
							<UserChatMessage
								Text="@paragraph"
								IsFirstParagraph="@isFirstParagraph"
								IsLastParagraph="@isLastParagraph"
								MessageId="@messageId"
								Sentiment="@sentimentInfo?.Sentiment"
								Confidence="@sentimentInfo?.Confidence"
								SentimentSource="@sentimentInfo?.SentimentSource"
								SentimentId="@sentimentInfo?.SentimentId"
								IsTestCase="@(messageId.HasValue && _messageTestCases.ContainsKey(messageId.Value))"
								TestCaseId="@(messageId.HasValue && _messageTestCases.TryGetValue(messageId.Value, out var tcId) ? tcId : null)"/>
						}
						else
						{
							@if (!string.IsNullOrWhiteSpace(paragraph))
							{
								<AssistantChatMessage
									Text="@paragraph"
									MessageId="@messageId"
									IsFirstParagraph="@isFirstParagraph"
									IsLastParagraph="@isLastParagraph"
									ToolCalls="@toolCalls"
									Metrics="@metrics"
									Feedback="@feedback"
									OnToolCallsClick="@OnToolCallClicked"
									OnFeedbackClick="@OnFeedbackClicked"
									OnMetricsClick="@OnMetricsClicked"
									ReadOnly="false"
									AgentId="@agentId"
									AgentName="@agentName"
									InstructionVersionId="@instructionVersionId"
									VersionNumber="@versionNumber"
									IsVersionSwitch="@isVersionSwitch"
									ExemptFromProcessing="@isExempt"
									IsScriptedMessage="@isExempt"
									HasMissingEvaluators="@(messageId.HasValue && _messageHasMissingEvaluators.TryGetValue(messageId.Value, out var hasM) && hasM)"
									IsProcessing="@(!messageId.HasValue || !_loadedMetricsMessageIds.Contains(messageId.Value))"
									IsStreaming="@isStreaming"
									ExpectedMetricCount="@(messageId.HasValue && _messageExpectedMetricCount.TryGetValue(messageId.Value, out var expCount) ? expCount : null)"
									ErrorsByMetric="@(messageId.HasValue && _messageMetricErrors.TryGetValue(messageId.Value, out var errors) ? errors : null)"/>
							}
						}
					}

					@if (_failedMessageIndex == msgIndex && !string.IsNullOrEmpty(_errorMessage))
					{
						<MudChat ChatPosition="ChatBubblePosition.End">
							<MudChatBubble Color="Color.Error">
								<MudIcon Icon="@Icons.Material.Filled.Error" Class="mr-2" Size="Size.Small"/>
								@_errorMessage
								<MudButton Size="Size.Small" Color="Color.Inherit" OnClick="@(() => RetryMessageAsync(capturedIndex))" Variant="Variant.Text">
									Retry
								</MudButton>
							</MudChatBubble>
						</MudChat>
					}
				}

				@if (_isSending)
				{
					<MudChat ChatPosition="ChatBubblePosition.Start"
					         Variant="Variant.Filled"
					         Color="Color.Default">
						<MudChatHeader Name="Game Master"/>
						<MudChatBubble>
							<div class="typing-indicator">
								<span></span>
								<span></span>
								<span></span>
							</div>
						</MudChatBubble>
					</MudChat>
				}
			</div>

			<div class="message-bar">
				<MudGrid Class="align-items-center">
					<MudItem xs="10" sm="11">
						<MudTextField @key="_chatInputKey" @ref="_chatInput" @bind-Value="_userMessageText" Label="Message" Placeholder="Type a message..."
						              FullWidth="true" Immediate="true" TextUpdateSuppression="false" OnKeyDown="OnKeyDown"/>
					</MudItem>
					<MudItem xs="2" sm="1" Class="d-flex justify-end">
						<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessageAsync">
							Send
						</MudButton>
					</MudItem>
				</MudGrid>
			</div>
		}
	</MudContainer>
</div>

@code {

	private void OnToolCallClicked(int messageId)
	{
		if (_messageToolCalls.TryGetValue(messageId, out List<MessageToolCallResponse>? toolCalls) &&
		    toolCalls != null &&
		    toolCalls.Count > 0)
		{
			NavigationManager.NavigateTo($"/admin/tool-calls/{toolCalls[0].Id}");
		}
	}

	private async Task OnFeedbackClicked((int MessageId, bool IsPositive) args)
	{
		await ShowFeedbackDialogAsync(args.MessageId, args.IsPositive);
	}

	private void OnMetricsClicked(int messageId)
	{
		ShowMetricsDialogAsync(messageId);
	}

	private List<BreadcrumbItem> _breadcrumbs = new();

	protected override async Task OnInitializedAsync()
	{
		// Initial breadcrumb state
		UpdateBreadcrumbs("Game Details");
		await base.OnInitializedAsync();
	}

	// Helper to update breadcrumbs
	private void UpdateBreadcrumbs(string gameName)
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Games", href: "/games"),
			new BreadcrumbItem(gameName, href: null, disabled: true)
		};
	}

}

