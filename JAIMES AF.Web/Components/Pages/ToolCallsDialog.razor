@using MudBlazor
@using System.Text.Json
@using MattEland.Jaimes.Web.Components.Pages

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-4">This message used @(_toolCalls?.Count ?? 0) tool call(s).</MudText>

        @if (_toolCalls != null && _toolCalls.Count > 0)
        {
            @foreach (var toolCall in _toolCalls)
            {
                <MudExpansionPanels Class="mt-2">
                    <MudExpansionPanel>
                        <TitleContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                                <MudText Typo="Typo.body1">@toolCall.ToolName</MudText>
                                <MudTooltip Text="View all calls for this tool">
                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   Href="@($"/admin/tools/{Uri.EscapeDataString(toolCall.ToolName)}")"
                                                   Target="_blank" />
                                </MudTooltip>
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                            <div class="tool-call-details">
                                <MudText Typo="Typo.subtitle2" Class="mt-2 mb-1">Input:</MudText>
                                <MudPaper Elevation="1" Class="pa-2 mb-3">
                                    <MudText Typo="Typo.body2" Class="font-family-monospace" Style="white-space: pre-wrap; font-size: 0.875rem;">
                                        @FormatJson(toolCall.InputJson)
                                    </MudText>
                                </MudPaper>

                                <MudText Typo="Typo.subtitle2" Class="mt-2 mb-1">Output:</MudText>
                                <MudPaper Elevation="1" Class="pa-2">
                                    <MudText Typo="Typo.body2" Class="font-family-monospace" Style="white-space: pre-wrap; font-size: 0.875rem;">
                                        @FormatJson(toolCall.OutputJson)
                                    </MudText>
                                </MudPaper>
                            </div>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<MessageToolCallInfo>? ToolCalls { get; set; }

    private List<MessageToolCallInfo>? _toolCalls;

    protected override void OnParametersSet()
    {
        _toolCalls = ToolCalls;
    }

    private void Cancel() => MudDialog.Cancel();

    private string FormatJson(string? json)
    {
        if (string.IsNullOrWhiteSpace(json))
        {
            return "(empty)";
        }

        try
        {
            using JsonDocument doc = JsonDocument.Parse(json);
            return JsonSerializer.Serialize(doc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            // If it's not valid JSON, return as-is
            return json;
        }
    }

}

<style>
    .tool-call-details {
        padding: 8px 0;
    }
    
    .font-family-monospace {
        font-family: 'Courier New', monospace;
    }
</style>

