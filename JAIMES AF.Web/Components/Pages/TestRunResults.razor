@page "/admin/test-runs/{ExecutionName}"
@rendermode InteractiveServer

@using MattEland.Jaimes.ServiceDefinitions.Responses
@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject NavigationManager NavigationManager

<PageTitle>Test Run Results</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    @if (_isLoading)
    {
        <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
            <MudProgressCircular Indeterminate="true"/>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else if (_runs is not null && _runs.Count > 0)
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudStack>
                <MudText Typo="Typo.h4">Test Run Results</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">Execution: @ExecutionName</MudText>
            </MudStack>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Visibility"
                           OnClick="ViewReport">
                    View Report
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="DownloadReport">
                    Download Report
                </MudButton>
            </MudStack>
        </MudStack>

        @* Summary Stats *@
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudStack Row="true" Spacing="6" Justify="Justify.Center">
                <MudStack AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h4" Color="Color.Primary">@_runs.Count</MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">Test Cases</MudText>
                </MudStack>
                <MudStack AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h4" Color="Color.Success">@_avgDuration.ToString("F0")ms</MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">Avg Duration</MudText>
                </MudStack>
                <MudStack AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h4" Color="Color.Info">@_avgScore.ToString("F2")</MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">Avg Score</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>

        @* Results Table *@
        <MudTable Items="_runs" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Test Case</MudTh>
                <MudTh>Response Preview</MudTh>
                <MudTh Style="text-align: center">Duration</MudTh>
                <MudTh Style="text-align: center">Scores</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudLink Href="@($"/admin/test-cases/{context.TestCaseId}")">
                        @(context.TestCaseName ?? $"Test Case {context.TestCaseId}")
                    </MudLink>
                </MudTd>
                <MudTd Style="max-width: 400px;">
                    <MudTooltip Text="@context.GeneratedResponse" Placement="Placement.Top">
                        <MudText Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @TruncateText(context.GeneratedResponse, 80)
                        </MudText>
                    </MudTooltip>
                </MudTd>
                <MudTd Style="text-align: center">
                    @if (context.DurationMs.HasValue)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.DurationMs ms</MudChip>
                    }
                    else
                    {
                        <MudText Class="text-muted">-</MudText>
                    }
                </MudTd>
                <MudTd Style="text-align: center">
                    @if (context.Metrics?.Any() == true)
                    {
                        @foreach (var metric in context.Metrics.Take(3))
                        {
                            <MudTooltip Text="@($"{metric.MetricName}: {metric.Score:F2}")" Placement="Placement.Top">
                                <MudChip T="string" Size="Size.Small" Color="@GetScoreColor(metric.Score)" Class="mr-1">
                                    @metric.Score.ToString("F1")
                                </MudChip>
                            </MudTooltip>
                        }
                        @if (context.Metrics.Count > 3)
                        {
                            <MudText Typo="Typo.caption" Class="text-muted">+@(context.Metrics.Count - 3)</MudText>
                        }
                    }
                    else
                    {
                        <MudText Class="text-muted">-</MudText>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        @* Report iframe dialog *@
        <MudDialog @bind-Visible="_showReportDialog" Options="_reportDialogOptions">
            <TitleContent>
                <MudText Typo="Typo.h6">Test Report</MudText>
            </TitleContent>
            <DialogContent>
                <iframe src="@_reportUrl" style="width: 100%; height: 70vh; border: none;"></iframe>
            </DialogContent>
            <DialogActions>
                <MudButton Color="Color.Primary" OnClick="DownloadReport">Download</MudButton>
                <MudButton Color="Color.Default" OnClick="@(() => _showReportDialog = false)">Close</MudButton>
            </DialogActions>
        </MudDialog>
    }
    else
    {
        <MudAlert Severity="Severity.Info">No test runs found for this execution.</MudAlert>
    }
</MudPaper>

@code {
    [Parameter] public string ExecutionName { get; set; } = "";

    private List<TestCaseRunResponse>? _runs;
    private bool _isLoading = true;
    private string? _errorMessage;
    private double _avgDuration;
    private double _avgScore;
    private bool _showReportDialog;
    private string? _reportUrl;
    
    private DialogOptions _reportDialogOptions = new()
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true
    };

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Admin", href: "/admin"),
        new BreadcrumbItem("Test Cases", href: "/admin/test-cases"),
        new BreadcrumbItem("Test Run", href: null, disabled: true)
    };

    protected override async Task OnParametersSetAsync()
    {
        await LoadResultsAsync();
    }

    private async Task LoadResultsAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            _runs = await Http.GetFromJsonAsync<List<TestCaseRunResponse>>($"/test-case-runs?executionName={Uri.EscapeDataString(ExecutionName)}");
            
            if (_runs != null && _runs.Count > 0)
            {
                _avgDuration = _runs.Where(r => r.DurationMs.HasValue).Select(r => r.DurationMs!.Value).DefaultIfEmpty(0).Average();
                var allMetrics = _runs.SelectMany(r => r.Metrics ?? []).ToList();
                _avgScore = allMetrics.Any() ? allMetrics.Average(m => m.Score) : 0;
            }
        }
        catch (Exception ex)
        {
            LoggerFactory.CreateLogger("TestRunResults").LogError(ex, "Failed to load test run results");
            _errorMessage = "Failed to load test run results: " + ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ViewReport()
    {
        _reportUrl = $"/test-case-runs/{Uri.EscapeDataString(ExecutionName)}/report";
        _showReportDialog = true;
    }

    private void DownloadReport()
    {
        NavigationManager.NavigateTo($"/test-case-runs/{Uri.EscapeDataString(ExecutionName)}/report/download", forceLoad: true);
    }

    private static string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    private static Color GetScoreColor(double score)
    {
        return score switch
        {
            >= 0.7 => Color.Success,
            >= 0.4 => Color.Warning,
            _ => Color.Error
        };
    }
}
