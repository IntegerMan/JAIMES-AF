@page "/admin/test-runs/{ExecutionName}"
@rendermode InteractiveServer

@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@inject HttpClient Http
@inject ILoggerFactory LoggerFactory
@inject NavigationManager NavigationManager
@using MattEland.Jaimes.Web.Components.Helpers

<PageTitle>Test Run Results</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_isLoading)
    {
        <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
            <MudProgressCircular Indeterminate="true"/>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else if (_runs is not null && _runs.Count > 0)
    {
        <CompactHeroSection Title="Test Run Results"
                            Icon="@Icons.Material.Filled.Assessment"
                            Theme="CompactHeroSection.HeroTheme.Info"
                            Subtitle="@($"Execution: {ExecutionName}")"
                            ActionText="View Report"
                            ActionIcon="@Icons.Material.Filled.Visibility"
                            OnActionClick="ViewReport" />

        <MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="mb-4"></MudBreadcrumbs>

        @* Summary Stats using MetricCard *@
        <MudGrid Spacing="3" Class="mb-4">
            <MudItem xs="12" sm="4">
                <MetricCard Icon="@Icons.Material.Filled.Science"
                            Value="@_runs.Count.ToString()"
                            Label="Test Cases"
                            ColorVariant="MetricCard.MetricColorVariant.Info" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MetricCard Icon="@Icons.Material.Filled.Timer"
                            Value="@($"{_avgDuration:F0}ms")"
                            Label="Avg Duration"
                            ColorVariant="MetricCard.MetricColorVariant.Success" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MetricCard Icon="@Icons.Material.Filled.Score"
                            Value="@_avgScore.ToString("F2")"
                            Label="Avg Score"
                            ColorVariant="@GetScoreColorVariant(_avgScore)" />
            </MudItem>
        </MudGrid>

        @* Action Buttons *@
        <MudStack Row="true" Spacing="2" Class="mb-4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="DownloadReport">
                Download Report
            </MudButton>
        </MudStack>

        @* Results Table *@
        <MudTable Items="_runs" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Test Case</MudTh>
                <MudTh>Response Preview</MudTh>
                <MudTh Style="text-align: center">Duration</MudTh>
                <MudTh Style="text-align: center">Scores</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudLink Href="@($"/admin/test-cases/{context.TestCaseId}")">
                        @(context.TestCaseName ?? $"Test Case {context.TestCaseId}")
                    </MudLink>
                </MudTd>
                <MudTd Style="max-width: 400px;">
                    <MudTooltip Text="@context.GeneratedResponse" Placement="Placement.Top">
                        <MudText Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @TruncateText(context.GeneratedResponse, 80)
                        </MudText>
                    </MudTooltip>
                </MudTd>
                <MudTd Style="text-align: center">
                    @if (context.DurationMs.HasValue)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.DurationMs ms</MudChip>
                    }
                    else
                    {
                        <MudText Class="text-muted">-</MudText>
                    }
                </MudTd>
                <MudTd Style="text-align: center">
                    @if (context.Metrics?.Any() == true)
                    {
                        @foreach (var metric in context.Metrics.Take(3))
                        {
                            <MudTooltip Text="@($"{metric.MetricName}: {metric.Score:F2}")" Placement="Placement.Top">
                                <MudChip T="string" Size="Size.Small" Color="@MetricColorHelper.GetScoreColor(metric.Score)" Class="mr-1">
                                    @metric.Score.ToString("F1")
                                </MudChip>
                            </MudTooltip>
                        }
                        @if (context.Metrics.Count > 3)
                        {
                            <MudText Typo="Typo.caption" Class="text-muted">+@(context.Metrics.Count - 3)</MudText>
                        }
                    }
                    else
                    {
                        <MudText Class="text-muted">-</MudText>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        @* Report iframe dialog *@
        <MudDialog @bind-Visible="_showReportDialog" Options="_reportDialogOptions">
            <TitleContent>
                <MudText Typo="Typo.h6">Test Report</MudText>
            </TitleContent>
            <DialogContent>
                <iframe src="@_reportUrl" style="width: 100%; height: 70vh; border: none;"></iframe>
            </DialogContent>
            <DialogActions>
                <MudButton Color="Color.Primary" OnClick="DownloadReport">Download</MudButton>
                <MudButton Color="Color.Default" OnClick="@(() => _showReportDialog = false)">Close</MudButton>
            </DialogActions>
        </MudDialog>
    }
    else
    {
        <CompactHeroSection Title="Test Run Results"
                            Icon="@Icons.Material.Filled.Assessment"
                            Theme="CompactHeroSection.HeroTheme.Info"
                            Subtitle="@($"Execution: {ExecutionName}")" />
        
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="mb-4"></MudBreadcrumbs>
        
        <MudAlert Severity="Severity.Info">No test runs found for this execution.</MudAlert>
    }
</MudContainer>

@code {
    [Parameter] public string ExecutionName { get; set; } = "";

    private List<TestCaseRunResponse>? _runs;
    private bool _isLoading = true;
    private string? _errorMessage;
    private double _avgDuration;
    private double _avgScore;
    private bool _showReportDialog;
    private string? _reportUrl;
    
    private DialogOptions _reportDialogOptions = new()
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true
    };

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Admin", href: "/admin"),
        new BreadcrumbItem("Test Cases", href: "/admin/test-cases"),
        new BreadcrumbItem("Test Run", href: null, disabled: true)
    };

    protected override async Task OnParametersSetAsync()
    {
        await LoadResultsAsync();
    }

    private async Task LoadResultsAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            _runs = await Http.GetFromJsonAsync<List<TestCaseRunResponse>>($"/test-case-runs?executionName={Uri.EscapeDataString(ExecutionName)}");
            
            if (_runs != null && _runs.Count > 0)
            {
                _avgDuration = _runs.Where(r => r.DurationMs.HasValue).Select(r => r.DurationMs!.Value).DefaultIfEmpty(0).Average();
                var allMetrics = _runs.SelectMany(r => r.Metrics ?? []).ToList();
                _avgScore = allMetrics.Any() ? allMetrics.Average(m => m.Score) : 0;
            }
        }
        catch (Exception ex)
        {
            LoggerFactory.CreateLogger("TestRunResults").LogError(ex, "Failed to load test run results");
            _errorMessage = "Failed to load test run results: " + ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ViewReport()
    {
        _reportUrl = $"/test-case-runs/{Uri.EscapeDataString(ExecutionName)}/report";
        _showReportDialog = true;
    }

    private void DownloadReport()
    {
        NavigationManager.NavigateTo($"/test-case-runs/{Uri.EscapeDataString(ExecutionName)}/report/download", forceLoad: true);
    }

    private static string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    private static MetricCard.MetricColorVariant GetScoreColorVariant(double score) => score switch
    {
        >= 0.8 => MetricCard.MetricColorVariant.Success,
        >= 0.5 => MetricCard.MetricColorVariant.Warning,
        _ => MetricCard.MetricColorVariant.Error
    };
}
