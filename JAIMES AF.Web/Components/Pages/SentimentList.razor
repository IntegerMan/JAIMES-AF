@page "/admin/sentiments"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject IDialogService DialogService
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Sentiment Analysis</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>
    <MudText Typo="Typo.h4" Class="mb-2">Sentiment Analysis</MudText>
    <MudText Typo="Typo.body2" Class="mb-4 text-muted">
        View and manage user message sentiment analysis results.
    </MudText>

    <AdminFilters GameId="@GameId"
                  ToolName="@ToolName"
                  AgentVersion="@AgentVersion"
                  Sentiment="@Sentiment"
                  HasFeedback="@HasFeedback"
                  OnClearFilters="ClearFilters" />

    <MudDataGrid T="SentimentListItemDto"
                 ServerData="ServerReload"
                 Filterable="false"
                 Hover="true"
                 Dense="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.CreatedAt" Title="Created">
                <CellTemplate>
                    @context.Item.CreatedAt.ToLocalTime().ToString("g")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.MessagePreview" Title="Message">
                <CellTemplate>
                    <MudLink Href="@($"/admin/sentiments/{context.Item.Id}")" Typo="Typo.body2" Underline="Underline.Hover">
                        @(TruncateMessage(context.Item.MessagePreview, 70))
                    </MudLink>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Sentiment" Title="Sentiment" Sortable="false">
                <CellTemplate>
                    <SentimentIcon Sentiment="@context.Item.Sentiment"
                                   SentimentSource="@context.Item.SentimentSource"
                                   Confidence="@context.Item.Confidence"
                                   MessageId="@context.Item.MessageId"
                                   SentimentId="@context.Item.Id"
                                   IsAdminContext="true"
                                   ShowViewDetails="true"
                                   OnSentimentChanged="@(() => InvokeAsync(StateHasChanged))" />
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Confidence" Title="Confidence">
                <CellTemplate>
                    @if (context.Item.Confidence.HasValue)
                    {
                        <MudText Typo="Typo.body2">@((context.Item.Confidence.Value * 100).ToString("F0"))%</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">N/A</MudText>
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.UpdatedAt" Title="Modified">
                <CellTemplate>
                    @context.Item.UpdatedAt.ToLocalTime().ToString("g")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.SentimentSource" Title="Source" Sortable="false">
                <CellTemplate>
                    @{
                        var (label, color) = context.Item.SentimentSource switch
                        {
                            0 => ("Model", Color.Info),
                            1 => ("Player", Color.Secondary),
                            2 => ("Admin", Color.Primary),
                            _ => ("Unknown", Color.Default)
                        };
                    }
                    <MudChip T="string" Color="@color" Size="Size.Small">@label</MudChip>
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Prior Message Feedback">
                <CellTemplate>
                    @if (context.Item.HasFeedback)
                    {
                        @if (context.Item.FeedbackIsPositive == true)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" Size="Size.Small" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" Size="Size.Small" />
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">-</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.GamePlayerName" Title="Player" />
            <PropertyColumn Property="x => x.GameScenarioName" Title="Scenario" />
            <PropertyColumn Property="x => x.AgentVersion" Title="Agent Version">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.AgentId) && !string.IsNullOrEmpty(context.Item.AgentVersion))
                    {
                        <MudLink Href="@($"/agents/{context.Item.AgentId}/instruction-versions")" Typo="Typo.body2">
                            @context.Item.AgentVersion
                        </MudLink>
                    }
                    else if (!string.IsNullOrEmpty(context.Item.AgentVersion))
                    {
                        @context.Item.AgentVersion
                    }
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Actions">
                <CellTemplate>
                    <div class="d-flex">
                        <MudTooltip Text="View Details" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           Href="@($"/admin/sentiments/{context.Item.Id}")" />
                        </MudTooltip>
                        @if (context.Item.GameId != Guid.Empty)
                        {
                            <MudTooltip Text="View Game" Placement="Placement.Top">
                                <MudIconButton Icon="@Icons.Material.Filled.Games" 
                                               Color="Color.Secondary" 
                                               Size="Size.Small"
                                               Href="@($"/games/{context.Item.GameId}")" />
                            </MudTooltip>
                        }
                    </div>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="SentimentListItemDto" />
        </PagerContent>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Class="pa-4">
                No sentiment records found. Sentiment analysis will appear here after user messages are processed.
            </MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? GameId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? ToolName { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? AgentVersion { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public int? Sentiment { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public bool? HasFeedback { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override void OnInitialized()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Sentiments", href: null, disabled: true)
        };
    }

    private string TruncateMessage(string? message, int maxLength)
    {
        if (string.IsNullOrEmpty(message)) return "(No message)";
        if (message.Length <= maxLength) return message;
        return message[..maxLength] + "...";
    }

    private async Task<GridData<SentimentListItemDto>> ServerReload(GridState<SentimentListItemDto> state)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");

            int page = state.Page + 1;
            int pageSize = state.PageSize;

            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (GameId.HasValue)
                queryParams.Add($"gameId={GameId.Value}");
            if (!string.IsNullOrEmpty(ToolName))
                queryParams.Add($"toolName={Uri.EscapeDataString(ToolName)}");
            if (!string.IsNullOrEmpty(AgentVersion))
                queryParams.Add($"agentId={Uri.EscapeDataString(AgentVersion)}");
            if (Sentiment.HasValue)
                queryParams.Add($"sentiment={Sentiment.Value}");
            if (HasFeedback.HasValue)
                queryParams.Add($"hasFeedback={HasFeedback.Value.ToString().ToLower()}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<SentimentListResponse>($"/admin/sentiments?{queryString}");

            if (response != null)
            {
                return new GridData<SentimentListItemDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sentiments: {ex.Message}", Severity.Error);
        }

        return new GridData<SentimentListItemDto>
        {
            TotalItems = 0,
            Items = []
        };
    }

    private void ClearFilters()
    {
        NavigationManager.NavigateTo("/admin/sentiments");
    }
}
