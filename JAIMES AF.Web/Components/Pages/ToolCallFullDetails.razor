@page "/admin/tool-calls/{Id:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Chat
@using System.Text.Json
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Tool Call Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" Class="d-block mx-auto mt-4" />
    }
    else if (_toolCall == null)
    {
        <MudAlert Severity="Severity.Error">Tool call not found.</MudAlert>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudText Typo="Typo.h4">Tool Call: @_toolCall.ToolName</MudText>
            @if (_toolCall.GameId.HasValue)
            {
                <MudButton StartIcon="@Icons.Material.Filled.VideogameAsset" 
                           Color="Color.Secondary" 
                           Href="@($"/games/{_toolCall.GameId}")" 
                           Target="_blank">
                    View Game
                </MudButton>
            }
        </MudStack>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-3">Tool Invocations</MudText>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 8px;">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6" Class="mb-1">Input Payload</MudText>
                        <MudPaper Class="pa-3" Elevation="2">
                            <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.875rem;">@FormatJson(_toolCall.InputJson)</pre>
                        </MudPaper>

                        <MudText Typo="Typo.h6" Class="mt-4 mb-2">Output Result</MudText>
                        <MudPaper Class="pa-3" Elevation="2">
                            <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.875rem;">@FormatJson(_toolCall.OutputJson)</pre>
                        </MudPaper>
                    </MudStack>
                </div>
            </MudItem>
            
            <MudItem xs="12" md="6">
                 <MudText Typo="Typo.h6" Class="mb-3">Conversation Context</MudText>
                 <ReadOnlyConversation MessageId="@_toolCall.MessageId" ContextCount="5" />
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private ToolCallFullDetailResponse? _toolCall;
    private bool _loading = true;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Tool Usage", href: "/admin/tools"),
            new BreadcrumbItem($"Tool Call {Id}", href: null, disabled: true)
        };

        try {
            var client = HttpClientFactory.CreateClient("Api");
            _toolCall = await client.GetFromJsonAsync<ToolCallFullDetailResponse>($"/admin/tool-calls/{Id}");
            if (_toolCall != null)
            {
                 // Update breadcrumbs with tool name
                 _breadcrumbs = new List<BreadcrumbItem>
                {
                    new BreadcrumbItem("Home", href: "/"),
                    new BreadcrumbItem("Admin", href: "/admin"),
                    new BreadcrumbItem("Tool Usage", href: "/admin/tools"),
                    new BreadcrumbItem(_toolCall.ToolName, href: $"/admin/tools/{Uri.EscapeDataString(_toolCall.ToolName)}"),
                    new BreadcrumbItem($"Call {Id}", href: null, disabled: true)
                };
            }
        }
        catch (Exception ex) {
            // Silently fail in UI, leaving _toolCall null to show error
            Console.WriteLine($"Error loading tool call: {ex}");
        }
        finally {
            _loading = false;
        }
    }

    private void GoBack() {
        if (_toolCall != null) 
        {
            NavigationManager.NavigateTo($"/admin/tools/{Uri.EscapeDataString(_toolCall.ToolName)}");
        }
        else 
        {
            NavigationManager.NavigateTo("/admin/tools");
        }
    }
    
    private string FormatJson(string? json)
    {
        if (string.IsNullOrWhiteSpace(json))
        {
            return "(empty)";
        }

        try
        {
            using JsonDocument doc = JsonDocument.Parse(json);
            return JsonSerializer.Serialize(doc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }
}
