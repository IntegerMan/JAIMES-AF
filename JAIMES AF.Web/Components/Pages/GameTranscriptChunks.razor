@page "/admin/games/{GameId:guid}/transcript-chunks"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@rendermode InteractiveServer

<PageTitle>@(_response?.GameTitle ?? "Transcript Messages")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	<CompactHeroSection Title="@(_response?.GameTitle ?? "Transcript Messages")"
	                    Icon="@Icons.Material.Filled.Chat"
	                    Theme="CompactHeroSection.HeroTheme.Info"
	                    ItemCount="@_response?.TotalCount"
	                    ItemName="message"
	                    Subtitle="in transcript"
	                    SubtitleNoItems="No messages yet" />

	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>

	@if (_response != null)
	{
		<MudGrid Spacing="3" Class="mb-4">
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.Chat"
				            Value="@_response.TotalCount.ToString()"
				            Label="Total Messages"
				            ColorVariant="MetricCard.MetricColorVariant.Info"
				            Tooltip="Total messages in this transcript" />
			</MudItem>
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.Memory"
				            Value="@_response.EmbeddedCount.ToString()"
				            Label="Embedded"
				            ColorVariant="@(_response.EmbeddedCount == _response.TotalCount
				                ? MetricCard.MetricColorVariant.Success
				                : MetricCard.MetricColorVariant.Warning)"
				            Tooltip="@($"{_response.EmbeddedCount}/{_response.TotalCount} messages have embeddings")" />
			</MudItem>
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.HourglassEmpty"
				            Value="@((_response.TotalCount - _response.EmbeddedCount).ToString())"
				            Label="Pending"
				            ColorVariant="@((_response.TotalCount - _response.EmbeddedCount) == 0
				                ? MetricCard.MetricColorVariant.Success
				                : MetricCard.MetricColorVariant.Warning)"
				            Tooltip="Messages awaiting embedding generation" />
			</MudItem>
		</MudGrid>
	}

	@if (!string.IsNullOrEmpty(_errorMessage))
	{
		<MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
	}

	@if (_isLoading)
	{
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4"/>
	}

	@if (_response != null)
	{
		@if (_response.EmbeddedCount < _response.TotalCount)
		{
			<MudAlert Severity="Severity.Warning" Class="mb-4">
				<strong>@(_response.TotalCount - _response.EmbeddedCount)</strong> of @_response.TotalCount messages are missing embeddings.
				Embedding processing may still be in progress.
			</MudAlert>
		}

		@if (_response.Chunks.Length == 0)
		{
			<div class="glass-card pa-6" style="text-align: center;">
				<MudStack AlignItems="AlignItems.Center" Spacing="3">
					<MudIcon Icon="@Icons.Material.Filled.Chat" Color="Color.Info"
					         Style="font-size: 4rem; opacity: 0.5;"/>
					<MudText Typo="Typo.h6">No messages found</MudText>
					<MudText Class="text-muted mb-4">
						Messages will appear here as the game conversation progresses.
					</MudText>
				</MudStack>
			</div>
		}
		else
		{
			<MudDataGrid T="TranscriptChunkInfo" Items="@_response.Chunks" Dense="true" Striped="true" Hover="true"
			             RowsPerPage="@_response.PageSize">
				<Columns>
					<PropertyColumn Property="x => x.MessageIndex" Title="Index"/>
					<TemplateColumn Title="Role">
						<CellTemplate>
							<MudChip T="string"
							         Color="@(context.Item.Role == "user" ? Color.Primary : Color.Secondary)"
							         Size="Size.Small">
								@context.Item.Role
							</MudChip>
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Message Preview">
						<CellTemplate>
							<MudLink Href="@GetMessageDetailsLink(context.Item.MessageId)">
								<MudText Typo="Typo.body2" Style="max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
									@context.Item.MessageTextPreview
								</MudText>
							</MudLink>
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Embedding">
						<CellTemplate>
							@if (context.Item.HasEmbedding)
							{
								<MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"/>
							}
							else
							{
								<MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" Size="Size.Small"/>
							}
						</CellTemplate>
					</TemplateColumn>
					<PropertyColumn Property="x => x.CreatedAt" Title="Created" Format="g"/>
					<TemplateColumn Title="">
						<CellTemplate>
							<MudTooltip Text="View message details" Placement="Placement.Top">
								<MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
								           Href="@GetMessageDetailsLink(context.Item.MessageId)"
								           StartIcon="@Icons.Material.Filled.Visibility">
									View
								</MudButton>
							</MudTooltip>
						</CellTemplate>
					</TemplateColumn>
				</Columns>
			</MudDataGrid>

			@if (_response.TotalCount > _response.PageSize)
			{
				<MudStack Row="true" Justify="Justify.Center" Class="mt-4">
					<MudPagination Count="@TotalPages" Selected="@_currentPage" SelectedChanged="OnPageChanged" Color="Color.Primary"/>
				</MudStack>
			}
		}
	}
</MudContainer>
