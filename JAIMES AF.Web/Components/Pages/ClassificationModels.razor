@page "/admin/classification-models"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using Microsoft.AspNetCore.SignalR.Client
@rendermode InteractiveServer
@inject HttpClient Http
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<PageTitle>Classification Models</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">

	@* Compact Hero Section for ML Models *@
	<div class="models-hero pa-3 mb-4" style="background: linear-gradient(135deg, rgba(239, 71, 111, 0.1) 0%, rgba(123, 44, 191, 0.1) 100%); 
		border-radius: 16px; border: 1px solid rgba(239, 71, 111, 0.2);">
		<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
				<div class="icon-badge icon-badge-error">
					<MudIcon Icon="@Icons.Material.Filled.Psychology" Style="color: white; font-size: 1.5rem;"/>
				</div>
				<MudStack Spacing="0">
					<MudText Typo="Typo.h5" Style="font-weight: 600; color: #EF476F;">Classification Models</MudText>
					<MudText Typo="Typo.caption" Class="text-muted">
						@if (_models.Count > 0)
						{
							<span>@_models.Count model@(_models.Count != 1 ? "s" : "") available</span>
						}
						else
						{
							<span>Train your first model</span>
						}
					</MudText>
				</MudStack>
			</MudStack>
			<MudTooltip Text="Train a new sentiment classification model" Placement="Placement.Top">
				<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ModelTraining"
				           OnClick="NavigateToTraining">
					Train New Classifier
				</MudButton>
			</MudTooltip>
		</MudStack>
	</div>

	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>

	<div style="position: relative; min-height: 200px;">
		@if (_loading)
		{
			<div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
				<MudProgressCircular Indeterminate="true"/>
			</div>
		}

		@if (!_loading && !string.IsNullOrEmpty(_error))
		{
			<MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
		}

		@if (!_loading && string.IsNullOrEmpty(_error) && _models.Count == 0)
		{
			<div class="glass-card pa-6" style="text-align: center;">
				<MudStack AlignItems="AlignItems.Center" Spacing="3">
					<MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Error"
					         Style="font-size: 4rem; opacity: 0.5;"/>
					<MudText Typo="Typo.h6">No models yet</MudText>
					<MudText Class="text-muted mb-4">
						Train your first sentiment classification model to enable AI-powered feedback analysis.
					</MudText>
					<MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
					           OnClick="NavigateToTraining" StartIcon="@Icons.Material.Filled.ModelTraining">
						Train Your First Model
					</MudButton>
				</MudStack>
			</div>
		}

		@if (!_loading && string.IsNullOrEmpty(_error) && _models.Count > 0)
		{
			<MudPaper Elevation="0" Class="pa-0" Style="background: transparent;">
				<MudTable Items="_models" Dense="true" Hover="true">
					<HeaderContent>
						<MudTh>ID</MudTh>
						<MudTh>Name</MudTh>
						<MudTh>Type</MudTh>
						<MudTh>Status</MudTh>
						<MudTh>Size</MudTh>
						<MudTh>Created</MudTh>
						<MudTh Style="text-align: right;">Actions</MudTh>
					</HeaderContent>
					<RowTemplate>
						<MudTd>@context.Id</MudTd>
						<MudTd>
							@if (context.Id > 0)
							{
								<MudLink Href="@($"/admin/classification-models/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
									@context.Name
								</MudLink>
							}
							else
							{
								<MudText>@context.Name</MudText>
							}
						</MudTd>
						<MudTd>@context.ModelType</MudTd>
						<MudTd>
							@if (context.IsActive)
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Active</MudChip>
							}
							else if (context.Status == "Training...")
							{
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
									<MudProgressCircular Size="@Size.Small" Indeterminate="true" Style="width: 16px; height: 16px;"/>
									<MudText Typo="Typo.body2" Color="Color.Info">Training...</MudText>
								</MudStack>
							}
							else if (context.Status == "Queued")
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Queued</MudChip>
							}
							else if (context.Status == "Failed")
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">Failed</MudChip>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">Ready</MudChip>
							}
						</MudTd>
						<MudTd>@FormatFileSize(context.SizeBytes)</MudTd>
						<MudTd>@context.CreatedAt.ToString("g")</MudTd>
						<MudTd Style="text-align: right;">
							@if (context.Id > 0)
							{
								<MudTooltip Text="View Details" Placement="Placement.Top">
									<MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" Size="Size.Small"
									               Href="@($"/admin/classification-models/{context.Id}")"/>
								</MudTooltip>
							}
							@if (context.IsActive)
							{
								<MudTooltip Text="Active Model" Placement="Placement.Top">
									<MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" Class="ml-2"/>
								</MudTooltip>
							}
						</MudTd>
					</RowTemplate>
				</MudTable>
			</MudPaper>
		}
	</div>
</MudContainer>

@code {
	private List<ClassificationModelResponse> _models = new();
	private bool _loading = true;
	private string? _error;
	private List<BreadcrumbItem> _breadcrumbs = new();
	private HubConnection? _hubConnection;

	protected override async Task OnInitializedAsync()
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Admin", href: "/admin"),
			new BreadcrumbItem("Classification Models", href: null, disabled: true)
		};

		await LoadModelsAsync();
		await SetupSignalRAsync();
	}

	private async Task SetupSignalRAsync()
	{
		// Build hub connection using the API service URL (hub is hosted on API, not Web)
		HttpClient apiClient = HttpClientFactory.CreateClient("Api");
		string hubUrl = new Uri(apiClient.BaseAddress!, "/hubs/messages").ToString();

		_hubConnection = new HubConnectionBuilder()
			.WithUrl(hubUrl)
			.WithAutomaticReconnect()
			.Build();

		// Listen for training completed notifications
		_hubConnection.On<ClassifierTrainingCompletedNotification>("ClassifierTrainingCompleted",
			_ =>
			{
				// Refresh the list when training completes
				InvokeAsync(async () =>
				{
					await LoadModelsAsync();
					StateHasChanged();
				});
			});

		// Listen for training status changes (e.g., Queued â†’ Training)
		_hubConnection.On<int, string>("ClassifierTrainingStatusChanged",
			(_, _) =>
			{
				// Refresh the list when training status changes
				InvokeAsync(async () =>
				{
					await LoadModelsAsync();
					StateHasChanged();
				});
			});

		try
		{
			await _hubConnection.StartAsync();
			// Join admin group to receive training notifications
			await _hubConnection.InvokeAsync("JoinAdmin");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"SignalR connection failed: {ex.Message}");
		}
	}

	private async Task LoadModelsAsync()
	{
		_loading = true;
		_error = null;

		try
		{
			var response = await Http.GetFromJsonAsync<List<ClassificationModelResponse>>("/admin/classification-models");
			_models = response ?? new List<ClassificationModelResponse>();
		}
		catch (Exception ex)
		{
			_error = $"Failed to load classification models: {ex.Message}";
		}
		finally
		{
			_loading = false;
		}
	}

	private void NavigateToTraining()
	{
		NavigationManager.NavigateTo("/admin/classification-models/train");
	}

	private void NavigateToDetails(ClassificationModelResponse model)
	{
		// Only navigate for real models, not pending training jobs (which have negative IDs)
		if (model.Id > 0)
		{
			NavigationManager.NavigateTo($"/admin/classification-models/{model.Id}");
		}
	}

	private static string FormatFileSize(long? bytes)
	{
		if (bytes == null) return "Unknown";
		if (bytes < 1024) return $"{bytes} B";
		if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
		return $"{bytes / (1024.0 * 1024.0):F1} MB";
	}

	public async ValueTask DisposeAsync()
	{
		if (_hubConnection != null)
		{
			await _hubConnection.DisposeAsync();
		}
	}

}

