@page "/admin/classification-models/{Id:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>Model Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
	<MudPaper Class="pa-8" Elevation="2">
		<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
			<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
		</MudStack>

		@if (_loading)
		{
			<MudProgressCircular Indeterminate="true" Class="mb-4"/>
		}
		else if (_model == null)
		{
			<MudAlert Severity="Severity.Error">Model not found.</MudAlert>
		}
		else
		{
			<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudText Typo="Typo.h3">@_model.Name</MudText>
					@if (_model.IsActive)
					{
						<MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Active</MudChip>
					}
				</MudStack>
				@if (!_model.IsActive)
				{
					<MudButton Variant="Variant.Filled" Color="Color.Primary"
					           StartIcon="@Icons.Material.Filled.CheckCircle"
					           OnClick="ConfirmActivation">
						Activate This Model
					</MudButton>
				}
			</MudStack>

			@* Model Info *@
			<MudGrid Class="mb-6">
				<MudItem xs="12" md="5">
					<MudPaper Class="pa-4" Elevation="0" Outlined="true">
						<MudText Typo="Typo.h6" Class="mb-3">Model Information</MudText>
						<MudStack Spacing="2">
							<MudStack Row="true" Justify="Justify.SpaceBetween">
								<MudText Typo="Typo.body2" Color="Color.Default">Type:</MudText>
								<MudText Typo="Typo.body2">
									<strong>@_model.ModelType</strong>
								</MudText>
							</MudStack>
							<MudStack Row="true" Justify="Justify.SpaceBetween">
								<MudText Typo="Typo.body2" Color="Color.Default">File:</MudText>
								<MudText Typo="Typo.body2">
									<strong>@_model.FileName</strong>
								</MudText>
							</MudStack>
							<MudStack Row="true" Justify="Justify.SpaceBetween">
								<MudText Typo="Typo.body2" Color="Color.Default">Size:</MudText>
								<MudText Typo="Typo.body2">
									<strong>@FormatFileSize(_model.SizeBytes)</strong>
								</MudText>
							</MudStack>
							<MudStack Row="true" Justify="Justify.SpaceBetween">
								<MudText Typo="Typo.body2" Color="Color.Default">Created:</MudText>
								<MudText Typo="Typo.body2">
									<strong>@_model.CreatedAt.ToString("g")</strong>
								</MudText>
							</MudStack>
						</MudStack>
					</MudPaper>
				</MudItem>

				@if (_model.TrainingJob != null)
				{
					<MudItem xs="12" md="7">
						<MudPaper Class="pa-4" Elevation="0" Outlined="true">
							<MudText Typo="Typo.h6" Class="mb-3">Training Parameters</MudText>
							<MudStack Spacing="2">
								<MudStack Row="true" Justify="Justify.SpaceBetween">
									<MudText Typo="Typo.body2" Color="Color.Default">Min Confidence:</MudText>
									<MudText Typo="Typo.body2">
										<strong>@(_model.TrainingJob.MinConfidence.ToString("P0"))</strong>
									</MudText>
								</MudStack>
								<MudStack Row="true" Justify="Justify.SpaceBetween">
									<MudText Typo="Typo.body2" Color="Color.Default">Train/Test Split:</MudText>
									<MudText Typo="Typo.body2">
										<strong>@(_model.TrainingJob.TrainTestSplit.ToString("P0"))</strong>
									</MudText>
								</MudStack>
								<MudStack Row="true" Justify="Justify.SpaceBetween">
									<MudText Typo="Typo.body2" Color="Color.Default">Training Time:</MudText>
									<MudText Typo="Typo.body2">
										<strong>@(_model.TrainingJob.TrainingTimeSeconds)s</strong>
									</MudText>
								</MudStack>
								<MudStack Row="true" Justify="Justify.SpaceBetween">
									<MudText Typo="Typo.body2" Color="Color.Default">Metric:</MudText>
									<MudText Typo="Typo.body2">
										<strong>@_model.TrainingJob.OptimizingMetric</strong>
									</MudText>
								</MudStack>
								<MudStack Row="true" Justify="Justify.SpaceBetween">
									<MudText Typo="Typo.body2" Color="Color.Default">Trainer:</MudText>
									<MudText Typo="Typo.body2">
										<strong>@(_model.TrainingJob.TrainerName ?? "N/A")</strong>
									</MudText>
								</MudStack>
							</MudStack>
						</MudPaper>
					</MudItem>
				}
			</MudGrid>

			@* Evaluation Metrics *@
			@if (_model.TrainingJob != null)
			{
				<MudText Typo="Typo.h5" Class="mb-4">Evaluation Metrics</MudText>
				<MudGrid Class="mb-6">
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4" Color="Color.Primary">@((_model.TrainingJob.MacroAccuracy ?? 0).ToString("P1"))</MudText>
							<MudText Typo="Typo.caption">Macro Accuracy</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4" Color="Color.Secondary">@((_model.TrainingJob.MicroAccuracy ?? 0).ToString("P1"))</MudText>
							<MudText Typo="Typo.caption">Micro Accuracy</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4">@((_model.TrainingJob.LogLoss ?? 0).ToString("F3"))</MudText>
							<MudText Typo="Typo.caption">Log Loss</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4">@_model.TrainingJob.TotalRows</MudText>
							<MudText Typo="Typo.caption">Total Rows</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4">@_model.TrainingJob.TrainingRows</MudText>
							<MudText Typo="Typo.caption">Training</MudText>
						</MudPaper>
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<MudPaper Class="pa-4 text-center" Elevation="1">
							<MudText Typo="Typo.h4">@_model.TrainingJob.TestRows</MudText>
							<MudText Typo="Typo.caption">Test</MudText>
						</MudPaper>
					</MudItem>
				</MudGrid>

				@* Confusion Matrix *@
				@if (_model.TrainingJob.ConfusionMatrix != null && _model.TrainingJob.ConfusionMatrix.Length > 0)
				{
					<MudText Typo="Typo.h5" Class="mb-4">Confusion Matrix</MudText>
					<MudPaper Class="pa-4" Elevation="1">
						<MudSimpleTable Dense="true" Bordered="true" Style="width: 100%;">
							<thead>
							<tr>
								<th></th>
								@foreach (var label in SentimentLabels)
								{
									<th class="text-center">
										<strong>Predicted @label</strong>
									</th>
								}
								<th class="text-center">
									<strong>Recall</strong>
								</th>
							</tr>
							</thead>
							<tbody>
							@{
								var matrix = GetNormalizedMatrix();
								var columnTotals = new int[3];

								// Calculate column totals for precision
								for (int j = 0; j < 3; j++)
								{
									for (int i = 0; i < 3; i++)
									{
										columnTotals[j] += matrix[i][j];
									}
								}
							}
							@for (int i = 0; i < 3; i++)
							{
								var row = matrix[i];
								var rowTotal = row.Sum();
								var recall = rowTotal > 0 ? (double) row[i] / rowTotal : 0;
								<tr>
									<td>
										<strong>Actual @SentimentLabels[i]</strong>
									</td>
									@for (int j = 0; j < 3; j++)
									{
										var percentage = rowTotal > 0 ? (double) row[j] / rowTotal : 0;
										var cellStyle = GetCellColor(percentage);
										<td class="text-center" style="@cellStyle">
											@row[j]
										</td>
									}
									<td class="text-center">
										<strong>@recall.ToString("P1")</strong>
									</td>
								</tr>
							}
							@* Precision row *@
							<tr>
								<td>
									<strong>Precision</strong>
								</td>
								@for (int j = 0; j < 3; j++)
								{
									var precision = columnTotals[j] > 0 ? (double) matrix[j][j] / columnTotals[j] : 0;
									<td class="text-center">
										<strong>@precision.ToString("P1")</strong>
									</td>
								}
								<td></td>
							</tr>
							</tbody>
						</MudSimpleTable>
						<MudText Typo="Typo.caption" Class="mt-2 text-muted">
							Color intensity indicates percentage of row (white = low, blue = high).
							<strong>Recall</strong> = correctly predicted / actual total per class.
							<strong>Precision</strong> = correctly predicted / predicted total per class.
						</MudText>
					</MudPaper>
				}
			}
			else
			{
				<MudAlert Severity="Severity.Info" Class="mt-4">
					This model was not trained through the application and has no training metrics available.
				</MudAlert>
			}
		}

		@if (!string.IsNullOrEmpty(_error))
		{
			<MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
		}
	</MudPaper>
</MudContainer>

@code {
	[Parameter] public int Id { get; set; }

	private ClassificationModelDetailsResponse? _model;
	private bool _loading = true;
	private string? _error;
	private List<BreadcrumbItem> _breadcrumbs = new();

	protected override async Task OnInitializedAsync()
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Admin", href: "/admin"),
			new BreadcrumbItem("Classification Models", href: "/admin/classification-models"),
			new BreadcrumbItem("Details", href: null, disabled: true)
		};

		await LoadModelAsync();
	}

	private async Task LoadModelAsync()
	{
		_loading = true;
		_error = null;

		try
		{
			_model = await Http.GetFromJsonAsync<ClassificationModelDetailsResponse>($"/admin/classification-models/{Id}");
		}
		catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
		{
			_model = null;
		}
		catch (Exception ex)
		{
			_error = $"Failed to load model: {ex.Message}";
		}
		finally
		{
			_loading = false;
		}
	}

	private async Task ConfirmActivation()
	{
		bool? result = await DialogService.ShowMessageBox(
			"Activate Model",
			$"Are you sure you want to activate '{_model?.Name}'? This will make it the active model for sentiment classification and redirect all inference to use this model.",
			yesText: "Activate",
			cancelText: "Cancel");

		if (result == true)
		{
			await ActivateModel();
		}
	}

	private async Task ActivateModel()
	{
		try
		{
			var response = await Http.PostAsync($"/admin/classification-models/{Id}/activate", null);
			if (response.IsSuccessStatusCode)
			{
				await LoadModelAsync();
			}
			else
			{
				_error = "Failed to activate model";
			}
		}
		catch (Exception ex)
		{
			_error = $"Failed to activate model: {ex.Message}";
		}
	}

	private static string FormatFileSize(long? bytes)
	{
		if (bytes == null) return "Unknown";
		if (bytes < 1024) return $"{bytes} B";
		if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
		return $"{bytes / (1024.0 * 1024.0):F1} MB";
	}

	/// <summary>
	/// Fixed labels for 3-class sentiment classification: Negative, Neutral, Positive.
	/// </summary>
	private static readonly string[] SentimentLabels = ["Negative", "Neutral", "Positive"];

	/// <summary>
	/// Returns the confusion matrix, ensuring it's 3x3 for display.
	/// Training now always produces 3x3 matrices with correct class mapping.
	/// This method handles legacy/edge cases where smaller matrices may exist.
	/// </summary>
	private int[][] GetNormalizedMatrix()
	{
		var sourceMatrix = _model?.TrainingJob?.ConfusionMatrix;
		if (sourceMatrix == null) return [[0, 0, 0], [0, 0, 0], [0, 0, 0]];

		int size = sourceMatrix.Length;

		// If already 3x3, return as-is (normal case after fix)
		if (size == 3) return sourceMatrix;

		// For legacy matrices smaller than 3x3, pad with zeros
		// Note: New training always produces proper 3x3 matrices
		int[][] normalized = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
		for (int i = 0; i < Math.Min(size, 3); i++)
		{
			for (int j = 0; j < Math.Min(sourceMatrix[i].Length, 3); j++)
			{
				normalized[i][j] = sourceMatrix[i][j];
			}
		}

		return normalized;
	}

	private static string GetCellColor(double percentage)
	{
		// Use white-to-dark-blue gradient based on percentage
		// Higher percentage = more blue
		if (percentage <= 0) return "";

		// Map percentage to RGB - start from white (255,255,255), end at dark blue (21,101,192)
		// MUI blue-700 = #1565c0 = rgb(21, 101, 192)
		int r = (int) (255 - (percentage * (255 - 21)));
		int g = (int) (255 - (percentage * (255 - 101)));
		int b = (int) (255 - (percentage * (255 - 192)));

		return $"background-color: rgb({r}, {g}, {b}); color: {(percentage > 0.5 ? "white" : "black")};";
	}

}
