@page "/agents/{AgentId}/improve"
@page "/agents/{AgentId}/versions/{VersionId:int}/improve"
@rendermode InteractiveServer

@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MattEland.Jaimes.ServiceDefinitions.Responses

@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILoggerFactory LoggerFactory

<PageTitle>Improve Prompt</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
            <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
        </MudStack>

        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Secondary" Size="Size.Large"/>
            <MudText Typo="Typo.h4">Prompt Improvement Wizard</MudText>
        </MudStack>

        @if (_isLoading)
        {
            <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                <MudProgressCircular Indeterminate="true"/>
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/agents/{AgentId}")">
                Back to Agent
            </MudButton>
        }
        else
        {
            @* Custom Step Indicator Header *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Class="mb-4">
                @for (int i = 0; i < _stepTitles.Length; i++)
                {
                    var stepIndex = i;
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudAvatar Size="Size.Small" 
                                   Color="@(stepIndex <= _maxReachedStep ? (stepIndex == _activeStep ? Color.Primary : Color.Success) : Color.Default)"
                                   Style="@(stepIndex <= _maxReachedStep ? "" : "opacity: 0.5;")">
                            @if (stepIndex < _activeStep)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small"/>
                            }
                            else
                            {
                                @(stepIndex + 1)
                            }
                        </MudAvatar>
                        <MudText Typo="Typo.caption" 
                                 Color="@(stepIndex == _activeStep ? Color.Primary : Color.Default)"
                                 Style="@(stepIndex <= _maxReachedStep ? "" : "opacity: 0.5;")">
                            @_stepTitles[stepIndex]
                        </MudText>
                    </MudStack>
                    @if (i < _stepTitles.Length - 1)
                    {
                        <MudDivider Class="mx-4" Style="@GetDividerStyle(stepIndex)"/>
                    }
                }
            </MudStack>

            <MudDivider Class="mb-4"/>

            @* Step 1: Gather Insights *@
            @if (_activeStep == 0)
            {
                <MudText Typo="Typo.body1" Class="mb-4">
                    Generating AI insights from your agent's performance data to identify areas for improvement.
                </MudText>

                <MudGrid Spacing="3" Style="height: calc(100vh - 450px); min-height: 350px;">
                    <MudItem xs="12" md="6" lg="3" Style="height: 100%;">
                        <MudPaper Class="pa-4" Elevation="2" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Primary" Size="Size.Medium"/>
                                <MudText Typo="Typo.h6">Feedback</MudText>
                                @if (_isGeneratingFeedback)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                                }
                                else if (!string.IsNullOrEmpty(_feedbackInsights))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"/>
                                }
                            </MudStack>
                            <div style="flex: 1; overflow-y: auto; min-height: 0;">
                                @if (!string.IsNullOrEmpty(_feedbackInsights))
                                {
                                    <MudText Typo="Typo.caption" Style="white-space: pre-wrap;">@_feedbackInsights</MudText>
                                }
                                else if (!_isGeneratingFeedback)
                                {
                                    <MudText Typo="Typo.caption" Class="text-muted">No feedback data available.</MudText>
                                }
                            </div>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="6" lg="3" Style="height: 100%;">
                        <MudPaper Class="pa-4" Elevation="2" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.PieChart" Color="Color.Primary" Size="Size.Medium"/>
                                <MudText Typo="Typo.h6">Metrics</MudText>
                                @if (_isGeneratingMetrics)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                                }
                                else if (!string.IsNullOrEmpty(_metricsInsights))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"/>
                                }
                            </MudStack>
                            <div style="flex: 1; overflow-y: auto; min-height: 0;">
                                @if (!string.IsNullOrEmpty(_metricsInsights))
                                {
                                    <MudText Typo="Typo.caption" Style="white-space: pre-wrap;">@_metricsInsights</MudText>
                                }
                                else if (!_isGeneratingMetrics)
                                {
                                    <MudText Typo="Typo.caption" Class="text-muted">No metrics data available.</MudText>
                                }
                            </div>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="6" lg="3" Style="height: 100%;">
                        <MudPaper Class="pa-4" Elevation="2" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Balance" Color="Color.Primary" Size="Size.Medium"/>
                                <MudText Typo="Typo.h6">Sentiment</MudText>
                                @if (_isGeneratingSentiment)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                                }
                                else if (!string.IsNullOrEmpty(_sentimentInsights))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"/>
                                }
                            </MudStack>
                            <div style="flex: 1; overflow-y: auto; min-height: 0;">
                                @if (!string.IsNullOrEmpty(_sentimentInsights))
                                {
                                    <MudText Typo="Typo.caption" Style="white-space: pre-wrap;">@_sentimentInsights</MudText>
                                }
                                else if (!_isGeneratingSentiment)
                                {
                                    <MudText Typo="Typo.caption" Class="text-muted">No sentiment data available.</MudText>
                                }
                            </div>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="6" lg="3" Style="height: 100%;">
                        <MudPaper Class="pa-4" Elevation="2" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Chat" Color="Color.Primary" Size="Size.Medium"/>
                                <MudText Typo="Typo.h6">Messages</MudText>
                                @if (_isGeneratingMessages)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                                }
                                else if (!string.IsNullOrEmpty(_messageInsights))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"/>
                                }
                            </MudStack>
                            <div style="flex: 1; overflow-y: auto; min-height: 0;">
                                @if (!string.IsNullOrEmpty(_messageInsights))
                                {
                                    <MudText Typo="Typo.caption" Style="white-space: pre-wrap;">@_messageInsights</MudText>
                                }
                                else if (!_isGeneratingMessages)
                                {
                                    <MudText Typo="Typo.caption" Class="text-muted">No message data available.</MudText>
                                }
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }

            @* Step 2: Your Feedback *@
            @if (_activeStep == 1)
            {
                <MudText Typo="Typo.body1" Class="mb-4">
                    Optionally provide your own specific requests or observations to guide the prompt improvement.
                </MudText>

                <MudTextField @bind-Value="_userFeedback"
                              Label="Your Specific Requests (optional)"
                              Variant="Variant.Outlined"
                              Lines="8"
                              Placeholder="E.g., 'Make responses shorter', 'Be more formal', 'Add more humor'"
                              HelperText="Describe specific changes or improvements you'd like to see in the agent's behavior."/>
            }

            @* Step 3: Generate Prompt *@
            @if (_activeStep == 2)
            {
                <MudText Typo="Typo.body1" Class="mb-3">
                    Review the full prompt that will be sent to the AI, then generate an improved version.
                </MudText>

                <MudExpansionPanels Class="mb-4">
                    <MudExpansionPanel Text="View Full AI Input Prompt" MaxHeight="400">
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey); max-height: 350px; overflow-y: auto;">
                            <MudText Style="white-space: pre-wrap; font-family: monospace; font-size: 0.85em;">@GetFullPromptPreview()</MudText>
                        </MudPaper>
                    </MudExpansionPanel>
                </MudExpansionPanels>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.AutoAwesome"
                           OnClick="GenerateAndAdvanceAsync"
                           Disabled="_isGeneratingPrompt || (!HasAnyInsights && string.IsNullOrWhiteSpace(_userFeedback))"
                           FullWidth="true">
                    @if (_isGeneratingPrompt)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                        <span class="ms-2">Generating Improved Prompt...</span>
                    }
                    else
                    {
                        <span>Generate</span>
                    }
                </MudButton>
                
                @if (!HasAnyInsights && string.IsNullOrWhiteSpace(_userFeedback))
                {
                    <MudText Typo="Typo.caption" Class="text-muted mt-2">
                        Generate at least one insight or provide your feedback to enable prompt generation.
                    </MudText>
                }
            }

            @* Step 4: Review & Apply *@
            @if (_activeStep == 3)
            {
                <MudText Typo="Typo.body1" Class="mb-3">
                    Review and edit the improved prompt below, then apply it to open the edit page.
                </MudText>

                <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border: 2px solid var(--mud-palette-success);">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
                        <MudText Typo="Typo.subtitle2">Improved Prompt</MudText>
                        <MudTooltip Text="Copy to clipboard">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                           Size="Size.Small" 
                                           OnClick="CopyToClipboard"/>
                        </MudTooltip>
                    </MudStack>
                    <MudTextField @bind-Value="_improvedPrompt"
                                  Variant="Variant.Outlined"
                                  Lines="12"
                                  FullWidth="true"/>
                </MudPaper>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Check"
                               OnClick="ApplyImprovedPrompt">
                        Apply
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="RegeneratePrompt">
                        Regenerate
                    </MudButton>
                </MudStack>
            }

            <MudDivider Class="my-4"/>

            <MudStack Row="true" Justify="Justify.SpaceBetween">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default" 
                           Href="@(VersionId.HasValue ? $"/agents/{AgentId}/versions/{VersionId}" : $"/agents/{AgentId}")">
                    Cancel
                </MudButton>

                <MudStack Row="true" Spacing="2">
                    @if (_activeStep > 0 && _activeStep < 3)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="PreviousStep">
                            Previous
                        </MudButton>
                    }
                    @if (_activeStep < 2)
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NextStep">
                            Next
                        </MudButton>
                    }
                </MudStack>
            </MudStack>
        }
    </MudPaper>
</MudContainer>
