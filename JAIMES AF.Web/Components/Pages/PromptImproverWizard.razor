@page "/agents/{AgentId}/improve"
@page "/agents/{AgentId}/versions/{VersionId:int}/improve"
@rendermode InteractiveServer

@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MattEland.Jaimes.Web.Components.Pages.PromptImproverWizardSteps

@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILoggerFactory LoggerFactory

<PageTitle>Improve Prompt</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <CompactHeroSection Title="Prompt Improvement Wizard"
                        Icon="@Icons.Material.Filled.AutoAwesome"
                        Theme="CompactHeroSection.HeroTheme.Secondary"
                        Subtitle="@GetStepSubtitle()"
                        ActionText="View Agent"
                        ActionHref="@($"/agents/{AgentId}")"
                        ActionIcon="@Icons.Material.Filled.SmartToy"/>

    <MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="mb-4"/>

    <MudPaper Class="pa-6" Elevation="2">
        @if (_isLoading)
        {
            <div class="d-flex justify-center align-center" style="min-height: 200px;">
                <MudProgressCircular Indeterminate="true"/>
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/agents/{AgentId}")">
                Back to Agent
            </MudButton>
        }
        else
        {
            <WizardSteps StepTitles="_stepTitles" 
                         ActiveStep="_activeStep" 
                         MaxReachedStep="_maxReachedStep"
                         OnStepClick="GoToStep"/>

            <MudDivider Class="mb-4"/>

            @switch (_activeStep)
            {
                case 0:
                    <InsightsStep FeedbackInsights="@_feedbackInsights"
                                  MetricsInsights="@_metricsInsights"
                                  SentimentInsights="@_sentimentInsights"
                                  MessageInsights="@_messageInsights"
                                  ToolInsights="@_toolInsights"
                                  IsGeneratingFeedback="_isGeneratingFeedback"
                                  IsGeneratingMetrics="_isGeneratingMetrics"
                                  IsGeneratingSentiment="_isGeneratingSentiment"
                                  IsGeneratingMessages="_isGeneratingMessages"
                                  IsGeneratingTools="_isGeneratingTools"/>
                    break;
                    
                case 1:
                    <FeedbackStep @bind-UserFeedback="_userFeedback"/>
                    break;
                    
                case 2:
                    <GenerateStep @bind-EditableInputPrompt="_editableInputPrompt"
                                  @bind-InputPromptExpanded="_inputPromptExpanded"
                                  IsGenerating="_isGeneratingPrompt"
                                  CanGenerate="@(HasAnyInsights || !string.IsNullOrWhiteSpace(_userFeedback))"
                                  OnGenerate="GenerateAndAdvanceAsync"/>
                    break;
                    
                case 3:
                    <ApplyStep CurrentPrompt="@_currentPrompt"
                               @bind-ImprovedPrompt="_improvedPrompt"
                               OnCopyToClipboard="CopyToClipboard"
                               OnApply="ApplyImprovedPrompt"
                               OnRegenerate="RegeneratePrompt"/>
                    break;
            }

            <MudDivider Class="my-4"/>

            <WizardNavigation CancelHref="@(VersionId.HasValue ? $"/agents/{AgentId}/versions/{VersionId}" : $"/agents/{AgentId}")"
                              ShowBack="@(_activeStep > 0 && _activeStep < 3)"
                              ShowNext="@(_activeStep < 2)"
                              OnBack="PreviousStep"
                              OnNext="NextStep"/>
        }
    </MudPaper>
</MudContainer>
