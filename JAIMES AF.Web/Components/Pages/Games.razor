@page "/games"

@using MattEland.Jaimes.ServiceDefinitions.Responses

@inject HttpClient Http
@inject NavigationManager Nav
@inject ILoggerFactory LoggerFactory

<PageTitle>Games</PageTitle>

<MudPaper Class="pa-4">
	<MudText Typo="Typo.h4">Games</MudText>

	<MudText Class="mb-4">This page lists your current in-progress games and allows you to start a new game.</MudText>

	@if (isLoading)
	{
		<MudProgressCircular Indeterminate="true" Class="my-4" />
	} else if (!string.IsNullOrEmpty(errorMessage))
	{
		<MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
	} else if (games is null || games.Length == 0)
	{
		<MudList T="string">
			<MudListItem T="string">(No games loaded yet)</MudListItem>
		</MudList>
	} else
	{
		<MudTable Items="games" Dense="true" Hover="true">
			<HeaderContent>
				<MudTh></MudTh>
				<MudTh>Ruleset</MudTh>
				<MudTh>Scenario</MudTh>
				<MudTh>Player</MudTh>
			</HeaderContent>
			<RowTemplate>
				<MudTd>
					<MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="() => OpenGame(context.GameId.ToString())">Load</MudButton>
				</MudTd>
				<MudTd>@context.RulesetName</MudTd>
				<MudTd>@context.ScenarioName</MudTd>
				<MudTd>@context.PlayerName</MudTd>
			</RowTemplate>
		</MudTable>
	}
</MudPaper>

@code {
	private GameInfoResponse[]? games;
	private bool isLoading = true;
	private string? errorMessage;

	protected override async Task OnInitializedAsync()
	{
		await LoadGamesAsync();
	}

	private async Task LoadGamesAsync()
	{
		isLoading = true;
		errorMessage = null;
		try
		{
			var resp = await Http.GetFromJsonAsync<ListGamesResponse>("/games");
			games = resp?.Games ?? [];
		}
		catch (Exception ex)
		{
			LoggerFactory.CreateLogger("Games").LogError(ex, "Failed to load games from API");
			errorMessage = "Failed to load games: " + ex.Message;
		}
		finally
		{
			isLoading = false;
			StateHasChanged();
		}
	}

	private void OpenGame(string gameId)
	{
		Nav.NavigateTo($"/games/{gameId}");
	}
}
