@using MattEland.Jaimes.Domain
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Helpers
@using MattEland.Jaimes.Web.Components.Chat
@using MudBlazor

<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        }
        else
        {
            <div class="context-chat-container">
                @foreach (var m in _messages)
                {
                    List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
					@foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
					{
						bool isFirstParagraph = index == 0;
						bool isLastParagraph = index == paragraphs.Count - 1;
                        bool isTargetMessage = m.Id == MessageId;

						@if (m.PlayerId != null) // User message
						{
						    <MattEland.Jaimes.Web.Components.Chat.UserChatMessage 
						        Text="@paragraph" 
						        IsFirstParagraph="@isFirstParagraph"
                                Color="@(isTargetMessage ? Color.Info : Color.Primary)" />
						}
						else // Assistant message
						{
							<MattEland.Jaimes.Web.Components.Chat.AssistantChatMessage
							    Text="@paragraph"
							    MessageId="@m.Id"
							    IsFirstParagraph="@isFirstParagraph"
							    IsLastParagraph="@isLastParagraph"
							    ReadOnly="true"
                                Color="@(isTargetMessage ? Color.Info : Color.Default)" />
						}
					}
                }
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Inject] IHttpClientFactory HttpClientFactory { get; set; } = null!;

    [Parameter] public int MessageId { get; set; }

    private List<MessageDto> _messages = [];
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnParametersSetAsync()
    {
        await LoadContextAsync();
    }

    private async Task LoadContextAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var messages = await client.GetFromJsonAsync<List<MessageDto>>($"/messages/{MessageId}/context?count=5");
            
            if (messages != null)
            {
                _messages = messages;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load context: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Close() => MudDialog.Close(DialogResult.Ok(true));
}
