@page "/admin/locations"
@rendermode InteractiveServer

<PageTitle>Locations</PageTitle>

<MudPaper Class="pa-4">
	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>
	<MudText Typo="Typo.h4">Locations</MudText>

	<MudText Class="mb-4">Browse and manage locations by game.</MudText>

	<MudStack Row="true" Spacing="2" Class="mb-4" AlignItems="AlignItems.Center">
		<MudSelect T="Guid?" @bind-Value="SelectedGameId"
		           Label="Filter by Game"
		           Variant="Variant.Outlined"
		           Style="max-width: 400px;"
		           HelperText="Select a game to view its locations">
			<MudSelectItem T="Guid?" Value="@((Guid?) null)">All Games</MudSelectItem>
			@foreach (GameInfoResponse game in _games)
			{
				<MudSelectItem T="Guid?" Value="@((Guid?) game.GameId)">@FormatGameDisplay(game)</MudSelectItem>
			}
		</MudSelect>

		<MudButton Variant="Variant.Filled" Color="Color.Primary"
		           StartIcon="@Icons.Material.Filled.Add"
		           OnClick="OpenNewLocationDialog"
		           Disabled="@(!_selectedGameId.HasValue)">
			New Location
		</MudButton>
	</MudStack>

	<div style="position: relative; min-height: 200px;">
		@if (_isLoading)
		{
			<div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
				<MudProgressCircular Indeterminate="true"/>
			</div>
		}

		@if (!_isLoading && !string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && (_locations is null || _locations.Length == 0))
		{
			<MudAlert Severity="Severity.Info" Class="mb-4">
				@if (_selectedGameId.HasValue)
				{
					<span>No locations found for this game. Locations are created by the AI during gameplay.</span>
				}
				else
				{
					<span>No locations found. Select a game or play a game to have the AI create locations.</span>
				}
			</MudAlert>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && _locations is not null && _locations.Length > 0)
		{
			<MudTable T="LocationResponse" Items="_locations" Dense="true" Hover="true">
				<HeaderContent>
					<MudTh>Name</MudTh>
					<MudTh>Description</MudTh>
					@if (!_selectedGameId.HasValue)
					{
						<MudTh>Game</MudTh>
					}
					<MudTh>Events</MudTh>
					<MudTh>Nearby</MudTh>
					<MudTh Style="text-align: right;">Actions</MudTh>
				</HeaderContent>
				<RowTemplate>
					<MudTd>
						<MudLink Href="@($"/admin/locations/{context.Id}")">
							<strong>@context.Name</strong>
						</MudLink>
					</MudTd>
					<MudTd>@TruncateText(context.Description, 60)</MudTd>
					@if (!_selectedGameId.HasValue)
					{
						<MudTd>@GetGameName(context.GameId)</MudTd>
					}
					<MudTd>
						@if (context.EventCount > 0)
						{
							<MudChip T="string" Color="Color.Info" Size="Size.Small">@context.EventCount</MudChip>
						}
						else
						{
							<span class="text-muted">0</span>
						}
					</MudTd>
					<MudTd>
						@if (context.NearbyLocationCount > 0)
						{
							<MudChip T="string" Color="Color.Secondary" Size="Size.Small">@context.NearbyLocationCount</MudChip>
						}
						else
						{
							<span class="text-muted">0</span>
						}
					</MudTd>
					<MudTd Style="text-align: right;">
						<MudTooltip Text="View Details">
							<MudIconButton Icon="@Icons.Material.Filled.Visibility"
							               Size="Size.Small"
							               Href="@($"/admin/locations/{context.Id}")"/>
						</MudTooltip>
						<MudTooltip Text="Edit Location">
							<MudIconButton Icon="@Icons.Material.Filled.Edit"
							               Size="Size.Small"
							               Href="@($"/admin/locations/{context.Id}/edit")"/>
						</MudTooltip>
					</MudTd>
				</RowTemplate>
			</MudTable>
		}
	</div>
</MudPaper>
