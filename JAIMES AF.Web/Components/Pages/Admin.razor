@page "/admin"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<PageTitle>Admin Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	@* Compact Admin Hero Section *@
	<div class="admin-hero admin-hero-compact pa-3 mb-3">
		<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="position: relative; z-index: 1;">
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
				<MudStack Spacing="0">
					<h1 class="admin-hero-title" style="font-size: 1.4rem;">Admin Dashboard</h1>
					<p class="admin-hero-subtitle" style="font-size: 0.8rem;">System management and monitoring</p>
				</MudStack>
			</MudStack>
			<MudLink Href="/" Class="admin-home-link pa-2">
				<MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
					<MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" />
					<MudText Typo="Typo.button" Style="font-size: 0.7rem; font-weight: 600;">Home</MudText>
				</MudStack>
			</MudLink>
		</MudStack>
	</div>

	@* Main Dashboard: 66:33 Split - Pipelines Left, Stats Right *@
	<MudGrid Spacing="3" Class="mb-3">
		@* Left Column (66%) - Stacked Pipeline Panels *@
		<MudItem xs="12" lg="8">
			<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
				<MudText Typo="Typo.overline" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
					PIPELINE STATUS
				</MudText>
				<MudButton Variant="Variant.Text" Color="Color.Info" Size="Size.Small" 
				           Href="/admin/monitoring" EndIcon="@Icons.Material.Filled.OpenInNew">
					View All
				</MudButton>
			</MudStack>
			
			@* Document Processing Pipeline *@
			<PipelineStatusPanel Class="mb-2" />
			
			@* Message Pipelines Row *@
			<MudGrid Spacing="2">
				<MudItem xs="12" md="6">
					<UserMessagePipelinePanel Style="height: 100%" />
				</MudItem>
				<MudItem xs="12" md="6">
					<AssistantMessagePipelinePanel Style="height: 100%" />
				</MudItem>
			</MudGrid>
		</MudItem>
		
		@* Right Column (33%) - Stats Dashboard *@
		<MudItem xs="12" lg="4">
			@* Content Overview *@
			<MudText Typo="Typo.overline" Class="mb-2" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
				CONTENT OVERVIEW
			</MudText>
			<MudPaper Elevation="0" Class="pa-2 mb-3" Style="background: linear-gradient(to bottom right, #f8f9fa, #ffffff); border-radius: 12px; border: 1px solid #e8e8e8;">
				<MudGrid Spacing="1">
					<MudItem xs="6">
						<MudLink Href="/games" Class="stat-card-link">
							<div class="stat-card stat-card-primary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.SportsEsports" Color="Color.Primary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_gamesCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Games</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/scenarios" Class="stat-card-link">
							<div class="stat-card stat-card-secondary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.MenuBook" Color="Color.Secondary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_scenariosCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Scenarios</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/players" Class="stat-card-link">
							<div class="stat-card stat-card-info">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Info" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_playersCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Characters</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/rulesets" Class="stat-card-link">
							<div class="stat-card stat-card-accent">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.AutoStories" Color="Color.Success" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_rulesetsCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Rulesets</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/rag-collections?category=rules" Class="stat-card-link">
							<div class="stat-card stat-card-warning">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Style="color: #F59E0B;" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_sourcebooksCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Sources</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/messages" Class="stat-card-link">
							<div class="stat-card stat-card-tertiary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Forum" Color="Color.Tertiary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_messagesCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Messages</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
				</MudGrid>
			</MudPaper>
			
			@* AI Quality Metrics *@
			<MudText Typo="Typo.overline" Class="mb-2" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
				AI QUALITY METRICS
			</MudText>
			<MudPaper Elevation="0" Class="pa-2" Style="background: linear-gradient(to bottom right, #f8f9fa, #ffffff); border-radius: 12px; border: 1px solid #e8e8e8;">
				<MudGrid Spacing="1">
					<MudItem xs="6">
						<MudLink Href="/admin/feedback" Class="stat-card-link">
							<div class="stat-card stat-card-primary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Feedback" Color="Color.Primary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_feedbackCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Feedback</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/sentiments" Class="stat-card-link">
							<div class="stat-card stat-card-secondary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.SentimentSatisfied" Color="Color.Secondary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_sentimentCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Sentiments</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/metrics" Class="stat-card-link">
							<div class="stat-card stat-card-tertiary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Tertiary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_metricsCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Evaluations</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/locations" Class="stat-card-link">
							<div class="stat-card stat-card-accent">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Place" Color="Color.Success" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_locationsCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Locations</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/test-cases" Class="stat-card-link">
							<div class="stat-card stat-card-warning">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Checklist" Style="color: #F59E0B;" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_testCasesCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Test Cases</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					<MudItem xs="6">
						<MudLink Href="/admin/test-reports" Class="stat-card-link">
							<div class="stat-card stat-card-primary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Summarize" Color="Color.Primary" Size="Size.Small" />
									<MudStack Spacing="0">
										<span class="stat-value-sm">@_testReportsCount</span>
										<MudText Typo="Typo.caption" Class="text-muted">Reports</MudText>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
				</MudGrid>
			</MudPaper>
		</MudItem>
	</MudGrid>

	@* Admin Tools Grid *@
	<MudGrid Spacing="3" Class="mb-6">
		@* Column 1: Adventure & Content *@
		<MudItem xs="12" sm="6" lg="3">
			<MudStack Spacing="3">
				<div class="admin-column-header adventure">
					<MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="Size.Small" />
					<MudText Typo="Typo.subtitle2">ADVENTURE</MudText>
				</div>
				<CompactLinkCard Icon="@Icons.Material.Filled.SportsEsports" IconColor="Color.Primary" Title="Games" Href="/games" />
				<CompactLinkCard Icon="@Icons.Material.Filled.MenuBook" IconColor="Color.Secondary" Title="Scenarios" Href="/scenarios" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Person" IconColor="Color.Info" Title="Characters" Href="/players" />
				<CompactLinkCard Icon="@Icons.Material.Filled.AutoStories" IconColor="Color.Success" Title="Rulesets" Href="/rulesets" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Place" IconColor="Color.Warning" Title="Locations" Href="/admin/locations" />
			</MudStack>
		</MudItem>

		@* Column 2: Platform & Intelligence *@
		<MudItem xs="12" sm="6" lg="3">
			<MudStack Spacing="3">
				<div class="admin-column-header platform">
					<MudIcon Icon="@Icons.Material.Filled.SettingsInputComponent" Size="Size.Small" />
					<MudText Typo="Typo.subtitle2">PLATFORM</MudText>
				</div>
				<CompactLinkCard Icon="@Icons.Material.Filled.SmartToy" IconColor="Color.Secondary" Title="Agents" Href="/agents" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Psychology" IconColor="Color.Error" Title="ML Models" Href="/admin/classification-models" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Inventory2" IconColor="Color.Info" Title="Sources / Transcripts" Href="/admin/rag-collections" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Monitor" IconColor="Color.Info" Title="Monitoring" Href="/admin/monitoring" />
			</MudStack>
		</MudItem>

		@* Column 3: Verification & Quality *@
		<MudItem xs="12" sm="6" lg="3">
			<MudStack Spacing="3">
				<div class="admin-column-header verification">
					<MudIcon Icon="@Icons.Material.Filled.FactCheck" Size="Size.Small" />
					<MudText Typo="Typo.subtitle2">EVALUATION</MudText>
				</div>
				<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Info" Title="Evaluators" Href="/admin/evaluators" />
				<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Error" Title="Test Evaluators" Href="/admin/evaluators/test" />
				<CompactLinkCard Icon="@Icons.Material.Filled.PieChart" IconColor="Color.Secondary" Title="Evaluations" Href="/admin/metrics" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Checklist" IconColor="Color.Success" Title="Test Cases" Href="/admin/test-cases" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Summarize" IconColor="Color.Info" Title="Test Reports" Href="/admin/test-reports" />
			</MudStack>
		</MudItem>

		@* Column 4: Diagnostics & Tools *@
		<MudItem xs="12" sm="6" lg="3">
			<MudStack Spacing="3">
				<div class="admin-column-header tools">
					<MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" />
					<MudText Typo="Typo.subtitle2">TOOLS AND FEEDBACK</MudText>
				</div>
				<CompactLinkCard Icon="@Icons.Material.Filled.ThumbUp" IconColor="Color.Primary" Title="Feedback" Href="/admin/feedback" />
				<CompactLinkCard Icon="@Icons.Material.Filled.SentimentSatisfied" IconColor="Color.Warning" Title="Sentiments" Href="/admin/sentiments" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Build" IconColor="Color.Primary" Title="Tool Usage" Href="/admin/tools" />
				<CompactLinkCard Icon="@Icons.Material.Filled.Science" IconColor="Color.Info" Title="Tool Testing" Href="/admin/tool-test" />
			</MudStack>
		</MudItem>
	</MudGrid>

	@* Advanced search section - Older pieces of content *@
	<div class="mt-8 mb-4">
		<MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600; opacity: 0.7;">
			OTHER TOOLS
		</MudText>
		<MudDivider Class="mb-4" Style="opacity: 0.1;" />
		<MudGrid Spacing="2">
			<MudItem xs="12" sm="3">
				<CompactLinkCard Icon="@Icons.Material.Filled.Search" IconColor="Color.Default" Title="Rules Search" Href="/tools/rules-search" />
			</MudItem>
			<MudItem xs="12" sm="3">
				<CompactLinkCard Icon="@Icons.Material.Filled.Forum" IconColor="Color.Default" Title="Conv. Search" Href="/tools/conversation-search" />
			</MudItem>
			<MudItem xs="12" sm="3">
				<CompactLinkCard Icon="@Icons.Material.Filled.LocationOn" IconColor="Color.Default" Title="Location Lookup" Href="/tools/location-lookup" />
			</MudItem>
			<MudItem xs="12" sm="3">
				<CompactLinkCard Icon="@Icons.Material.Filled.EditLocation" IconColor="Color.Default" Title="Location Mgmt" Href="/tools/location-management" />
			</MudItem>
		</MudGrid>
	</div>

</MudContainer>

@code {
	private List<BreadcrumbItem> _breadcrumbs = new();

	private int _gamesCount;
	private int _scenariosCount;
	private int _playersCount;
	private int _rulesetsCount;
	private int _sourcebooksCount;
	private int _messagesCount;
	private int _feedbackCount;
	private int _sentimentCount;
	private int _metricsCount;
	private int _locationsCount;
	private int _testCasesCount;
	private int _testReportsCount;

	protected override async Task OnInitializedAsync()
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Admin", href: null, disabled: true)
		};

		await LoadMetricsAsync();
	}

	private async Task LoadMetricsAsync()
	{
		var logger = LoggerFactory.CreateLogger("Admin");

		try
		{
			var stats = await Http.GetFromJsonAsync<DashboardStatsResponse>("/admin/dashboard/stats");
			if (stats != null)
			{
				_gamesCount = stats.GamesCount;
				_scenariosCount = stats.ScenariosCount;
				_playersCount = stats.PlayersCount;
				_rulesetsCount = stats.RulesetsCount;
				_sourcebooksCount = stats.SourcebooksCount;
				_messagesCount = stats.MessagesCount;
				_feedbackCount = stats.FeedbackCount;
				_sentimentCount = stats.SentimentsCount;
				_metricsCount = stats.EvaluationsCount;
				_locationsCount = stats.LocationsCount;
				_testCasesCount = stats.TestCasesCount;
				_testReportsCount = stats.TestReportsCount;
			}
		}
		catch (Exception ex)
		{
			logger.LogError(ex, "Failed to load admin metrics");
		}
	}
}
