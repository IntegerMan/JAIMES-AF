@page "/admin"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<PageTitle>Admin Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	@* Header *@
	<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
		<MudStack Spacing="0">
			<MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="pa-0" />
			<MudText Typo="Typo.h5" Style="font-weight: 600;">Admin Dashboard</MudText>
		</MudStack>
	</MudStack>

	@* Dashboard Row: Pipeline Status + Content Metrics *@
	<MudGrid Spacing="3" Class="mb-3">
		<MudItem xs="12" md="6">
			<MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">Pipeline Status</MudText>
			<PipelineStatusPanel Class="mb-4" />
			<MudGrid Spacing="3" Class="mb-6">
				<MudItem xs="12" md="6">
					<UserMessagePipelinePanel />
				</MudItem>
				<MudItem xs="12" md="6">
					<AssistantMessagePipelinePanel />
				</MudItem>
			</MudGrid>
		</MudItem>
		<MudItem xs="12" md="6">
			<MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
				<MudText Typo="Typo.subtitle2" Class="mb-2 text-muted">Content Overview</MudText>
				<MudGrid Spacing="2">
					<MudItem xs="6" sm="3">
						<MudStack AlignItems="AlignItems.Center" Spacing="0">
							<MudIcon Icon="@Icons.Material.Filled.SportsEsports" Color="Color.Primary" />
							<MudText Typo="Typo.h6">@_gamesCount</MudText>
							<MudText Typo="Typo.caption" Class="text-muted">Games</MudText>
						</MudStack>
					</MudItem>
					<MudItem xs="6" sm="3">
						<MudStack AlignItems="AlignItems.Center" Spacing="0">
							<MudIcon Icon="@Icons.Material.Filled.MenuBook" Color="Color.Secondary" />
							<MudText Typo="Typo.h6">@_scenariosCount</MudText>
							<MudText Typo="Typo.caption" Class="text-muted">Scenarios</MudText>
						</MudStack>
					</MudItem>
					<MudItem xs="6" sm="3">
						<MudStack AlignItems="AlignItems.Center" Spacing="0">
							<MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Info" />
							<MudText Typo="Typo.h6">@_playersCount</MudText>
							<MudText Typo="Typo.caption" Class="text-muted">Characters</MudText>
						</MudStack>
					</MudItem>
					<MudItem xs="6" sm="3">
						<MudStack AlignItems="AlignItems.Center" Spacing="0">
							<MudIcon Icon="@Icons.Material.Filled.AutoStories" Color="Color.Success" />
							<MudText Typo="Typo.h6">@_rulesetsCount</MudText>
							<MudText Typo="Typo.caption" Class="text-muted">Rulesets</MudText>
						</MudStack>
					</MudItem>
				</MudGrid>
			</MudPaper>
		</MudItem>
	</MudGrid>

	@* AI Quality Summary *@
	<MudPaper Class="pa-3 mb-3" Elevation="1">
		<MudStack Row="true" Justify="Justify.SpaceAround" AlignItems="AlignItems.Center" Style="flex-wrap: wrap;">
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
				<MudIcon Icon="@Icons.Material.Filled.Feedback" Color="Color.Primary" Size="Size.Large" />
				<MudStack Spacing="0">
					<MudText Typo="Typo.h6">@_feedbackCount</MudText>
					<MudText Typo="Typo.caption" Class="text-muted">Feedback Items</MudText>
				</MudStack>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
				<MudIcon Icon="@Icons.Material.Filled.SentimentSatisfied" Color="Color.Secondary" Size="Size.Large" />
				<MudStack Spacing="0">
					<MudText Typo="Typo.h6">@_sentimentCount</MudText>
					<MudText Typo="Typo.caption" Class="text-muted">Sentiments Analyzed</MudText>
				</MudStack>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
				<MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Info" Size="Size.Large" />
				<MudStack Spacing="0">
					<MudText Typo="Typo.h6">@_metricsCount</MudText>
					<MudText Typo="Typo.caption" Class="text-muted">Evaluations</MudText>
				</MudStack>
			</MudStack>
			<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pa-2">
				<MudIcon Icon="@Icons.Material.Filled.Place" Color="Color.Success" Size="Size.Large" />
				<MudStack Spacing="0">
					<MudText Typo="Typo.h6">@_locationsCount</MudText>
					<MudText Typo="Typo.caption" Class="text-muted">Locations</MudText>
				</MudStack>
			</MudStack>
		</MudStack>
	</MudPaper>

	@* Collapsible Tool Sections *@
	<MudExpansionPanels Class="admin-expansion-panel" MultiExpansion="true">

		@* Content Management *@
		<MudExpansionPanel Text="Content Management" MaxHeight="400" Expanded="true">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" />
					<MudText Typo="Typo.subtitle1" Style="font-weight: 500;">Content Management</MudText>
					<MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">5</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SportsEsports" IconColor="Color.Primary"
						                 Title="Games" Href="/games"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.MenuBook" IconColor="Color.Secondary"
						                 Title="Scenarios" Href="/scenarios"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Person" IconColor="Color.Info"
						                 Title="Players" Href="/players"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.AutoStories" IconColor="Color.Success"
						                 Title="Rulesets" Href="/rulesets"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Place" IconColor="Color.Warning"
						                 Title="Locations" Href="/admin/locations"  />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

		@* Agent Management *@
		<MudExpansionPanel Text="Agent Management" MaxHeight="400" Expanded="true">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Secondary" />
					<MudText Typo="Typo.subtitle1" Style="font-weight: 500;">Agent Management</MudText>
					<MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Outlined">7</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SmartToy" IconColor="Color.Secondary"
						                 Title="Agents" Href="/agents"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Build" IconColor="Color.Primary"
						                 Title="Tool Usage" Href="/admin/tools"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Info"
						                 Title="Evaluators" Href="/admin/evaluators"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Assessment" IconColor="Color.Success"
						                 Title="Metrics" Href="/admin/metrics"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Feedback" IconColor="Color.Warning"
						                 Title="Feedback" Href="/admin/feedback"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SentimentSatisfied" IconColor="Color.Error"
						                 Title="Sentiments" Href="/admin/sentiments"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.ModelTraining" IconColor="Color.Primary"
						                 Title="ML Models" Href="/admin/classification-models"  />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

		@* Testing & Diagnostics *@
		<MudExpansionPanel Text="Testing & Diagnostics" MaxHeight="500" Expanded="true">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudIcon Icon="@Icons.Material.Filled.BugReport" Color="Color.Info" />
					<MudText Typo="Typo.subtitle1" Style="font-weight: 500;">Testing & Diagnostics</MudText>
					<MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">9</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Science" IconColor="Color.Info"
						                 Title="Tool Testing" Href="/admin/tool-test"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Search" IconColor="Color.Primary"
						                 Title="Rules Search" Href="/tools/rules-search"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Forum" IconColor="Color.Secondary"
						                 Title="Conversation Search" Href="/tools/conversation-search"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.LocationOn" IconColor="Color.Success"
						                 Title="Location Lookup" Href="/tools/location-lookup"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.EditLocation" IconColor="Color.Warning"
						                 Title="Location Mgmt" Href="/tools/location-management"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Error"
						                 Title="Test Evaluators" Href="/admin/evaluators/test"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Storage" IconColor="Color.Primary"
						                 Title="RAG Collections" Href="/admin/rag-collections"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Checklist" IconColor="Color.Success"
						                 Title="Test Cases" Href="/admin/test-cases"  />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Summarize" IconColor="Color.Info"
						                 Title="Test Reports" Href="/admin/test-reports"  />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

	</MudExpansionPanels>

</MudContainer>

@code {
	private List<BreadcrumbItem> _breadcrumbs = new();

	private int _gamesCount;
	private int _scenariosCount;
	private int _playersCount;
	private int _rulesetsCount;
	private int _feedbackCount;
	private int _sentimentCount;
	private int _metricsCount;
	private int _locationsCount;

	protected override async Task OnInitializedAsync()
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Admin", href: null, disabled: true)
		};

		await LoadMetricsAsync();
	}

	private async Task LoadMetricsAsync()
	{
		var logger = LoggerFactory.CreateLogger("Admin");

		try
		{
			// Fetch content counts in parallel
			var gamesTask = Http.GetFromJsonAsync<ListGamesResponse>("/games");
			var scenariosTask = Http.GetFromJsonAsync<ScenarioListResponse>("/scenarios");
			var playersTask = Http.GetFromJsonAsync<PlayerListResponse>("/players");
			var rulesetsTask = Http.GetFromJsonAsync<RulesetListResponse>("/rulesets");
			var feedbackTask = Http.GetFromJsonAsync<FeedbackListResponse>("/admin/feedback?pageSize=1");
			var sentimentTask = Http.GetFromJsonAsync<SentimentListResponse>("/admin/sentiments?pageSize=1");
			var metricsTask = Http.GetFromJsonAsync<EvaluationMetricListResponse>("/admin/metrics?pageSize=1");
			var locationsTask = Http.GetFromJsonAsync<LocationListResponse>("/admin/locations");

			await Task.WhenAll(gamesTask, scenariosTask, playersTask, rulesetsTask,
			                   feedbackTask, sentimentTask, metricsTask, locationsTask);

			_gamesCount = gamesTask.Result?.Games?.Length ?? 0;
			_scenariosCount = scenariosTask.Result?.Scenarios?.Length ?? 0;
			_playersCount = playersTask.Result?.Players?.Length ?? 0;
			_rulesetsCount = rulesetsTask.Result?.Rulesets?.Length ?? 0;
			_feedbackCount = feedbackTask.Result?.TotalCount ?? 0;
			_sentimentCount = sentimentTask.Result?.TotalCount ?? 0;
			_metricsCount = metricsTask.Result?.TotalCount ?? 0;
			_locationsCount = locationsTask.Result?.Locations?.Length ?? 0;
		}
		catch (Exception ex)
		{
			logger.LogError(ex, "Failed to load admin metrics");
		}
	}
}
