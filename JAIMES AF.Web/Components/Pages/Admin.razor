@page "/admin"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<PageTitle>Admin Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	@* Premium Admin Hero Section *@
	<div class="admin-hero pa-4 mb-4">
		@* Floating Particles *@
		<div class="hero-particles">
			<div class="particle"></div>
			<div class="particle"></div>
			<div class="particle"></div>
			<div class="particle"></div>
		</div>
		
		<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="position: relative; z-index: 1;">
			<MudStack Spacing="1">
				<MudBreadcrumbs Items="_breadcrumbs" Separator=">" Class="pa-0 admin-breadcrumbs" />
				<h1 class="admin-hero-title">Admin Dashboard</h1>
				<p class="admin-hero-subtitle">System management and monitoring</p>
			</MudStack>
			<MudLink Href="/" Class="admin-home-link pa-2">
				<MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
					<MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" />
					<MudText Typo="Typo.button" Style="font-size: 0.75rem; font-weight: 600;">Back to Home</MudText>
				</MudStack>
			</MudLink>
		</MudStack>
	</div>

	@* Dashboard Row: Pipeline Status + Content Metrics *@
	<MudGrid Spacing="3" Class="mb-4">
		<MudItem xs="12" lg="7">
			<MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
				PIPELINE STATUS
			</MudText>
			<PipelineStatusPanel Class="mb-4" />
			<MudGrid Spacing="3">
				<MudItem xs="12" md="6">
					<UserMessagePipelinePanel />
				</MudItem>
				<MudItem xs="12" md="6">
					<AssistantMessagePipelinePanel />
				</MudItem>
			</MudGrid>
		</MudItem>
		
		<MudItem xs="12" lg="5">
			<MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
				CONTENT OVERVIEW
			</MudText>
			<MudPaper Elevation="0" Class="pa-3" Style="background: linear-gradient(to bottom right, #f8f9fa, #ffffff); border-radius: 16px; border: 1px solid #e8e8e8;">
				<MudGrid Spacing="2">
					<MudItem xs="6">
						<MudLink Href="/games" Class="stat-card-link">
							<div class="stat-card stat-card-primary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.SportsEsports" Color="Color.Primary" />
									<MudStack Spacing="0">
										<MudText Typo="Typo.caption" Class="text-muted">Active Games</MudText>
										<span class="stat-value">@_gamesCount</span>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					
					<MudItem xs="6">
						<MudLink Href="/scenarios" Class="stat-card-link">
							<div class="stat-card stat-card-secondary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.MenuBook" Color="Color.Secondary" />
									<MudStack Spacing="0">
										<MudText Typo="Typo.caption" Class="text-muted">Scenarios</MudText>
										<span class="stat-value">@_scenariosCount</span>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					
					<MudItem xs="6">
						<MudLink Href="/players" Class="stat-card-link">
							<div class="stat-card stat-card-tertiary">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Tertiary" />
									<MudStack Spacing="0">
										<MudText Typo="Typo.caption" Class="text-muted">Characters</MudText>
										<span class="stat-value">@_playersCount</span>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
					
					<MudItem xs="6">
						<MudLink Href="/rulesets" Class="stat-card-link">
							<div class="stat-card stat-card-accent">
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
									<MudIcon Icon="@Icons.Material.Filled.AutoStories" Color="Color.Success" />
									<MudStack Spacing="0">
										<MudText Typo="Typo.caption" Class="text-muted">Rulesets</MudText>
										<span class="stat-value">@_rulesetsCount</span>
									</MudStack>
								</MudStack>
							</div>
						</MudLink>
					</MudItem>
				</MudGrid>
			</MudPaper>
		</MudItem>
	</MudGrid>

	@* AI Quality Summary - Enhanced Glass Card *@
	<MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
		AI QUALITY METRICS
	</MudText>
	<div class="glass-card pa-4 mb-4">
		<MudGrid Spacing="3">
			<MudItem xs="6" sm="3">
				<MudLink Href="/admin/feedback" Class="stat-card-link">
					<div class="stat-card stat-card-primary" style="text-align: center;">
						<MudStack AlignItems="AlignItems.Center" Spacing="1">
							<div class="icon-badge icon-badge-primary" style="width: 42px; height: 42px; border-radius: 10px;">
								<MudIcon Icon="@Icons.Material.Filled.Feedback" Style="color: white; font-size: 1.25rem;" />
							</div>
							<span class="stat-value">@_feedbackCount</span>
							<MudText Typo="Typo.caption" Class="text-muted">Feedback Items</MudText>
						</MudStack>
					</div>
				</MudLink>
			</MudItem>
			<MudItem xs="6" sm="3">
				<MudLink Href="/admin/sentiments" Class="stat-card-link">
					<div class="stat-card stat-card-secondary" style="text-align: center;">
						<MudStack AlignItems="AlignItems.Center" Spacing="1">
							<div class="icon-badge icon-badge-secondary" style="width: 42px; height: 42px; border-radius: 10px;">
								<MudIcon Icon="@Icons.Material.Filled.SentimentSatisfied" Style="color: white; font-size: 1.25rem;" />
							</div>
							<span class="stat-value">@_sentimentCount</span>
							<MudText Typo="Typo.caption" Class="text-muted">Sentiments</MudText>
						</MudStack>
					</div>
				</MudLink>
			</MudItem>
			<MudItem xs="6" sm="3">
				<MudLink Href="/admin/metrics" Class="stat-card-link">
					<div class="stat-card stat-card-tertiary" style="text-align: center;">
						<MudStack AlignItems="AlignItems.Center" Spacing="1">
							<div class="icon-badge icon-badge-tertiary" style="width: 42px; height: 42px; border-radius: 10px;">
								<MudIcon Icon="@Icons.Material.Filled.Assessment" Style="color: white; font-size: 1.25rem;" />
							</div>
							<span class="stat-value">@_metricsCount</span>
							<MudText Typo="Typo.caption" Class="text-muted">Evaluations</MudText>
						</MudStack>
					</div>
				</MudLink>
			</MudItem>
			<MudItem xs="6" sm="3">
				<MudLink Href="/admin/locations" Class="stat-card-link">
					<div class="stat-card stat-card-accent" style="text-align: center;">
						<MudStack AlignItems="AlignItems.Center" Spacing="1">
							<div class="icon-badge icon-badge-accent" style="width: 42px; height: 42px; border-radius: 10px;">
								<MudIcon Icon="@Icons.Material.Filled.Place" Style="color: white; font-size: 1.25rem;" />
							</div>
							<span class="stat-value">@_locationsCount</span>
							<MudText Typo="Typo.caption" Class="text-muted">Locations</MudText>
						</MudStack>
					</div>
				</MudLink>
			</MudItem>
		</MudGrid>
	</div>

	@* Tool Sections Header *@
	<MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px; color: #7B2CBF; font-weight: 600;">
		ADMIN TOOLS
	</MudText>

	@* Collapsible Tool Sections *@
	<MudExpansionPanels Class="admin-expansion-panel-enhanced" MultiExpansion="true">

		@* Content Management *@
		<MudExpansionPanel MaxHeight="400" Expanded="true" Class="admin-panel-content">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<div class="panel-icon-badge panel-icon-content">
						<MudIcon Icon="@Icons.Material.Filled.Folder" Style="color: white; font-size: 1rem;" />
					</div>
					<MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Content Management</MudText>
					<MudChip T="string" Size="Size.Small" Style="background: linear-gradient(135deg, #7B2CBF, #9D4EDD); color: white;">5</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2" Class="pa-2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SportsEsports" IconColor="Color.Primary"
						                 Title="Games" Href="/games" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.MenuBook" IconColor="Color.Secondary"
						                 Title="Scenarios" Href="/scenarios" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Person" IconColor="Color.Info"
						                 Title="Players" Href="/players" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.AutoStories" IconColor="Color.Success"
						                 Title="Rulesets" Href="/rulesets" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Place" IconColor="Color.Warning"
						                 Title="Locations" Href="/admin/locations" />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

		@* Agent Management *@
		<MudExpansionPanel MaxHeight="400" Expanded="true" Class="admin-panel-agents">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<div class="panel-icon-badge panel-icon-agents">
						<MudIcon Icon="@Icons.Material.Filled.SmartToy" Style="color: white; font-size: 1rem;" />
					</div>
					<MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Agent Management</MudText>
					<MudChip T="string" Size="Size.Small" Style="background: linear-gradient(135deg, #4361EE, #5A78EE); color: white;">7</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2" Class="pa-2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SmartToy" IconColor="Color.Secondary"
						                 Title="Agents" Href="/agents" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Build" IconColor="Color.Primary"
						                 Title="Tool Usage" Href="/admin/tools" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Info"
						                 Title="Evaluators" Href="/admin/evaluators" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Assessment" IconColor="Color.Success"
						                 Title="Metrics" Href="/admin/metrics" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Feedback" IconColor="Color.Warning"
						                 Title="Feedback" Href="/admin/feedback" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.SentimentSatisfied" IconColor="Color.Error"
						                 Title="Sentiments" Href="/admin/sentiments" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.ModelTraining" IconColor="Color.Primary"
						                 Title="ML Models" Href="/admin/classification-models" />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

		@* Testing & Diagnostics *@
		<MudExpansionPanel MaxHeight="500" Expanded="true" Class="admin-panel-testing">
			<TitleContent>
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<div class="panel-icon-badge panel-icon-testing">
						<MudIcon Icon="@Icons.Material.Filled.BugReport" Style="color: white; font-size: 1rem;" />
					</div>
					<MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Testing & Diagnostics</MudText>
					<MudChip T="string" Size="Size.Small" Style="background: linear-gradient(135deg, #4CC9F0, #70D6F4); color: #1a1a2e;">9</MudChip>
				</MudStack>
			</TitleContent>
			<ChildContent>
				<MudGrid Spacing="2" Class="pa-2">
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Science" IconColor="Color.Info"
						                 Title="Tool Testing" Href="/admin/tool-test" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Search" IconColor="Color.Primary"
						                 Title="Rules Search" Href="/tools/rules-search" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Forum" IconColor="Color.Secondary"
						                 Title="Conv. Search" Href="/tools/conversation-search" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.LocationOn" IconColor="Color.Success"
						                 Title="Location Lookup" Href="/tools/location-lookup" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.EditLocation" IconColor="Color.Warning"
						                 Title="Location Mgmt" Href="/tools/location-management" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.RateReview" IconColor="Color.Error"
						                 Title="Test Evaluators" Href="/admin/evaluators/test" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Storage" IconColor="Color.Primary"
						                 Title="RAG Collections" Href="/admin/rag-collections" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Checklist" IconColor="Color.Success"
						                 Title="Test Cases" Href="/admin/test-cases" />
					</MudItem>
					<MudItem xs="6" sm="4" md="2">
						<CompactLinkCard Icon="@Icons.Material.Filled.Summarize" IconColor="Color.Info"
						                 Title="Test Reports" Href="/admin/test-reports" />
					</MudItem>
				</MudGrid>
			</ChildContent>
		</MudExpansionPanel>

	</MudExpansionPanels>

</MudContainer>

@code {
	private List<BreadcrumbItem> _breadcrumbs = new();

	private int _gamesCount;
	private int _scenariosCount;
	private int _playersCount;
	private int _rulesetsCount;
	private int _feedbackCount;
	private int _sentimentCount;
	private int _metricsCount;
	private int _locationsCount;

	protected override async Task OnInitializedAsync()
	{
		_breadcrumbs = new List<BreadcrumbItem>
		{
			new BreadcrumbItem("Home", href: "/"),
			new BreadcrumbItem("Admin", href: null, disabled: true)
		};

		await LoadMetricsAsync();
	}

	private async Task LoadMetricsAsync()
	{
		var logger = LoggerFactory.CreateLogger("Admin");

		try
		{
			// Fetch content counts in parallel
			var gamesTask = Http.GetFromJsonAsync<ListGamesResponse>("/games");
			var scenariosTask = Http.GetFromJsonAsync<ScenarioListResponse>("/scenarios");
			var playersTask = Http.GetFromJsonAsync<PlayerListResponse>("/players");
			var rulesetsTask = Http.GetFromJsonAsync<RulesetListResponse>("/rulesets");
			var feedbackTask = Http.GetFromJsonAsync<FeedbackListResponse>("/admin/feedback?pageSize=1");
			var sentimentTask = Http.GetFromJsonAsync<SentimentListResponse>("/admin/sentiments?pageSize=1");
			var metricsTask = Http.GetFromJsonAsync<EvaluationMetricListResponse>("/admin/metrics?pageSize=1");
			var locationsTask = Http.GetFromJsonAsync<LocationListResponse>("/admin/locations");

			await Task.WhenAll(gamesTask, scenariosTask, playersTask, rulesetsTask,
			                   feedbackTask, sentimentTask, metricsTask, locationsTask);

			_gamesCount = gamesTask.Result?.Games?.Length ?? 0;
			_scenariosCount = scenariosTask.Result?.Scenarios?.Length ?? 0;
			_playersCount = playersTask.Result?.Players?.Length ?? 0;
			_rulesetsCount = rulesetsTask.Result?.Rulesets?.Length ?? 0;
			_feedbackCount = feedbackTask.Result?.TotalCount ?? 0;
			_sentimentCount = sentimentTask.Result?.TotalCount ?? 0;
			_metricsCount = metricsTask.Result?.TotalCount ?? 0;
			_locationsCount = locationsTask.Result?.Locations?.Length ?? 0;
		}
		catch (Exception ex)
		{
			logger.LogError(ex, "Failed to load admin metrics");
		}
	}
}
