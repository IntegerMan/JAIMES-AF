@page "/agents/{AgentId}/versions/{VersionId:int}"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<PageTitle>Agent Version Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
            <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
        </MudStack>

        @if (_isLoading)
        {
            <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                <MudProgressCircular Indeterminate="true"/>
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/agents/{AgentId}")">
                Back to Agent
            </MudButton>
        }
        else if (_version is not null)
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
                <MudText Typo="Typo.h4">Version @_version.VersionNumber</MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    @if (_version.IsActive)
                    {
                        <MudChip T="string" Color="Color.Success" Class="mr-4">Active Version</MudChip>
                    }

                    <MudTooltip Text="Previous Version">
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                                       Color="Color.Primary"
                                       Disabled="@(!_previousVersionId.HasValue)"
                                       Href="@(_previousVersionId.HasValue ? $"/agents/{AgentId}/versions/{_previousVersionId}" : null)"/>
                    </MudTooltip>

                    <MudTooltip Text="Next Version">
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                       Color="Color.Primary"
                                       Disabled="@(!_nextVersionId.HasValue)"
                                       Href="@(_nextVersionId.HasValue ? $"/agents/{AgentId}/versions/{_nextVersionId}" : null)"/>
                    </MudTooltip>
                </MudStack>
            </MudStack>

            <MudGrid Spacing="3" Class="mb-4">
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption" Class="text-muted">Agent</MudText>
                    <MudLink Href="@($"/agents/{AgentId}")" Typo="Typo.body1">
                        @(_agentName ?? AgentId)
                    </MudLink>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption" Class="text-muted">Version Number</MudText>
                    <MudText Typo="Typo.body1">@_version.VersionNumber</MudText>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.caption" Class="text-muted">Created</MudText>
                    <MudText Typo="Typo.body1">@_version.CreatedAt.ToString("yyyy-MM-dd HH:mm")</MudText>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4"/>

            <MudText Typo="Typo.h6" Class="mb-3">Instructions</MudText>
            <MudPaper Class="pa-4" Elevation="1" Style="background-color: var(--mud-palette-background-grey);">
                <MudText Style="white-space: pre-wrap; font-family: monospace;">@_version.Instructions</MudText>
            </MudPaper>

            <MudStack Row="true" Class="mt-4" Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Href="@($"/agents/{AgentId}/edit?baseVersionId={VersionId}")">
                    Create New Version
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.AutoAwesome"
                           Href="@($"/agents/{AgentId}/versions/{VersionId}/improve")">
                    Improve
                </MudButton>
            </MudStack>

            <MudDivider Class="my-4"/>

            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                <MudText Typo="Typo.h5">Version Analysis</MudText>
                @if (_activeTabIndex is 0 or 1 or 3 or 4)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.AutoAwesome"
                               OnClick="GenerateInsightsForActiveTabAsync"
                               Disabled="_isGeneratingInsights">
                        @if (_isGeneratingInsights)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <span class="ms-2">Analyzing...</span>
                        }
                        else
                        {
                            <span>Generate Insights</span>
                        }
                    </MudButton>
                }
            </MudStack>

            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3" @bind-ActivePanelIndex="_activeTabIndex">
                <MudTabPanel Text="Messages">
                    <MattEland.Jaimes.Web.Components.Agents.AgentMessagesList @ref="_messagesGrid" AgentId="@AgentId" VersionId="@VersionId"/>
                </MudTabPanel>
                <MudTabPanel Text="Feedback">
                    <MattEland.Jaimes.Web.Components.Shared.FeedbackGrid @ref="_feedbackGrid" AgentId="@AgentId" InstructionVersionId="@VersionId"/>
                </MudTabPanel>
                <MudTabPanel Text="Tool Usage">
                    <MattEland.Jaimes.Web.Components.Shared.ToolUsageGrid AgentId="@AgentId" InstructionVersionId="@VersionId"/>
                </MudTabPanel>
                <MudTabPanel Text="Metrics">
                    <MattEland.Jaimes.Web.Components.Shared.MetricsGrid @ref="_metricsGrid" AgentId="@AgentId" InstructionVersionId="@VersionId"/>
                </MudTabPanel>
                <MudTabPanel Text="Sentiment">
                    <MattEland.Jaimes.Web.Components.Shared.SentimentGrid @ref="_sentimentGrid" AgentId="@AgentId" InstructionVersionId="@VersionId"/>
                </MudTabPanel>
            </MudTabs>
        }
    </MudPaper>
</MudContainer>
