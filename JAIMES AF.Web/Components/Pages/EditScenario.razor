@page "/scenarios/{ScenarioId}/edit"
@rendermode InteractiveServer

<PageTitle>Edit Scenario</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
	<MudPaper Class="pa-4">
		<MudText Typo="Typo.h4" Class="mb-4">Edit Scenario</MudText>

		@if (isLoading)
		{
			<MudProgressCircular Indeterminate="true" Class="my-4" />
		}
		else if (!string.IsNullOrEmpty(errorMessage))
		{
			<MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
		}

		@if (!isLoading && !string.IsNullOrEmpty(errorMessage) && errorMessage.Contains("not found"))
		{
			<MudButton Variant="Variant.Text" Color="Color.Primary" Href="/scenarios" Class="mt-2">
				Back to Scenarios
			</MudButton>
		}

		@if (!isLoading && string.IsNullOrEmpty(errorMessage))
		{
			<MudForm>
				<MudTextField Value="@ScenarioId"
				              Label="Scenario ID"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="true"
				              HelperText="Scenario ID cannot be changed" />

				<MudSelect T="string"
				           @bind-Value="selectedRulesetId"
				           Label="Ruleset"
				           Variant="Variant.Outlined"
				           Class="mb-4"
				           Disabled="isSaving"
				           Required="true"
				           RequiredError="Please select a ruleset">
					@foreach (var ruleset in rulesets)
					{
						<MudSelectItem Value="@ruleset.Id">@ruleset.Name</MudSelectItem>
					}
				</MudSelect>

				<MudTextField @bind-Value="name"
				              Label="Name"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="isSaving"
				              Required="true"
				              RequiredError="Name is required" />

				<MudTextField @bind-Value="description"
				              Label="Description"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="isSaving"
				              Lines="2" />

				<MudTextField @bind-Value="systemPrompt"
				              Label="System Prompt"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="isSaving"
				              Required="true"
				              RequiredError="System Prompt is required"
				              Lines="5"
				              HelperText="Instructions for the AI game master on how to run this scenario" />

				<MudTextField @bind-Value="newGameInstructions"
				              Label="New Game Instructions"
				              Variant="Variant.Outlined"
				              Class="mb-4"
				              Disabled="isSaving"
				              Required="true"
				              RequiredError="New Game Instructions is required"
				              Lines="5"
				              HelperText="The initial message shown to players when starting a new game with this scenario" />

				<div class="d-flex gap-2">
					<MudButton Variant="Variant.Filled" 
					           Color="Color.Primary" 
					           OnClick="UpdateScenarioAsync" 
					           Disabled="isSaving || !IsFormValid()"
					           Class="mt-2">
						@if (isSaving)
						{
							<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
							<span class="ms-2">Saving...</span>
						}
						else
						{
							<span>Save Changes</span>
						}
					</MudButton>

					<MudButton Variant="Variant.Text" 
					           Color="Color.Default" 
					           OnClick="Cancel" 
					           Disabled="isSaving"
					           Class="mt-2">
						Cancel
					</MudButton>
				</div>
			</MudForm>
		}
	</MudPaper>
</MudContainer>

