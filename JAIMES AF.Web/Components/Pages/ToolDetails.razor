@page "/admin/tools/{ToolName}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Pages
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Tool Details - @ToolName</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    <CompactHeroSection Title="@ToolName"
                        Icon="@Icons.Material.Filled.Build"
                        Theme="CompactHeroSection.HeroTheme.Info"
                        Subtitle="@_toolDescription"
                        SubtitleNoItems="Tool call history"
                        ActionText="All Tools"
                        ActionHref="/admin/tools"
                        ActionIcon="@Icons.Material.Filled.List" />

    <MudDataGrid T="ToolCallDetailDto"
                 ServerData="ServerReload"
                 Filterable="false"
                 Hover="true"
                 Dense="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.CreatedAt" Title="Time">
                <CellTemplate>
                    <MudLink Href="@($"/admin/tool-calls/{context.Item.Id}")">
                        @context.Item.CreatedAt.ToLocalTime().ToString("g")
                    </MudLink>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.GameName" Title="Game">
                <CellTemplate>
                    @if (context.Item.GameId.HasValue)
                    {
                        <MudLink Href="@($"/games/{context.Item.GameId}")" Target="_blank">
                            @(context.Item.GameName ?? "Unknown Game")
                        </MudLink>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="text-muted">N/A</MudText>
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.AgentName" Title="Agent">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.AgentId))
                    {
                        <MattEland.Jaimes.Web.Components.Shared.AgentVersionDisplay 
                            AgentId="@context.Item.AgentId" 
                            AgentName="@(context.Item.AgentName ?? "Unknown")" 
                            VersionId="@context.Item.InstructionVersionId"
                            VersionNumber="@context.Item.AgentVersion" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="text-muted">Unknown</MudText>
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.FeedbackIsPositive" Title="Feedback" Sortable="false">
                <CellTemplate>
                    @if (context.Item.FeedbackIsPositive.HasValue)
                    {
                        var isPositive = context.Item.FeedbackIsPositive.Value;
                        var icon = isPositive ? Icons.Material.Filled.ThumbUp : Icons.Material.Filled.ThumbDown;
                        var color = isPositive ? Color.Success : Color.Error;
                        var feedbackUrl = $"/admin/feedback?toolName={Uri.EscapeDataString(ToolName)}&isPositive={isPositive}";

                        <MudTooltip Text="@(context.Item.FeedbackComment ?? (isPositive ? "Helpful" : "Unhelpful"))" Placement="Placement.Top">
                            <MudIconButton Icon="@icon"
                                           Color="@color"
                                           Size="Size.Small"
                                           Href="@feedbackUrl" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">None</MudText>
                    }
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Actions">
                <CellTemplate>
                    <MudStack Row="true" Spacing="0">
                        <MudTooltip Text="View Details" Placement="Placement.Top">
                            <MudIconButton Icon="@Icons.Material.Filled.Info" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           Href="@($"/admin/tool-calls/{context.Item.Id}")" />
                        </MudTooltip>
                        @if (context.Item.GameId.HasValue)
                        {
                            <MudTooltip Text="Go to Game" Placement="Placement.Top">
                                <MudIconButton Icon="@Icons.Material.Filled.Gamepad" 
                                               Color="Color.Secondary" 
                                               Size="Size.Small"
                                               Href="@($"/games/{context.Item.GameId}")"
                                               Target="_blank" />
                            </MudTooltip>
                        }
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="ToolCallDetailDto" />
        </PagerContent>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Class="pa-4">
                No calls recorded for this tool.
            </MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    [Parameter]
    public string ToolName { get; set; } = string.Empty;

    /// <summary>
    /// Optional agent ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public string? AgentId { get; set; }

    /// <summary>
    /// Optional instruction version ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public int? InstructionVersionId { get; set; }

    /// <summary>
    /// Optional game ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? GameId { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override void OnInitialized()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Tool Usage", href: "/admin/tools"),
            new BreadcrumbItem(ToolName, href: null, disabled: true)
        };
    }

    private string? _toolDescription;

    private async Task<GridData<ToolCallDetailDto>> ServerReload(GridState<ToolCallDetailDto> state, CancellationToken cancellationToken)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");

            // MudDataGrid uses 0-based index, API uses 1-based page
            int page = state.Page + 1;
            int pageSize = state.PageSize;

            // Build query string with optional filters
            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrEmpty(AgentId))
                queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
            if (InstructionVersionId.HasValue)
                queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
            if (GameId.HasValue)
                queryParams.Add($"gameId={GameId.Value}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<ToolCallDetailListResponse>(
                $"/admin/tools/{Uri.EscapeDataString(ToolName)}?{queryString}");

            if (response != null)
            {
                _toolDescription = response.ToolDescription;
                
                return new GridData<ToolCallDetailDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception)
        {
            // Handle error (maybe show snackbar)
        }

        return new GridData<ToolCallDetailDto>
        {
            TotalItems = 0,
            Items = []
        };
    }
}
