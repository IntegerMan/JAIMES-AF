@page "/admin/tools"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<PageTitle>Tool Usage</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    <CompactHeroSection Title="Tool Usage Statistics"
                        Icon="@Icons.Material.Filled.Build"
                        Theme="CompactHeroSection.HeroTheme.Info"
                        ItemCount="@_stats?.TotalCount"
                        ItemName="tool"
                        Subtitle="tracked"
                        SubtitleNoItems="No tools registered yet"
                        ActionText="Test Tools"
                        ActionHref="/admin/tool-test"
                        ActionIcon="@Icons.Material.Filled.Science" />

    @if (_stats != null)
    {
        <MudGrid Class="mb-4" Spacing="3">
            <MudItem xs="6" sm="3">
                <div class="stat-card stat-card-platform">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Functions" Color="Color.Info" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">Total Calls</MudText>
                            <span class="stat-value">@_stats.TotalCalls.ToString("N0")</span>
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
            <MudItem xs="6" sm="3">
                <div class="stat-card stat-card-accent">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">Helpful</MudText>
                            <span class="stat-value">@_stats.TotalHelpful.ToString("N0")</span>
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
            <MudItem xs="6" sm="3">
                <div class="stat-card stat-card-error">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">Unhelpful</MudText>
                            <span class="stat-value">@_stats.TotalUnhelpful.ToString("N0")</span>
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
            <MudItem xs="6" sm="3">
                <div class="stat-card stat-card-secondary">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Secondary" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">Avg Usage</MudText>
                            <span class="stat-value">@_stats.AverageUsagePercentage.ToString("F1")%</span>
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
        </MudGrid>
    }

    <ToolUsageGrid @ref="_grid"
                   AgentId="@AgentId"
                   InstructionVersionId="@InstructionVersionId"
                   GameId="@GameId"
                   OnStatsLoaded="OnStatsLoaded" />
</MudContainer>

@code {

    /// <summary>
    /// Optional agent ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public string? AgentId { get; set; }

    /// <summary>
    /// Optional instruction version ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public int? InstructionVersionId { get; set; }

    /// <summary>
    /// Optional game ID to filter results.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? GameId { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new();
    private ToolUsageGrid? _grid;
    private ToolUsageListResponse? _stats;

    protected override void OnInitialized()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Tool Usage", href: null, disabled: true)
        };
    }

    private void OnStatsLoaded(ToolUsageListResponse stats)
    {
        _stats = stats;
        StateHasChanged();
    }
}
