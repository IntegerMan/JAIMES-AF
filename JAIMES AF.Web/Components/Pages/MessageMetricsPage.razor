@page "/admin/metrics/{MessageId:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Domain
@using MattEland.Jaimes.Web.Components.Chat
@using MattEland.Jaimes.Web.Components.Helpers
@using MudBlazor
@using System.Text.Json
@using System.Linq
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Message Evaluation Metrics</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                       OnClick="GoBack"
                       Variant="Variant.Text" />
        <MudText Typo="Typo.h4">Message Evaluation Metrics</MudText>
    </MudStack>
    
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Class="my-4" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else if (_metrics == null || _metrics.Count == 0)
    {
        <MudText Typo="Typo.body1">No evaluation metrics found for this message.</MudText>
    }
    else
    {
        @if (_gameId.HasValue)
        {
            <MudButton Href="@($"/games/{_gameId}")" 
                       Variant="Variant.Text" 
                       StartIcon="@Icons.Material.Filled.ArrowBack" 
                       Class="mb-4">
                Back to Game
            </MudButton>
        }
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-3">Evaluation Metrics</MudText>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 8px;">
                    <MudStack Spacing="3">
                        @foreach (var metric in _metrics)
                        {
                            <MudCard Elevation="2">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h6">@metric.MetricName</MudText>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudChip T="string" Color="@GetScoreColor(metric.Score)" Size="Size.Medium">
                                                    @metric.Score.ToString("F1")
                                                </MudChip>
                                                @if (metric.Score >= 3)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                }
                                                else
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
                                                }
                                            </MudStack>
                                        </MudStack>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    @if (!string.IsNullOrEmpty(metric.Remarks))
                                    {
                                        <MudText Typo="Typo.body1" Class="mb-3">@metric.Remarks</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Class="text-muted mb-3">No remarks provided</MudText>
                                    }
                                    
                                    <MudText Typo="Typo.caption" Class="text-muted">
                                        Evaluated: @metric.EvaluatedAt.ToLocalTime().ToString("g")
                                    </MudText>
                                    
                                    @if (!string.IsNullOrEmpty(metric.Diagnostics))
                                    {
                                        <MudExpansionPanels Class="mt-3" Elevation="0">
                                            <MudExpansionPanel Dense="true">
                                                <TitleContent>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudIcon Icon="@Icons.Material.Filled.Biotech" Size="Size.Small" />
                                                        <MudText>Diagnostics</MudText>
                                                    </MudStack>
                                                </TitleContent>
                                                <ChildContent>
                                                    <MudText Typo="Typo.caption" Style="font-family: monospace; white-space: pre-wrap; word-break: break-all;">
                                                        @FormatDiagnostics(metric.Diagnostics)
                                                    </MudText>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        </MudExpansionPanels>
                                    }
                                </MudCardContent>
                            </MudCard>
                        }
                    </MudStack>
                </div>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-3">Conversation Context</MudText>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 8px;">
                    @if (_contextMessages != null)
                    {
                        @foreach (var m in _contextMessages)
                        {
                            List<string> paragraphs = ChatHelpers.SplitIntoParagraphs(m.Text).ToList();
                            @foreach ((string paragraph, int index) in paragraphs.Select((p, i) => (p, i)))
                            {
                                bool isFirstParagraph = index == 0;
                                bool isLastParagraph = index == paragraphs.Count - 1;
                                bool isTargetMessage = m.Id == MessageId;

                                @if (m.PlayerId != null) // User message
                                {
                                    <UserChatMessage 
                                        Text="@paragraph" 
                                        IsFirstParagraph="@isFirstParagraph"
                                        IsLastParagraph="@isLastParagraph"
                                        MessageId="@m.Id"
                                        Sentiment="@m.Sentiment"
                                        ReadOnly="true"
                                        Highlighted="@isTargetMessage" />
                                }
                                else // Assistant message
                                {
                                    <AssistantChatMessage
                                        Text="@paragraph"
                                        MessageId="@m.Id"
                                        IsFirstParagraph="@isFirstParagraph"
                                        IsLastParagraph="@isLastParagraph"
                                        ReadOnly="true"
                                        Highlighted="@isTargetMessage" />
                                }
                            }
                        }
                    }
                    else
                    {
                         <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
                    }
                </div>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public int MessageId { get; set; }
    
    private List<MessageEvaluationMetricResponse>? _metrics;
    private List<MessageDto>? _contextMessages;
    private bool _isLoading = true;
    private string? _errorMessage;
    private Guid? _gameId;

    protected override async Task OnParametersSetAsync()
    {
        await LoadMetricsAsync();
        // Load context independently to allow metrics to show while context loads
        _ = LoadContextAsync(); 
    }

    private async Task LoadMetricsAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            _metrics = await client.GetFromJsonAsync<List<MessageEvaluationMetricResponse>>($"/messages/{MessageId}/metrics");
            
            // Try to get the game ID from the message metadata endpoint
            try
            {
                var metadataResponse = await client.GetAsync($"/messages/{MessageId}/metadata");
                if (metadataResponse.IsSuccessStatusCode)
                {
                    var metadata = await metadataResponse.Content.ReadFromJsonAsync<MessageMetadataResponse>();
                    _gameId = metadata?.GameId;
                }
            }
            catch
            {
                // Ignore - we just won't show the game link
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load metrics: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadContextAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            // Load more context to ensure we see surrounding messages
            var messages = await client.GetFromJsonAsync<List<MessageDto>>($"/messages/{MessageId}/context?count=10");
            
            if (messages != null)
            {
                _contextMessages = messages;
                StateHasChanged();
            }
        }
        catch
        {
            // Ignore context loading failures, just don't show it
        }
    }

    private void GoBack()
    {
        if (_gameId.HasValue)
        {
            NavigationManager.NavigateTo($"/games/{_gameId}");
        }
        else
        {
            NavigationManager.NavigateTo("/admin/metrics");
        }
    }

    private static Color GetScoreColor(double score)
    {
        return score switch
        {
            >= 4 => Color.Success,
            >= 3 => Color.Info,
            >= 2 => Color.Warning,
            _ => Color.Error
        };
    }
    
    // DTO for message metadata (simplified)
    private class MessageMetadataResponse
    {
        public Guid? GameId { get; set; }
    }

    /// <summary>
    /// Formats diagnostics as pretty-printed JSON if valid, otherwise returns as-is.
    /// </summary>
    private static string FormatDiagnostics(string diagnostics)
    {
        try
        {
            using var doc = JsonDocument.Parse(diagnostics);
            return JsonSerializer.Serialize(doc.RootElement, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return diagnostics;
        }
    }
}
