@page "/admin/metrics/{MessageId:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Domain
@using MattEland.Jaimes.Web.Components.Chat
@using MattEland.Jaimes.Web.Components.Helpers
@using MudBlazor
@using System.Text.Json
@using System.Linq
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject IConfiguration Configuration
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration
@using MattEland.Jaimes.ServiceDefinitions.Requests

<PageTitle>Message Evaluation Metrics</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>
    <MudText Typo="Typo.h4" Class="mb-4">Message Evaluation Metrics</MudText>
    
    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Class="my-4" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else if (_metrics == null || !_metrics.Any())
    {
        <MudText Typo="Typo.body1">No evaluation metrics found for this message.</MudText>
    }

    @if (_missingEvaluatorsResponse != null && _missingEvaluatorsResponse.MissingEvaluators.Any())
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText>
                    This message is missing evaluation from <strong>@_missingEvaluatorsResponse.MissingEvaluators.Count</strong> 
                    of @_missingEvaluatorsResponse.TotalRegisteredEvaluators registered evaluators: 
                    @string.Join(", ", _missingEvaluatorsResponse.MissingEvaluators)
                </MudText>
                <MudSpacer />
                <MudButton StartIcon="@Icons.Material.Filled.Refresh" 
                           Color="Color.Inherit" 
                           Variant="Variant.Outlined"
                           Disabled="@_isReevaluating"
                           OnClick="TriggerReEvaluation">
                    @(_isReevaluating ? "Enqueuing..." : "Re-evaluate Missing")
                </MudButton>
            </MudStack>
        </MudAlert>
    }
    
    @if (!_isLoading && _metrics != null && _metrics.Any())
    {

        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-3">Evaluation Metrics</MudText>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 8px;">
                    <MudStack Spacing="3">
                        @foreach (var metric in _metrics)
                        {
                            <MudCard Elevation="2">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                         <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                             <MudText Typo="Typo.h6">@metric.MetricName</MudText>
                                             @if (metric.EvaluatorId.HasValue)
                                             {
                                                 <MudLink Typo="Typo.caption" Href="@($"/admin/metrics?evaluatorId={metric.EvaluatorId}")" Class="mt-1">
                                                     (View Evaluator)
                                                 </MudLink>
                                             }
                                         </MudStack>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudChip T="string" Color="@MetricColorHelper.GetScoreColor(metric.Score)" Size="Size.Medium">
                                                    @metric.Score.ToString("F1")
                                                </MudChip>
                                                @if (metric.Score >= 3)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                }
                                                else
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
                                                }
                                            </MudStack>
                                        </MudStack>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    @if (!string.IsNullOrEmpty(metric.Remarks))
                                    {
                                        <MudText Typo="Typo.body1" Class="mb-3">@metric.Remarks</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Class="text-muted mb-3">No remarks provided</MudText>
                                    }
                                    
                                    <MudText Typo="Typo.caption" Class="text-muted">
                                        Evaluated: @metric.EvaluatedAt.ToLocalTime().ToString("g")
                                    </MudText>
                                    
                                    @if (!string.IsNullOrEmpty(metric.Diagnostics))
                                    {
                                        <MudExpansionPanels Class="mt-3" Elevation="0">
                                            <MudExpansionPanel Dense="true">
                                                <TitleContent>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudIcon Icon="@Icons.Material.Filled.Biotech" Size="Size.Small" />
                                                        <MudText>Diagnostics</MudText>
                                                    </MudStack>
                                                </TitleContent>
                                                <ChildContent>
                                                    <MudText Typo="Typo.caption" Style="font-family: monospace; white-space: pre-wrap; word-break: break-all;">
                                                        @FormatDiagnostics(metric.Diagnostics)
                                                    </MudText>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        </MudExpansionPanels>
                                    }
                                </MudCardContent>
                            </MudCard>
                        }
                    </MudStack>
                </div>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                    <MudText Typo="Typo.h6">Conversation Context</MudText>
                    @if (_gameId.HasValue)
                    {
                        <MudButton Href="@($"/games/{_gameId}")" 
                                   Variant="Variant.Text" 
                                   StartIcon="@Icons.Material.Filled.Gamepad" 
                                   Color="Color.Primary">
                            View Game
                        </MudButton>
                    }
                </MudStack>
                
                <ReadOnlyConversation MessageId="@MessageId" ContextCount="10" ContextCountAfter="1" />
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@inject ISnackbar Snackbar

@code {
    [Parameter] public int MessageId { get; set; }
    
    private IEnumerable<MessageEvaluationMetricResponse> _metrics = new List<MessageEvaluationMetricResponse>();
    private bool _isLoading = true;
    private bool _isReevaluating = false;
    private string? _errorMessage;
    private Guid? _gameId;
    private MissingEvaluatorsResponse? _missingEvaluatorsResponse;

    protected override async Task OnParametersSetAsync()
    {
        await LoadMetricsAsync();
        await LoadMissingEvaluatorsAsync();
        await LoadMessageMetadataAsync();
    }

    private async Task LoadMissingEvaluatorsAsync()
    {
        try
        {
            _missingEvaluatorsResponse = await Http.GetFromJsonAsync<MissingEvaluatorsResponse>($"/messages/{MessageId}/missing-evaluators");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking for missing evaluators: {ex}");
        }
    }

    private async Task TriggerReEvaluation()
    {
        _isReevaluating = true;
        try
        {
            var response = await Http.PostAsync($"/messages/{MessageId}/reevaluate", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Re-evaluation enqueued. Metrics will update automatically.", Severity.Success);
                // We'll trust SignalR to update the metrics, but we can clear the banner
                _missingEvaluatorsResponse = null;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to trigger re-evaluation: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isReevaluating = false;
        }
    }

    private async Task LoadMetricsAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _metrics = await Http.GetFromJsonAsync<IEnumerable<MessageEvaluationMetricResponse>>($"/messages/{MessageId}/metrics") 
                       ?? new List<MessageEvaluationMetricResponse>();
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to load evaluation metrics.";
            Console.WriteLine($"Error loading metrics: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }


    private async Task LoadMessageMetadataAsync()
    {
        try
        {
            // We need to fetch the message to get the GameId for the "View Game" button
            // We use count=1 to just get the message itself
            var messages = await Http.GetFromJsonAsync<IEnumerable<MessageContextDto>>($"/messages/{MessageId}/context?countBefore=0&countAfter=0");
            var message = messages?.FirstOrDefault();
            
            if (message != null && message.GameId != Guid.Empty)
            {
                _gameId = message.GameId;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading message metadata: {ex}");
        }
    }

    private List<BreadcrumbItem> _breadcrumbs = new();

    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Evaluators", href: "/admin/evaluators"),
            new BreadcrumbItem("Metrics", href: "/admin/metrics"),
            new BreadcrumbItem($"Message {MessageId}", href: null, disabled: true)
        };

        // Initialize SignalR using the API service URL, not the local web URL
        string baseApiUrl = Configuration["ApiService:BaseAddress"] ?? "http://apiservice/";
        if (!baseApiUrl.EndsWith("/")) baseApiUrl += "/";
        var hubUrl = new Uri(new Uri(baseApiUrl), "hubs/messages");

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<MessageUpdateNotification>("ReceiveMessageUpdate", async (notification) =>
        {
            if (notification.MessageId == MessageId && notification.UpdateType == MessageUpdateType.MetricsEvaluated)
            {
                await InvokeAsync(async () =>
                {
                    await LoadMetricsAsync();
                    await LoadMissingEvaluatorsAsync();
                    StateHasChanged();
                });
            }
        });

        try
        {
            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect to SignalR hub: {ex.Message}");
            // Continue without real-time updates
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private void GoBack()
    {
        // Deprecated
    }

    
    // DTO for message metadata (simplified)
    private class MessageMetadataResponse
    {
        public Guid? GameId { get; set; }
    }

    /// <summary>
    /// Formats diagnostics as pretty-printed JSON if valid, otherwise returns as-is.
    /// </summary>
    private static string FormatDiagnostics(string diagnostics)
    {
        try
        {
            using var doc = JsonDocument.Parse(diagnostics);
            return JsonSerializer.Serialize(doc.RootElement, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return diagnostics;
        }
    }
}
