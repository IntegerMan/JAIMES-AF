@page "/agents"
@rendermode InteractiveServer

@inject HttpClient Http
@inject ILoggerFactory LoggerFactory

<PageTitle>Agents</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">

	@* Compact Hero Section *@
	<CompactHeroSection Title="AI Agents"
						Icon="@Icons.Material.Filled.SmartToy"
						Theme="CompactHeroSection.HeroTheme.Secondary"
						ItemCount="@_agents?.Length"
						ItemName="agent"
						Subtitle="configured"
						SubtitleNoItems="Create your first agent"
						ActionText="New Agent"
						ActionHref="/agents/new"
						ActionIcon="@Icons.Material.Filled.Add" />

	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>

	<div style="position: relative; min-height: 200px;">
		@if (_isLoading)
		{
			<div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
				<MudProgressCircular Indeterminate="true" />
			</div>
		}

		@if (!_isLoading && !string.IsNullOrEmpty(_errorMessage))
		{
			<MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && (_agents is null || _agents.Length == 0))
		{
			<div class="glass-card pa-6" style="text-align: center;">
				<MudStack AlignItems="AlignItems.Center" Spacing="3">
					<MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Secondary"
						Style="font-size: 4rem; opacity: 0.5;" />
					<MudText Typo="Typo.h6">No agents yet</MudText>
					<MudText Class="text-muted mb-4">Create AI agents to power your game experiences!</MudText>
					<MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large" Href="/agents/new"
						StartIcon="@Icons.Material.Filled.Add">
						Create Your First Agent
					</MudButton>
				</MudStack>
			</div>
		}

		@if (!_isLoading && string.IsNullOrEmpty(_errorMessage) && _agents is not null && _agents.Length > 0)
		{
			<AgentStats AgentId="@null" />

			<MudPaper Elevation="0" Class="pa-0" Style="background: transparent;">
				<MudTable Items="_agents" Dense="true" Hover="true">
					<HeaderContent>
						<MudTh>Name</MudTh>
						<MudTh>Role</MudTh>
						<MudTh>Versions</MudTh>
						<MudTh>Evaluation</MudTh>
						<MudTh>Feedback</MudTh>
						<MudTh>Sentiment</MudTh>
						<MudTh Style="text-align: right;">Actions</MudTh>
					</HeaderContent>
					<RowTemplate>
						<MudTd DataLabel="Name">
							<MattEland.Jaimes.Web.Components.Shared.AgentLink AgentId="@context.Id"
								AgentName="@context.Name" />
						</MudTd>
						<MudTd DataLabel="Role">@context.Role</MudTd>
						<MudTd DataLabel="Versions">
							<MudLink Href="@($"/agents/{context.Id}")" Underline="Underline.None">
								<MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
									<MudIcon Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Info" />
									<MudText Typo="Typo.body2">@context.VersionCount</MudText>
								</MudStack>
							</MudLink>
						</MudTd>
						<MudTd DataLabel="Evaluation">
							<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
								@if (context.EvaluationMetrics != null && context.EvaluationMetrics.Count > 0)
								{
									<MattEland.Jaimes.Web.Components.Shared.EvaluationProgressRing Size="24" 
										TotalSegments="@context.EvaluationMetrics.Count"
										Metrics="@context.EvaluationMetrics.Select(m => new MessageEvaluationMetricResponse { MetricName = m.MetricName, Score = m.AverageScore, EvaluatorId = m.EvaluatorId }).ToList()" />
									<MudLink Href="@($"/admin/metrics?agentId={context.Id}")" Underline="Underline.None">
										<MudText Typo="Typo.body2" Style="font-weight: 600;">
											@context.EvaluationMetrics.Average(m => m.AverageScore).ToString("F1")
										</MudText>
									</MudLink>
								}
								else
								{
									<MudText Typo="Typo.body2" Class="text-muted">â€”</MudText>
								}
							</MudStack>
						</MudTd>
						<MudTd DataLabel="Feedback">
							<MudLink Href="@($"/admin/feedback?agentId={context.Id}")" Underline="Underline.None">
								<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
									<MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
										<MudIcon Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small" Color="Color.Success" />
										<MudText Typo="Typo.body2">@context.FeedbackPositiveCount</MudText>
									</MudStack>
									<MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
										<MudIcon Icon="@Icons.Material.Filled.ThumbDown" Size="Size.Small" Color="Color.Error" />
										<MudText Typo="Typo.body2">@context.FeedbackNegativeCount</MudText>
									</MudStack>
								</MudStack>
							</MudLink>
						</MudTd>
						<MudTd DataLabel="Sentiment">
							<MattEland.Jaimes.Web.Components.Shared.SentimentSummary 
								AgentId="@context.Id" 
								PositiveCount="@context.SentimentPositiveCount"
								NeutralCount="@context.SentimentNeutralCount"
								NegativeCount="@context.SentimentNegativeCount" />
						</MudTd>
						<MudTd Style="text-align: right; white-space: nowrap;">
							<MudTooltip Text="View Details" Placement="Placement.Top">
								<MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary"
									Size="Size.Small" Href="@($"/agents/{context.Id}")" />
							</MudTooltip>
							<MudTooltip Text="Improve Prompt" Placement="Placement.Top">
								<MudIconButton Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Secondary"
									Size="Size.Small" Href="@($"/agents/{context.Id}/improve")" />
							</MudTooltip>
							<MudTooltip Text="Run Test Cases" Placement="Placement.Top">
								<MudIconButton Icon="@Icons.Material.Filled.Science" Color="Color.Success" Size="Size.Small"
									Href="@($"/admin/run-tests?agentId={context.Id}")" />
							</MudTooltip>
							<MudTooltip Text="Edit Agent" Placement="Placement.Top">
								<MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
									Href="@($"/agents/{context.Id}/edit")" />
							</MudTooltip>
						</MudTd>
					</RowTemplate>
				</MudTable>
			</MudPaper>
		}
	</div>
</MudContainer>
