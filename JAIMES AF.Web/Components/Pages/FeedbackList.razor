@page "/admin/feedback"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<PageTitle>Feedback Reports</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    @* Compact Hero Section *@
    <div class="feedback-hero pa-3 mb-4" style="background: linear-gradient(135deg, rgba(123, 44, 191, 0.14) 0%, rgba(76, 201, 240, 0.16) 100%);
        border-radius: 16px; border: 1px solid rgba(123, 44, 191, 0.28);">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <div class="icon-badge icon-badge-primary" style="box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
                    <MudIcon Icon="@Icons.Material.Filled.Feedback" Style="color: white; font-size: 1.6rem;"/>
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1F2A44;">Feedback Reports</MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">
                        @if (_summary is not null)
                        {
                            <span>@_summary.TotalCount feedback record@(_summary.TotalCount != 1 ? "s" : "") collected</span>
                        }
                        else
                        {
                            <span>Loading feedback data...</span>
                        }
                    </MudText>
                </MudStack>
            </MudStack>
            <MudTooltip Text="View sentiment analysis for user messages" Placement="Placement.Top">
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           Href="/admin/sentiments"
                           StartIcon="@Icons.Material.Filled.SentimentSatisfied">
                    Sentiment Analysis
                </MudButton>
            </MudTooltip>
        </MudStack>
    </div>

    @* Feedback Summary Stats Row *@
    @if (_summary is not null)
    {
        <MudGrid Spacing="3" Class="mb-4">
            <MudItem xs="12" sm="3">
                <MudLink Underline="Underline.None" Class="stat-card-link" Style="display: block;" OnClick="@(() => ApplyFeedbackFilter(true))">
                    <div class="stat-card stat-card-success" style="cursor: pointer;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success"/>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.caption" Class="text-muted">Positive</MudText>
                                <span class="stat-value">@_summary.PositiveCount</span>
                            </MudStack>
                        </MudStack>
                    </div>
                </MudLink>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudLink Underline="Underline.None" Class="stat-card-link" Style="display: block;" OnClick="@(() => ApplyFeedbackFilter(false))">
                    <div class="stat-card stat-card-error" style="cursor: pointer;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error"/>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.caption" Class="text-muted">Negative</MudText>
                                <span class="stat-value">@_summary.NegativeCount</span>
                            </MudStack>
                        </MudStack>
                    </div>
                </MudLink>
            </MudItem>
            <MudItem xs="12" sm="3">
                <div class="stat-card stat-card-primary" style="cursor: default;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Comment" Color="Color.Primary"/>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">With Comments</MudText>
                            <span class="stat-value">@_summary.WithCommentsCount</span>
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
            <MudItem xs="12" sm="3">
                <div class="stat-card stat-card-info" style="cursor: default;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Info"/>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="text-muted">Positive Rate</MudText>
                            @if (_summary.TotalCount > 0)
                            {
                                <span class="stat-value">@($"{(double)_summary.PositiveCount / _summary.TotalCount * 100:0.0}%")</span>
                            }
                            else
                            {
                                <span class="stat-value text-muted">N/A</span>
                            }
                        </MudStack>
                    </MudStack>
                </div>
            </MudItem>
        </MudGrid>
    }
    else if (_isLoading)
    {
        <div style="display: flex; justify-content: center; align-items: center; min-height: 80px;" class="mb-4">
            <MudProgressCircular Indeterminate="true" Size="Size.Small"/>
        </div>
    }

    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    <AdminFilters ToolName="@ToolName"
                  IsPositive="@IsPositive"
                  AgentVersion="@AgentId"
                  OnClearFilters="ClearFilters"/>

    <FeedbackGrid AgentId="@AgentId"
                  InstructionVersionId="@InstructionVersionId"
                  ToolName="@ToolName"
                  IsPositive="@IsPositive"
                  GameId="@GameId"/>
</MudContainer>

@code {
    [Parameter] [SupplyParameterFromQuery] public string? ToolName { get; set; }
    [Parameter] [SupplyParameterFromQuery] public bool? IsPositive { get; set; }
    [Parameter] [SupplyParameterFromQuery] public string? AgentId { get; set; }
    [Parameter] [SupplyParameterFromQuery] public int? InstructionVersionId { get; set; }
    [Parameter] [SupplyParameterFromQuery] public Guid? GameId { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = [];
    private FeedbackSummaryResponse? _summary;
    private bool _isLoading = true;

    protected override void OnInitialized()
    {
        _breadcrumbs =
        [
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Feedback", href: null, disabled: true)
        ];
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaryAsync();
    }

    private async Task LoadSummaryAsync()
    {
        try
        {
            _isLoading = true;
            HttpClient client = HttpClientFactory.CreateClient("Api");
            string summaryUrl = BuildSummaryUrl();
            _summary = await client.GetFromJsonAsync<FeedbackSummaryResponse>(summaryUrl);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading feedback summary: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string BuildSummaryUrl()
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(AgentId)) queryParams.Add($"agentId={Uri.EscapeDataString(AgentId)}");
        if (InstructionVersionId.HasValue) queryParams.Add($"instructionVersionId={InstructionVersionId.Value}");
        if (GameId.HasValue) queryParams.Add($"gameId={GameId.Value}");
        if (!string.IsNullOrEmpty(ToolName)) queryParams.Add($"toolName={Uri.EscapeDataString(ToolName)}");
        if (IsPositive.HasValue) queryParams.Add($"isPositive={IsPositive.Value.ToString().ToLower()}");

        string query = queryParams.Count > 0 ? "?" + string.Join("&", queryParams) : string.Empty;
        return $"/admin/feedback/summary{query}";
    }

    private void ClearFilters() => NavigationManager.NavigateTo("/admin/feedback");

    private void ApplyFeedbackFilter(bool? isPositive)
    {
        IsPositive = isPositive;
        string target = isPositive.HasValue ? $"/admin/feedback?isPositive={isPositive.Value.ToString().ToLower()}" : "/admin/feedback";
        NavigationManager.NavigateTo(target, forceLoad: true);
    }
}
