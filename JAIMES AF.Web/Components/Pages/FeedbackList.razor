@page "/admin/feedback"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Pages
@using MudBlazor
@inject IDialogService DialogService
@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<PageTitle>Feedback Reports</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">Feedback Reports</MudText>
    
    @if (!string.IsNullOrEmpty(ToolName) || IsPositive.HasValue)
    {
        <MudText Typo="Typo.body2" Class="mb-4 text-muted">
            Filtering by:
            @if (!string.IsNullOrEmpty(ToolName))
            {
                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="ml-2">Tool: @ToolName</MudChip>
            }
            @if (IsPositive.HasValue)
            {
                <MudChip T="string" Color="@(IsPositive.Value ? Color.Success : Color.Error)" Size="Size.Small" Class="ml-2">
                    @(IsPositive.Value ? "Helpful" : "Unhelpful")
                </MudChip>
            }
            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Href="/admin/feedback" Class="ml-2">
                Clear Filters
            </MudButton>
        </MudText>
    }

    <MudDataGrid T="FeedbackListItemDto"
                 ServerData="ServerReload"
                 Filterable="false"
                 Hover="true"
                 Dense="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.IsPositive" Title="Type" Sortable="false">
                <CellTemplate>
                    @if (context.Item.IsPositive)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" />
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Comment" Title="Comment">
                <CellTemplate>
                    <MudLink OnClick="@(() => ShowContextAsync(context.Item))" Typo="Typo.body2" Color="Color.Inherit" Underline="Underline.Hover" Style="cursor: pointer;">
                        @context.Item.Comment
                    </MudLink>
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Tools Involved">
                <CellTemplate>
                    @if (context.Item.ToolNames != null && context.Item.ToolNames.Any())
                    {
                        <MudStack Row="true" Spacing="1">
                            @foreach (var tool in context.Item.ToolNames.Take(3))
                            {
                                <MudLink Href="@($"/admin/tools/{Uri.EscapeDataString(tool)}")" Typo="Typo.body2">
                                    <MudChip Color="Color.Secondary" Size="Size.Small">@tool</MudChip>
                                </MudLink>
                            }
                            @if (context.Item.ToolNames.Count > 3)
                            {
                                <MudChip Color="Color.Default" Size="Size.Small">+@(context.Item.ToolNames.Count - 3) more</MudChip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">None</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.CreatedAt" Title="Date">
                <CellTemplate>
                    @context.Item.CreatedAt.ToLocalTime().ToString("g")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.GamePlayerName" Title="Player" />
            <PropertyColumn Property="x => x.GameScenarioName" Title="Scenario" />
            <PropertyColumn Property="x => x.GameRulesetId" Title="Ruleset" />
            <PropertyColumn Property="x => x.AgentVersion" Title="Agent Version" />
            <TemplateColumn Title="Actions">
                <CellTemplate>
                    <div class="d-flex">
                        <MudTooltip Text="View Context">
                            <MudIconButton Icon="@Icons.Material.Filled.Chat" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => ShowContextAsync(context.Item))" />
                        </MudTooltip>
                        <MudTooltip Text="Open Game">
                            <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" 
                                           Color="Color.Secondary" 
                                           Size="Size.Small"
                                           Href="@($"/games/{context.Item.GameId}")"
                                           Target="_blank" />
                        </MudTooltip>
                    </div>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="FeedbackListItemDto" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    /// <summary>
    /// Optional tool name to filter feedback by.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public string? ToolName { get; set; }

    /// <summary>
    /// Optional filter for positive (true) or negative (false) feedback.
    /// </summary>
    [Parameter]
    [SupplyParameterFromQuery]
    public bool? IsPositive { get; set; }

    private async Task<GridData<FeedbackListItemDto>> ServerReload(GridState<FeedbackListItemDto> state)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            
            // MudDataGrid uses 0-based index, API uses 1-based page
            int page = state.Page + 1;
            int pageSize = state.PageSize;

            // Build query string with optional filters
            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrEmpty(ToolName))
                queryParams.Add($"toolName={Uri.EscapeDataString(ToolName)}");
            if (IsPositive.HasValue)
                queryParams.Add($"isPositive={IsPositive.Value.ToString().ToLower()}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<FeedbackListResponse>($"/admin/feedback?{queryString}");

            if (response != null)
            {
                return new GridData<FeedbackListItemDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception)
        {
            // Handle error (maybe show snackbar)
        }

        return new GridData<FeedbackListItemDto>
        {
            TotalItems = 0,
            Items = []
        };
    }

    private async Task ShowContextAsync(FeedbackListItemDto item)
    {
        var parameters = new DialogParameters<FeedbackContextDialog>
        {
            { x => x.MessageId, item.MessageId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<FeedbackContextDialog>("Feedback Context", parameters, options);
    }
}

