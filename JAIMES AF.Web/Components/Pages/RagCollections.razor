@page "/admin/rag-collections/{RulesetId?}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@rendermode InteractiveServer

<PageTitle>RAG Collections</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	<CompactHeroSection Title="RAG Collections"
	                    Icon="@Icons.Material.Filled.Storage"
	                    Theme="CompactHeroSection.HeroTheme.Info"
	                    ItemCount="@TotalDocuments"
	                    ItemName="document"
	                    Subtitle="indexed"
	                    SubtitleNoItems="No documents indexed yet" />

	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
		<MudSpacer />
		<MudButton Variant="Variant.Text" Color="Color.Info" Href="/tools/rules-search"
			StartIcon="@Icons.Material.Filled.Search" Size="Size.Small">
			Test Rules Search
		</MudButton>
		<MudButton Variant="Variant.Text" Color="Color.Info" Href="/tools/conversation-search"
			StartIcon="@Icons.Material.Filled.Chat" Size="Size.Small">
			Test Conversation Search
		</MudButton>
	</MudStack>

	@if (_isLoading)
	{
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
	}

	@if (!string.IsNullOrEmpty(_errorMessage))
	{
		<MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
	}

	@if (_statistics != null && _statistics.Documents.Length == 0 && !_isLoading)
	{
		<div class="glass-card pa-6" style="text-align: center;">
			<MudStack AlignItems="AlignItems.Center" Spacing="3">
				<MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Info"
				         Style="font-size: 4rem; opacity: 0.5;"/>
				<MudText Typo="Typo.h6">No documents indexed</MudText>
				<MudText Class="text-muted mb-4">
					Upload sourcebooks or create game transcripts to start building your RAG collections.
				</MudText>
			</MudStack>
		</div>
	}

	@if (_statistics != null && _statistics.Documents.Length > 0)
	{
		<MudGrid Spacing="3" Class="mb-4">
			@foreach (RagCollectionSummary summary in _statistics.Summaries)
			{
				<MudItem xs="12" sm="6">
					<MudPaper Class="pa-4" Elevation="2">
						<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
							<MudText Typo="Typo.h5">@summary.CollectionType</MudText>
							<MudChip T="string" Color="@(summary.EmbeddedChunks == summary.TotalChunks ? Color.Success : Color.Warning)" Size="Size.Small">
								@summary.DocumentCount docs
							</MudChip>
						</MudStack>
						<MudGrid Spacing="2">
							<MudItem xs="6" sm="3">
								<MudStack Spacing="0" AlignItems="AlignItems.Center">
									<MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Info" Size="Size.Small" />
									<MudText Typo="Typo.h6">@summary.DocumentCount</MudText>
									<MudText Typo="Typo.caption" Class="text-muted">Documents</MudText>
								</MudStack>
							</MudItem>
							<MudItem xs="6" sm="3">
								<MudStack Spacing="0" AlignItems="AlignItems.Center">
									<MudIcon Icon="@Icons.Material.Filled.ViewModule" Color="Color.Primary" Size="Size.Small" />
									<MudText Typo="Typo.h6">@summary.TotalChunks</MudText>
									<MudText Typo="Typo.caption" Class="text-muted">Chunks</MudText>
								</MudStack>
							</MudItem>
							<MudItem xs="6" sm="3">
								<MudStack Spacing="0" AlignItems="AlignItems.Center">
									<MudIcon Icon="@Icons.Material.Filled.Memory" 
									         Color="@(summary.EmbeddedChunks == summary.TotalChunks ? Color.Success : Color.Warning)" 
									         Size="Size.Small" />
									<MudText Typo="Typo.h6">@summary.EmbeddedChunks</MudText>
									<MudText Typo="Typo.caption" Class="text-muted">Embedded</MudText>
								</MudStack>
							</MudItem>
							<MudItem xs="6" sm="3">
								<MudStack Spacing="0" AlignItems="AlignItems.Center">
									<MudIcon Icon="@Icons.Material.Filled.Search" Color="Color.Success" Size="Size.Small" />
									<MudLink Href="@GetQueryLink(summary.CollectionType)">
										<MudText Typo="Typo.h6">@summary.QueryCount</MudText>
									</MudLink>
									<MudText Typo="Typo.caption" Class="text-muted">Queries</MudText>
								</MudStack>
							</MudItem>
						</MudGrid>
					</MudPaper>
				</MudItem>
			}
		</MudGrid>

		<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
			<MudText Typo="Typo.h6" GutterBottom="false">Document Details</MudText>
			<ViewModeToggle TValue="string" @bind-Value="_filterType"
			                Options="@_filterOptions" />
		</MudStack>
		<MudDataGrid T="RagCollectionDocumentInfo" Items="@FilteredDocuments" Dense="true" Striped="true" Hover="true"
			RowsPerPage="25">
				<Columns>
					<PropertyColumn Property="x => x.DocumentKind" Title="Type" />
					<PropertyColumn Property="x => x.RulesetId" Title="Ruleset" />
					<TemplateColumn Title="Name">
						<CellTemplate>
							<MudLink Href="@GetChunksLink(context.Item)">@context.Item.FileName</MudLink>
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Chunks">
						<CellTemplate>
							<MudLink Href="@GetChunksLink(context.Item)">@context.Item.TotalChunks</MudLink>
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Embeddings">
						<CellTemplate>
							@if (context.Item.EmbeddedChunks < context.Item.TotalChunks)
							{
								<MudChip T="string" Color="Color.Warning" Size="Size.Small">
									@context.Item.EmbeddedChunks / @context.Item.TotalChunks
								</MudChip>
							}
							else
							{
								<MudChip T="string" Color="Color.Success" Size="Size.Small">
									@context.Item.EmbeddedChunks
								</MudChip>
							}
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Status">
						<CellTemplate>
							@if (context.Item.IsFullyProcessed)
							{
								<MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
							}
							else
							{
								<MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" Size="Size.Small" />
							}
						</CellTemplate>
					</TemplateColumn>
					<TemplateColumn Title="Search Results">
						<CellTemplate>
							<MudLink Href="@GetDocumentQueryLink(context.Item.DocumentKind, context.Item.FileName)">
								@context.Item.SearchResultCount
							</MudLink>
						</CellTemplate>
					</TemplateColumn>
					<PropertyColumn Property="x => x.CrackedAt" Title="Processed" Format="g" />
					<TemplateColumn Title="Actions">
						<CellTemplate>
							@if (context.Item.HasStoredFile)
							{
								<MudTooltip Text="View Document" Placement="Placement.Top">
									<MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary"
										Size="Size.Small" OnClick="@(() => ViewDocumentAsync(context.Item))" />
								</MudTooltip>
							}
						</CellTemplate>
					</TemplateColumn>
				</Columns>
				<PagerContent>
					<MudDataGridPager T="RagCollectionDocumentInfo" />
				</PagerContent>
			</MudDataGrid>
	}
</MudContainer>

