@page "/admin/metrics"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Evaluation Metrics</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">Evaluation Metrics</MudText>
    <MudText Typo="Typo.body2" Class="mb-4 text-muted">
        View AI response evaluation metrics and quality scores across all messages.
    </MudText>

    <AdminFilters 
        MetricName="@MetricName"
        Passed="@Passed"
        MinScore="@MinScore"
        MaxScore="@MaxScore"
        GameId="@GameId"
        OnClearFilters="ClearFilters" />

    <MudDataGrid T="EvaluationMetricListItemDto"
                 ServerData="ServerReload"
                 Filterable="false"
                 Hover="true"
                 Dense="true"
                 Striped="true">
        <Columns>
            <PropertyColumn Property="x => x.MetricName" Title="Metric">
                <CellTemplate>
                    <strong>@context.Item.MetricName</strong>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Score" Title="Score">
                <CellTemplate>
                    <MudChip T="string" Color="@GetScoreColor(context.Item.Score)" Size="Size.Small">
                        @context.Item.Score.ToString("F1")
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Passed" Title="Status" Sortable="false">
                <CellTemplate>
                    @if (context.Item.Passed)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Pass</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">Fail</MudChip>
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Remarks" Title="Remarks">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.Remarks))
                    {
                        <MudTooltip Text="@context.Item.Remarks" Placement="Placement.Top">
                            <MudText Typo="Typo.body2" Style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @context.Item.Remarks
                            </MudText>
                        </MudTooltip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="text-muted">None</MudText>
                    }
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.EvaluatedAt" Title="Evaluated">
                <CellTemplate>
                    @context.Item.EvaluatedAt.ToLocalTime().ToString("g")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.GamePlayerName" Title="Player" />
            <PropertyColumn Property="x => x.GameScenarioName" Title="Scenario" />
            <PropertyColumn Property="x => x.AgentVersion" Title="Agent Version" />
            <TemplateColumn Title="Actions">
                <CellTemplate>
                    <MudStack Row="true" Spacing="0">
                        @if (!string.IsNullOrEmpty(context.Item.Diagnostics))
                        {
                            <MudTooltip Text="View Diagnostics">
                                <MudIconButton Icon="@Icons.Material.Filled.BugReport" 
                                               Color="Color.Info" 
                                               Size="Size.Small"
                                               OnClick="@(() => ShowDiagnosticsAsync(context.Item))" />
                            </MudTooltip>
                        }
                        <MudTooltip Text="View Message">
                            <MudIconButton Icon="@Icons.Material.Filled.Chat" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           Href="@($"/games/{context.Item.GameId}")"
                                           Target="_blank" />
                        </MudTooltip>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="EvaluationMetricListItemDto" />
        </PagerContent>
        <NoRecordsContent>
            <MudText Typo="Typo.body1" Class="pa-4">
                No evaluation metrics found. Metrics will appear here after assistant messages are evaluated.
            </MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? MetricName { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public bool? Passed { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public double? MinScore { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public double? MaxScore { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? GameId { get; set; }

    private async Task<GridData<EvaluationMetricListItemDto>> ServerReload(GridState<EvaluationMetricListItemDto> state)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Api");

            int page = state.Page + 1;
            int pageSize = state.PageSize;

            var queryParams = new List<string>
            {
                $"page={page}",
                $"pageSize={pageSize}"
            };

            if (!string.IsNullOrEmpty(MetricName))
                queryParams.Add($"metricName={Uri.EscapeDataString(MetricName)}");
            if (Passed.HasValue)
                queryParams.Add($"passed={Passed.Value.ToString().ToLower()}");
            if (MinScore.HasValue)
                queryParams.Add($"minScore={MinScore.Value}");
            if (MaxScore.HasValue)
                queryParams.Add($"maxScore={MaxScore.Value}");
            if (GameId.HasValue)
                queryParams.Add($"gameId={GameId.Value}");

            string queryString = string.Join("&", queryParams);
            var response = await client.GetFromJsonAsync<EvaluationMetricListResponse>($"/admin/metrics?{queryString}");

            if (response != null)
            {
                return new GridData<EvaluationMetricListItemDto>
                {
                    TotalItems = response.TotalCount,
                    Items = response.Items
                };
            }
        }
        catch (Exception)
        {
            // Handle error
        }

        return new GridData<EvaluationMetricListItemDto>
        {
            TotalItems = 0,
            Items = []
        };
    }

    private void ClearFilters()
    {
        NavigationManager.NavigateTo("/admin/metrics");
    }

    private static Color GetScoreColor(double score)
    {
        return score switch
        {
            >= 4 => Color.Success,
            >= 3 => Color.Info,
            >= 2 => Color.Warning,
            _ => Color.Error
        };
    }

    private async Task ShowDiagnosticsAsync(EvaluationMetricListItemDto item)
    {
        await DialogService.ShowMessageBox(
            $"Diagnostics - {item.MetricName}",
            item.Diagnostics ?? "No diagnostics available",
            "Close");
    }
}
