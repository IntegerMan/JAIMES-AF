@page "/admin/metrics"
@using MattEland.Jaimes.Web.Components.Shared
@using MudBlazor
@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<PageTitle>Evaluation Metrics</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>
    <MudText Typo="Typo.h4" Class="mb-2">Evaluation Metrics</MudText>

    @if (_evaluator != null)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info"/>
                <MudText Typo="Typo.h6">@_evaluator.Name</MudText>
                <MudSpacer/>
                <MudChip T="string" Color="Color.Primary" Size="Size.Small">@_evaluator.MetricCount.ToString("N0") Metrics</MudChip>
                @if (_evaluator.AverageScore.HasValue)
                {
                    <MudChip T="string" Color="@GetScoreColor(_evaluator.AverageScore.Value)" Size="Size.Small">
                        Avg: @_evaluator.AverageScore.Value.ToString("F2")
                    </MudChip>
                }
            </MudStack>
            <MudText Typo="Typo.body1">@_evaluator.Description</MudText>
        </MudPaper>
    }

    @if (!string.IsNullOrEmpty(GroupingInfo))
    {
        <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Info"/>
                <MudText>@GroupingInfo</MudText>
            </MudStack>
        </MudAlert>
    }

    <AdminFilters
        MetricName="@MetricName"
        Passed="@Passed"
        MinScore="@MinScore"
        MaxScore="@MaxScore"
        GameId="@GameId"
        EvaluatorId="@EvaluatorId"
        OnClearFilters="ClearFilters"/>

    <MetricsGrid AgentId="@AgentId"
                 InstructionVersionId="@InstructionVersionId"
                 GameId="@GameId"
                 MetricName="@MetricName"
                 Passed="@Passed"
                 MinScore="@MinScore"
                 MaxScore="@MaxScore"
                 EvaluatorId="@EvaluatorId"/>
</MudContainer>

@code {
    [Parameter] [SupplyParameterFromQuery] public string? MetricName { get; set; }

    [Parameter] [SupplyParameterFromQuery] public bool? Passed { get; set; }

    [Parameter] [SupplyParameterFromQuery] public double? MinScore { get; set; }

    [Parameter] [SupplyParameterFromQuery] public double? MaxScore { get; set; }

    [Parameter] [SupplyParameterFromQuery] public Guid? GameId { get; set; }

    [Parameter] [SupplyParameterFromQuery] public int? EvaluatorId { get; set; }

    [Parameter] [SupplyParameterFromQuery] public string? AgentId { get; set; }

    [Parameter] [SupplyParameterFromQuery] public int? InstructionVersionId { get; set; }
    private List<BreadcrumbItem> _breadcrumbs = new();
    private EvaluatorItemDto? _evaluator;
    private string? GroupingInfo = "Results are grouped by Game and Message. Click row headers to expand/collapse groups.";

    protected override async Task OnParametersSetAsync()
    {
        await LoadEvaluatorAsync();
    }

    private async Task LoadEvaluatorAsync()
    {
        if (EvaluatorId.HasValue)
        {
            try
            {
                var client = HttpClientFactory.CreateClient("Api");
                _evaluator = await client.GetFromJsonAsync<EvaluatorItemDto>($"/admin/evaluators/{EvaluatorId.Value}");
            }
            catch (Exception)
            {
                _evaluator = null;
            }
        }
        else
        {
            _evaluator = null;
        }
    }

    protected override void OnInitialized()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Evaluators", href: "/admin/evaluators"),
            new BreadcrumbItem("Metrics", href: null, disabled: true)
        };
    }


    private void ClearFilters()
    {
        NavigationManager.NavigateTo("/admin/metrics");
    }

    private static Color GetScoreColor(double score)
    {
        return score switch
        {
            >= 0.8 => Color.Success,
            >= 0.5 => Color.Warning,
            _ => Color.Error
        };
    }

}
