@page "/admin/rules-search-test"
@rendermode InteractiveServer

<PageTitle>Rules Search Test</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
	<MudPaper Class="pa-8" Elevation="2">
		<MudText Typo="Typo.h3" GutterBottom="true" Class="mb-2">Rules Search Test</MudText>
		<MudText Typo="Typo.subtitle1" GutterBottom="true" Class="mb-6 text-muted">Test and debug RAG search capabilities</MudText>

		<MudText Typo="Typo.body1" Class="mb-6" Style="line-height: 1.75;">
			Use this tool to test the rules search functionality. Enter a query to search across rulesets and view the answer, citations, and matching documents.
		</MudText>

		<MudDivider Class="my-6" />

		<MudPaper Class="pa-4" Elevation="1">
			<MudText Typo="Typo.h6" GutterBottom="true" Class="mb-4">Search Query</MudText>
			
			<MudForm>
				<MudTextField @bind-Value="searchQuery" 
				              Label="Search Query" 
				              Variant="Variant.Outlined" 
				              Class="mb-4"
				              FullWidth="true"
				              Placeholder="Enter your search query here..."
				              HelperText="Enter a natural language question about game rules (press Enter to search)"
				              OnKeyDown="HandleSearchQueryKeyDown" />

				<MudSelect @bind-Value="selectedRulesetId" 
				           Label="Ruleset (Optional)" 
				           Variant="Variant.Outlined" 
				           Class="mb-4"
				           FullWidth="true"
				           HelperText="Leave empty to search across all rulesets">
					<MudSelectItem Value="@((string?)null)">All Rulesets</MudSelectItem>
					@foreach (var ruleset in rulesets)
					{
						<MudSelectItem Value="@ruleset.Id">@ruleset.Name</MudSelectItem>
					}
				</MudSelect>

				<MudButton Variant="Variant.Filled" 
				           Color="Color.Primary" 
				           OnClick="SearchRulesAsync" 
				           Disabled="@isSearching"
				           Class="mb-4">
					@if (isSearching)
					{
						<MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
					}
					Search
				</MudButton>
			</MudForm>
		</MudPaper>

		@if (!string.IsNullOrEmpty(errorMessage))
		{
			<MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
		}

		@if (searchResult != null)
		{
			<MudDivider Class="my-6" />

			<MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">Search Results</MudText>

			<MudPaper Class="pa-4 mb-4" Elevation="1">
				<MudText Typo="Typo.h6" GutterBottom="true" Class="mb-3">Answer</MudText>
				@if (string.IsNullOrWhiteSpace(searchResult.Answer) || searchResult.Answer == "INFO NOT FOUND")
				{
					<MudAlert Severity="Severity.Warning" Class="mb-2">No answer was generated for this query.</MudAlert>
					<MudText Typo="Typo.body2" Class="text-muted">The search did not return a generated answer. Check the citations and documents below for relevant source material.</MudText>
				}
				else
				{
					<MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@searchResult.Answer</MudText>
				}
			</MudPaper>

			<MudPaper Class="pa-4 mb-4" Elevation="1">
				<MudText Typo="Typo.h6" GutterBottom="true" Class="mb-3">Citations (@searchResult.Citations.Length)</MudText>
				@if (searchResult.Citations.Length > 0)
				{
					@foreach (var citation in searchResult.Citations)
					{
						<MudExpansionPanels Class="mb-2">
							<MudExpansionPanel Text="@citation.Source">
								@if (string.IsNullOrWhiteSpace(citation.Text))
								{
									<MudText Typo="Typo.body2" Class="text-muted">No text content available for this citation.</MudText>
								}
								else
								{
									<MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@citation.Text</MudText>
								}
								@if (citation.Relevance.HasValue)
								{
									<MudText Typo="Typo.caption" Class="mt-2 text-muted">Relevance: @citation.Relevance.Value.ToString("P2")</MudText>
								}
							</MudExpansionPanel>
						</MudExpansionPanels>
					}
				}
				else
				{
					<MudText Typo="Typo.body2" Class="text-muted">No citations were found for this search query.</MudText>
				}
			</MudPaper>

			<MudPaper Class="pa-4 mb-4" Elevation="1">
				<MudText Typo="Typo.h6" GutterBottom="true" Class="mb-3">Documents (@searchResult.Documents.Length)</MudText>
				@if (searchResult.Documents.Length > 0)
				{
					@foreach (var document in searchResult.Documents)
					{
						<MudExpansionPanels Class="mb-2">
							<MudExpansionPanel Text="@document.DocumentId">
								<MudText Typo="Typo.body2" Class="mb-2"><strong>Document ID:</strong> @document.DocumentId</MudText>
								<MudText Typo="Typo.body2" Class="mb-2"><strong>Index:</strong> @document.Index</MudText>
								@if (document.Tags.Count > 0)
								{
									<MudText Typo="Typo.body2" Class="mb-2"><strong>Tags:</strong></MudText>
									<ul>
										@foreach (var tag in document.Tags)
										{
											<li><strong>@tag.Key:</strong> @tag.Value</li>
										}
									</ul>
								}
								else
								{
									<MudText Typo="Typo.body2" Class="text-muted">No tags available for this document.</MudText>
								}
							</MudExpansionPanel>
						</MudExpansionPanels>
					}
				}
				else
				{
					<MudText Typo="Typo.body2" Class="text-muted">No documents were found for this search query.</MudText>
				}
			</MudPaper>
		}
	</MudPaper>
</MudContainer>

