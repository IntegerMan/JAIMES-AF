@page "/admin/sentiments/{Id:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.ServiceDefinitions.Requests
@using MattEland.Jaimes.Web.Components.Shared
@using MattEland.Jaimes.Web.Components.Chat
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Sentiment Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" Class="d-block mx-auto mt-4" />
    }
    else if (_sentiment == null)
    {
        <MudAlert Severity="Severity.Error">Sentiment record not found.</MudAlert>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudText Typo="Typo.h4">Sentiment Details</MudText>
            
            <MudStack Row="true" Spacing="2">
                @if (_sentiment.GameId != Guid.Empty)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Games" 
                               Color="Color.Secondary" 
                               Href="@($"/games/{_sentiment.GameId}")">
                        View Game
                    </MudButton>
                }
            </MudStack>
        </MudStack>
        
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.h6" Class="mb-3">Sentiment Info</MudText>
                
                <MudCard Elevation="2" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetSentimentIcon()" Color="@GetSentimentColor()" Size="Size.Medium" />
                                <MudText Typo="Typo.h6">@GetSentimentLabel() Sentiment</MudText>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.body1"><strong>Source:</strong></MudText>
                                @{
                                    var (label, color) = _sentiment.SentimentSource switch
                                    {
                                        0 => ("Model", Color.Info),
                                        1 => ("Player", Color.Secondary),
                                        2 => ("Admin", Color.Primary),
                                        _ => ("Unknown", Color.Default)
                                    };
                                }
                                <MudChip T="string" Color="@color" Size="Size.Small">@label</MudChip>
                            </MudStack>

                            @if (_sentiment.Confidence.HasValue)
                            {
                                <MudText Typo="Typo.body1">
                                    <strong>Confidence:</strong> @((_sentiment.Confidence.Value * 100).ToString("F0"))%
                                </MudText>
                            }
                        </MudStack>
                        
                        <MudDivider Class="my-3"/>
                        
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Class="text-muted">
                                <strong>Created:</strong> @_sentiment.CreatedAt.ToLocalTime().ToString("g")
                            </MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">
                                <strong>Modified:</strong> @_sentiment.UpdatedAt.ToLocalTime().ToString("g")
                            </MudText>
                            
                            @if (!string.IsNullOrEmpty(_sentiment.GamePlayerName))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Player:</strong> @_sentiment.GamePlayerName
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.GameScenarioName))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Scenario:</strong> @_sentiment.GameScenarioName
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.GameRulesetId))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Ruleset:</strong> @_sentiment.GameRulesetId
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.AgentVersion))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Agent Version:</strong>
                                    @if (!string.IsNullOrEmpty(_sentiment.AgentId))
                                    {
                                        <MudLink Href="@($"/agents/{_sentiment.AgentId}/instruction-versions")" Typo="Typo.caption">
                                            @_sentiment.AgentVersion
                                        </MudLink>
                                    }
                                    else
                                    {
                                        @_sentiment.AgentVersion
                                    }
                                </MudText>
                            }
                        </MudStack>

                        @if (_sentiment.ToolNames != null && _sentiment.ToolNames.Any())
                        {
                            <MudDivider Class="my-3"/>
                            <MudText Typo="Typo.subtitle2" Class="mb-1">Tools Used in Response:</MudText>
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var tool in _sentiment.ToolNames)
                                {
                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined">@tool</MudChip>
                                }
                            </div>
                        }
                    </MudCardContent>
                </MudCard>

                @* Admin Edit Controls *@
                <MudCard Elevation="2" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Edit Sentiment</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudRadioGroup T="int" @bind-Value="_selectedSentiment">
                            <MudRadio Value="1" Color="Color.Success">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small" />
                                    <span>Positive</span>
                                </MudStack>
                            </MudRadio>
                            <MudRadio Value="0" Color="Color.Default">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Balance" Size="Size.Small" />
                                    <span>Neutral</span>
                                </MudStack>
                            </MudRadio>
                            <MudRadio Value="-1" Color="Color.Error">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Size="Size.Small" />
                                    <span>Negative</span>
                                </MudStack>
                            </MudRadio>
                        </MudRadioGroup>
                        
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   FullWidth="true" 
                                   Class="mt-3"
                                   Disabled="@(_saving || _selectedSentiment == _sentiment.Sentiment)"
                                   OnClick="SaveSentimentAsync">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Changes</span>
                            }
                        </MudButton>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            
            <MudItem xs="12" md="8">
                 <MudText Typo="Typo.h6" Class="mb-3">Conversation Context</MudText>
                 <MudPaper Elevation="2" Class="pa-4" Style="max-height: 80vh; overflow-y: auto;">
                     <ReadOnlyConversation MessageId="@_sentiment.MessageId" ContextCount="5" @key="_conversationKey" />
                 </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private SentimentFullDetailsResponse? _sentiment;
    private bool _loading = true;
    private bool _saving = false;
    private int _selectedSentiment;
    private int _conversationKey = 0;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnParametersSetAsync()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Sentiments", href: "/admin/sentiments"),
            new BreadcrumbItem($"Sentiment {Id}", href: null, disabled: true)
        };

        await LoadSentimentAsync();
    }

    private async Task LoadSentimentAsync()
    {
        _loading = true;
        _conversationKey++; // Force conversation to reload
        
        try 
        {
            var client = HttpClientFactory.CreateClient("Api");
            _sentiment = await client.GetFromJsonAsync<SentimentFullDetailsResponse>($"/admin/sentiments/{Id}");
            if (_sentiment != null)
            {
                _selectedSentiment = _sentiment.Sentiment;
            }
        }
        catch (Exception ex) 
        {
            Snackbar.Add($"Error loading sentiment: {ex.Message}", Severity.Error);
        }
        finally 
        {
            _loading = false;
        }
    }

    private async Task SaveSentimentAsync()
    {
        if (_sentiment == null || _saving) return;

        _saving = true;
        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var request = new UpdateMessageSentimentRequest
            {
                Sentiment = _selectedSentiment,
                Source = 2 // Admin source
            };

            var response = await client.PutAsJsonAsync($"/messages/{_sentiment.MessageId}/sentiment", request);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Sentiment updated successfully", Severity.Success);
                
                // Reload the sentiment data to get updated timestamps
                await LoadSentimentAsync();
                
                // Force conversation to reload by changing its key
                _conversationKey++;
                
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to update sentiment: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update sentiment: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private string GetSentimentLabel() => _sentiment?.Sentiment switch
    {
        > 0 => "Positive",
        < 0 => "Negative",
        _ => "Neutral"
    };

    private string GetSentimentIcon() => _sentiment?.Sentiment switch
    {
        > 0 => Icons.Material.Filled.ThumbUp,
        < 0 => Icons.Material.Filled.ThumbDown,
        _ => Icons.Material.Filled.Balance
    };

    private Color GetSentimentColor() => _sentiment?.Sentiment switch
    {
        > 0 => Color.Success,
        < 0 => Color.Error,
        _ => Color.Default
    };
}
