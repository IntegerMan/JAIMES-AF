@page "/admin/sentiments/{Id:int}"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@using MattEland.Jaimes.Web.Components.Chat
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Sentiment Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
    </MudStack>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" Class="d-block mx-auto mt-4" />
    }
    else if (_sentiment == null)
    {
        <MudAlert Severity="Severity.Error">Sentiment record not found.</MudAlert>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudText Typo="Typo.h4">Sentiment Details</MudText>
            
            <MudStack Row="true" Spacing="2">
                @if (_sentiment.GameId != Guid.Empty)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Games" 
                               Color="Color.Secondary" 
                               Href="@($"/games/{_sentiment.GameId}")">
                        View Game
                    </MudButton>
                }
            </MudStack>
        </MudStack>
        
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.h6" Class="mb-3">Sentiment Info</MudText>
                
                <MudCard Elevation="2" Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <SentimentIcon Sentiment="@_sentiment.Sentiment"
                                               SentimentSource="@_sentiment.SentimentSource"
                                               Confidence="@_sentiment.Confidence"
                                               MessageId="@_sentiment.MessageId"
                                               SentimentId="@_sentiment.Id"
                                               IsAdminContext="true"
                                               OnSentimentChanged="@ReloadSentiment" />
                                <MudText Typo="Typo.h6">@GetSentimentLabel() Sentiment</MudText>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.body1"><strong>Source:</strong></MudText>
                                @{
                                    var (label, color) = _sentiment.SentimentSource switch
                                    {
                                        0 => ("Model", Color.Info),
                                        1 => ("Player", Color.Secondary),
                                        2 => ("Admin", Color.Primary),
                                        _ => ("Unknown", Color.Default)
                                    };
                                }
                                <MudChip T="string" Color="@color" Size="Size.Small">@label</MudChip>
                            </MudStack>

                            @if (_sentiment.Confidence.HasValue)
                            {
                                <MudText Typo="Typo.body1">
                                    <strong>Confidence:</strong> @((_sentiment.Confidence.Value * 100).ToString("F0"))%
                                </MudText>
                            }
                        </MudStack>
                        
                        <MudDivider Class="my-3"/>
                        
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Class="text-muted">
                                <strong>Created:</strong> @_sentiment.CreatedAt.ToLocalTime().ToString("g")
                            </MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">
                                <strong>Modified:</strong> @_sentiment.UpdatedAt.ToLocalTime().ToString("g")
                            </MudText>
                            
                            @if (!string.IsNullOrEmpty(_sentiment.GamePlayerName))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Player:</strong> @_sentiment.GamePlayerName
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.GameScenarioName))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Scenario:</strong> @_sentiment.GameScenarioName
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.GameRulesetId))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Ruleset:</strong> @_sentiment.GameRulesetId
                                </MudText>
                            }
                            @if (!string.IsNullOrEmpty(_sentiment.AgentVersion))
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    <strong>Agent Version:</strong>
                                    @if (!string.IsNullOrEmpty(_sentiment.AgentId))
                                    {
                                        <MudLink Href="@($"/agents/{_sentiment.AgentId}/instruction-versions")" Typo="Typo.caption">
                                            @_sentiment.AgentVersion
                                        </MudLink>
                                    }
                                    else
                                    {
                                        @_sentiment.AgentVersion
                                    }
                                </MudText>
                            }
                        </MudStack>

                        @if (_sentiment.HasFeedback)
                        {
                            <MudDivider Class="my-3"/>
                            <MudText Typo="Typo.subtitle2" Class="mb-2">AI Response Feedback</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                @if (_sentiment.FeedbackIsPositive == true)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">Positive</MudText>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">Negative</MudText>
                                }
                            </MudStack>
                            @if (!string.IsNullOrEmpty(_sentiment.FeedbackComment))
                            {
                                <MudText Typo="Typo.body2" Class="mt-2">@_sentiment.FeedbackComment</MudText>
                            }
                        }

                        @if (_sentiment.ToolNames != null && _sentiment.ToolNames.Any())
                        {
                            <MudDivider Class="my-3"/>
                            <MudText Typo="Typo.subtitle2" Class="mb-1">Tools Used in Response:</MudText>
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var tool in _sentiment.ToolNames)
                                {
                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined">@tool</MudChip>
                                }
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
            
            <MudItem xs="12" md="8">
                 <MudText Typo="Typo.h6" Class="mb-3">Conversation Context</MudText>
                 <MudPaper Elevation="2" Class="pa-4" Style="max-height: 80vh; overflow-y: auto;">
                     <ReadOnlyConversation MessageId="@_sentiment.MessageId" ContextCount="5" />
                 </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private SentimentFullDetailsResponse? _sentiment;
    private bool _loading = true;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Admin", href: "/admin"),
            new BreadcrumbItem("Sentiments", href: "/admin/sentiments"),
            new BreadcrumbItem($"Sentiment {Id}", href: null, disabled: true)
        };

        await LoadSentimentAsync();
    }

    private async Task LoadSentimentAsync()
    {
        try 
        {
            var client = HttpClientFactory.CreateClient("Api");
            _sentiment = await client.GetFromJsonAsync<SentimentFullDetailsResponse>($"/admin/sentiments/{Id}");
        }
        catch (Exception ex) 
        {
            Snackbar.Add($"Error loading sentiment: {ex.Message}", Severity.Error);
        }
        finally 
        {
            _loading = false;
        }
    }

    private async Task ReloadSentiment()
    {
        _loading = true;
        await LoadSentimentAsync();
        StateHasChanged();
    }

    private string GetSentimentLabel() => _sentiment?.Sentiment switch
    {
        > 0 => "Positive",
        < 0 => "Negative",
        _ => "Neutral"
    };
}
