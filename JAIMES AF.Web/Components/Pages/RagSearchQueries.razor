@page "/admin/rag-collections/{IndexName}/queries"
@using MattEland.Jaimes.ServiceDefinitions.Responses
@using MattEland.Jaimes.Web.Components.Shared
@rendermode InteractiveServer

<PageTitle>@(_statistics?.CollectionDisplayName ?? "RAG Search Queries")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">

	<CompactHeroSection Title="@(_statistics?.CollectionDisplayName ?? "Search Queries")"
	                    Icon="@Icons.Material.Filled.Search"
	                    Theme="CompactHeroSection.HeroTheme.Info"
	                    ItemCount="@_statistics?.TotalCount"
	                    ItemName="query"
	                    Subtitle="executed"
	                    SubtitleNoItems="No queries yet" />

	<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
		<MudBreadcrumbs Items="_breadcrumbs" Separator=">"></MudBreadcrumbs>
	</MudStack>

	@if (_statistics != null)
	{
		<MudGrid Spacing="3" Class="mb-4">
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.Search"
				            Value="@_statistics.TotalCount.ToString("N0")"
				            Label="Total Queries"
				            ColorVariant="MetricCard.MetricColorVariant.Info"
				            Tooltip="Total search queries executed against this collection" />
			</MudItem>
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.TrendingUp"
				            Value="@GetAverageResultCount()"
				            Label="Avg Results"
				            ColorVariant="MetricCard.MetricColorVariant.Primary"
				            Tooltip="Average number of results returned per query" />
			</MudItem>
			<MudItem xs="12" sm="4">
				<MetricCard Icon="@Icons.Material.Filled.ThumbUp"
				            Value="@GetHighRelevancyPercentage()"
				            Label="High Relevancy"
				            ColorVariant="MetricCard.MetricColorVariant.Success"
				            Tooltip="Percentage of results with â‰¥80% relevancy" />
			</MudItem>
		</MudGrid>
	}

	@if (!string.IsNullOrEmpty(_errorMessage))
	{
		<MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
	}

	@if (_isLoading)
	{
		<MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4"/>
	}

	@if (_statistics != null)
	{
		@if (!string.IsNullOrWhiteSpace(DocumentName))
		{
			<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
				<MudChip T="string" Color="Color.Primary" OnClose="ClearDocumentFilter" Icon="@Icons.Material.Filled.FilterAlt">
					Filtering by: @DocumentName
				</MudChip>
			</MudStack>
		}

		@if (_statistics.Queries.Length == 0)
		{
			<div class="glass-card pa-6" style="text-align: center;">
				<MudStack AlignItems="AlignItems.Center" Spacing="3">
					<MudIcon Icon="@Icons.Material.Filled.Search" Color="Color.Info"
					         Style="font-size: 4rem; opacity: 0.5;"/>
					<MudText Typo="Typo.h6">No search queries yet</MudText>
					<MudText Class="text-muted mb-4">
						Queries will appear here after users search against these documents.
					</MudText>
				</MudStack>
			</div>
		}
		else
		{
			<MudDataGrid T="RagSearchQueryInfo" Items="@_statistics.Queries" Dense="true" Striped="true" Hover="true"
			             RowsPerPage="@_statistics.PageSize">
					<Columns>
						<TemplateColumn Title="Query">
							<CellTemplate>
								<MudText Typo="Typo.body2" Style="max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
									@context.Item.Query
								</MudText>
							</CellTemplate>
						</TemplateColumn>
						<PropertyColumn Property="x => x.CreatedAt" Title="Date" Format="g"/>
						<TemplateColumn Title="Results">
							<CellTemplate>
								<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
									<MudText Typo="Typo.body2">@context.Item.ResultCount</MudText>
									@if (!string.IsNullOrWhiteSpace(DocumentName) && context.Item.Results.Any(r => string.Equals(r.DocumentName, DocumentName, StringComparison.OrdinalIgnoreCase)))
									{
										<MudTooltip Text="@($"Contains results from {DocumentName}")">
											<MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Small" Color="Color.Primary"/>
										</MudTooltip>
									}
								</MudStack>
							</CellTemplate>
						</TemplateColumn>
						<TemplateColumn Title="Ruleset">
							<CellTemplate>
								@if (!string.IsNullOrEmpty(context.Item.RulesetId))
								{
									<MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Item.RulesetId</MudChip>
								}
								else
								{
									<MudText Typo="Typo.caption" Color="Color.Secondary">All</MudText>
								}
							</CellTemplate>
						</TemplateColumn>
						<TemplateColumn Title="">
							<CellTemplate>
								<MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
								           OnClick="@(() => ToggleExpanded(context.Item.Id))"
								           StartIcon="@(IsExpanded(context.Item.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)">
									@(IsExpanded(context.Item.Id) ? "Hide Results" : "Show Results")
								</MudButton>
							</CellTemplate>
						</TemplateColumn>
					</Columns>
					<ChildRowContent>
						@if (IsExpanded(context.Item.Id))
						{
							<MudTr>
								<td colspan="5">
									<MudPaper Class="pa-4 ma-2" Elevation="0" Style="background: var(--mud-palette-background-grey);">
										<MudText Typo="Typo.subtitle2" Class="mb-2">Query Details</MudText>
										<MudText Typo="Typo.body2" Class="mb-3" Style="font-style: italic;">
											"@context.Item.Query"
										</MudText>
										@if (context.Item.Results.Length > 0)
										{
											<MudText Typo="Typo.subtitle2" Class="mb-2">Results (@context.Item.Results.Length)</MudText>
											<MudSimpleTable Dense="true" Striped="true" Bordered="true">
												<thead>
												<tr>
													<th>Document</th>
													<th>Chunk ID</th>
													<th>Relevancy</th>
												</tr>
												</thead>
												<tbody>
												@foreach (var result in context.Item.Results)
												{
													<tr style="@(string.Equals(result.DocumentName, DocumentName, StringComparison.OrdinalIgnoreCase) ? "background-color: var(--mud-palette-primary-hover); font-weight: bold;" : "")">
														<td>
															@result.DocumentName
														</td>
														<td>
															<MudLink Href="@GetChunkDetailsLink(result.ChunkId)">
																<code>@result.ChunkId</code>
															</MudLink>
														</td>
														<td>
															<MudChip T="string"
															         Color="@(result.Relevancy >= 0.8 ? Color.Success : result.Relevancy >= 0.5 ? Color.Warning : Color.Error)"
															         Size="Size.Small">
																@result.Relevancy.ToString("P1")
															</MudChip>
														</td>
													</tr>
												}
												</tbody>
											</MudSimpleTable>
										}
										else
										{
											<MudText Typo="Typo.body2" Color="Color.Secondary">No results stored for this query.</MudText>
										}
									</MudPaper>
								</td>
							</MudTr>
						}
					</ChildRowContent>
				</MudDataGrid>

			@if (_statistics.TotalCount > _statistics.PageSize)
			{
				<MudStack Row="true" Justify="Justify.Center" Class="mt-4">
					<MudPagination Count="@TotalPages" Selected="@_currentPage" SelectedChanged="OnPageChanged" Color="Color.Primary"/>
				</MudStack>
			}
		}
	}
</MudContainer>
