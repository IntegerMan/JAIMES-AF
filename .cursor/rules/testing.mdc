---
alwaysApply: true
---

# Testing Guidelines

## Always Build and Test After Code Changes

When making code changes that affect services, repositories, or endpoints:

1. **Build the entire solution** to check for compilation errors:
   ```bash
   dotnet build
   ```
   - **CRITICAL**: Always build after modifying code to ensure it compiles successfully
   - Fix any build errors before proceeding
   - If using Central Package Management, ensure all PackageReference items have corresponding PackageVersion items in Directory.Packages.props

2. **Build the test project** to check for compilation errors:
   ```bash
   dotnet build "JAIMES AF.Tests/JAIMES AF.Tests.csproj"
   ```

3. **Run the relevant tests** to ensure they pass:
   ```bash
   dotnet run --project "JAIMES AF.Tests/JAIMES AF.Tests.csproj" -- --filter "FullyQualifiedName~TestClassName"
   ```

4. **Run all tests** before completing a task:
   ```bash
   dotnet run --project "JAIMES AF.Tests/JAIMES AF.Tests.csproj"
   ```

## Test Structure

- Tests are organized by layer: `Endpoints/`, `Repositories/`, `Services/`
- Use in-memory databases for repository tests
- Create mock implementations for service dependencies (e.g., `IChatService`, `IChatHistoryService`)
- Update test assertions when behavior changes (e.g., when "Hello World" was replaced with AI-generated initial messages)

## Assertions with Shouldly

- **Always use Shouldly** for assertions - never use `Assert.*` methods
- Import `using Shouldly;` at the top of test files
- Common assertions:
  - `result.ShouldNotBeNull()` / `result.ShouldBeNull()`
  - `result.ShouldBe(expected)` / `result.ShouldNotBe(expected)`
  - `result.ShouldContain(item)` / `result.ShouldNotContain(item)`
  - `result.ShouldHaveSingleItem()` - for collections with exactly one item
  - `result.Length.ShouldBe(count)` - for collection counts
  - `await Should.ThrowAsync<T>(action)` - for exception testing
  - `exception.Message.ShouldContain(text)` - for exception message validation

## Common Issues

- **Missing dependencies**: When adding constructor parameters to services, update test setup to provide mocks
- **Changed behavior**: When refactoring service methods, update test expectations to match new behavior
- **Compilation errors**: Always fix compilation errors before considering a task complete
- **Central Package Management**: When adding new PackageReference items, ensure corresponding PackageVersion items exist in Directory.Packages.props
- **Build failures**: Always run `dotnet build` after code modifications to verify the solution compiles successfully
